<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <script type="application/ld+json">

{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "AccessViolation in ObjectNative::IsLockHeld (part 2 of 2)",
  
  "image": "https://minidump.net/images/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c-1.webp",
  
  "datePublished": "2020-11-25T00:00:00Z",
  "dateModified": "2020-11-25T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Kevin Gosse",
    
    "image": "https://minidump.net/images/profile.png"
    
  },
  "mainEntityOfPage": { 
    "@type": "WebPage",
    "@id": "https:\/\/minidump.net\/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c\/" 
  },
  "publisher": {
    "@type": "Organization",
    "name": "minidump.net",
    
    "logo": {
      "@type": "ImageObject",
      "url": "https://minidump.net/images/profile.png"
    }
    
  },
  "description": "This is the second part of an investigation where I tried to understand why an application was randomly crashing with an AccessViolationException. This part starts when, as I ran out of easy things to try, I decided to map the assembly code of the IsLockHeld method to the original C++ code to understand exactly where it crashed.",
  "keywords": []
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.121.1 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="Kevin Gosse">
<meta name="keywords" content="">
<meta name="description" content="This is the second part of an investigation where I tried to understand why an application was randomly crashing with an AccessViolationException. This part starts when, as I ran out of easy things to try, I decided to map the assembly code of the IsLockHeld method to the original C&#43;&#43; code to understand exactly where it crashed.">


<meta property="og:description" content="This is the second part of an investigation where I tried to understand why an application was randomly crashing with an AccessViolationException. This part starts when, as I ran out of easy things to try, I decided to map the assembly code of the IsLockHeld method to the original C&#43;&#43; code to understand exactly where it crashed.">
<meta property="og:type" content="article">
<meta property="og:title" content="AccessViolation in ObjectNative::IsLockHeld (part 2 of 2)">
<meta name="twitter:title" content="AccessViolation in ObjectNative::IsLockHeld (part 2 of 2)">
<meta property="og:url" content="https://minidump.net/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c/">
<meta property="twitter:url" content="https://minidump.net/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c/">
<meta property="og:site_name" content="minidump.net">
<meta property="og:description" content="This is the second part of an investigation where I tried to understand why an application was randomly crashing with an AccessViolationException. This part starts when, as I ran out of easy things to try, I decided to map the assembly code of the IsLockHeld method to the original C&#43;&#43; code to understand exactly where it crashed.">
<meta name="twitter:description" content="This is the second part of an investigation where I tried to understand why an application was randomly crashing with an AccessViolationException. This part starts when, as I ran out of easy things to try, I decided to map the assembly code of the IsLockHeld method to the original C&#43;&#43; code to understand exactly where it crashed.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2020-11-25T00:00:00">
  
  
    <meta property="article:modified_time" content="2020-11-25T00:00:00">
  
  
  
  
    
      <meta property="article:tag" content="dotnet">
    
      <meta property="article:tag" content="csharp">
    
      <meta property="article:tag" content="debugging">
    
      <meta property="article:tag" content="windbg">
    
      <meta property="article:tag" content="cpp">
    
      <meta property="article:tag" content="assembly">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@kookiz">


  <meta name="twitter:creator" content="@kookiz">






  <meta property="og:image" content="https://minidump.net/images/profile.png">
  <meta property="twitter:image" content="https://minidump.net/images/profile.png">





  <meta property="og:image" content="https://minidump.net/images/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c-1.webp">
  <meta property="twitter:image" content="https://minidump.net/images/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c-1.webp">


    <title>AccessViolation in ObjectNative::IsLockHeld (part 2 of 2)</title>

    <link rel="icon" href="/favicon.png">
    

    

    <link rel="canonical" href="https://minidump.net/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://minidump.net/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/" aria-label="Go to homepage">minidump.net</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about" aria-label="Read more about the author">
          <img class="sidebar-profile-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Kevin Gosse</h4>
        
          <h5 class="sidebar-profile-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/kookiz" target="_blank" rel="noopener" title="Twitter">
    
      <i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/kevingosse" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.buymeacoffee.com/kevingosse" target="_blank" rel="noopener" title="Buy me a coffee">
    
      <i class="sidebar-button-icon fas fa-lg fa-coffee" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Buy me a coffee</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      AccessViolation in ObjectNative::IsLockHeld (part 2 of 2)
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2020-11-25T00:00:00Z">
        
  
  
  
  
    November 25 2020
  

      </time>
    
    
  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>This is the second part of an investigation where I tried to understand why an application was randomly crashing with an <code>AccessViolationException</code>.</p>
<p>If you haven&rsquo;t read it, <a href="/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a">you can find part 1 of the investigation here</a>.</p>
<p>As a reminder, here is what we uncovered so far:</p>
<ul>
<li>
<p>The server runs <a href="https://github.com/OrchardCMS/Orchard/">Orchard</a>, with the Datadog .NET tracer, and crashes about once or twice per day</p>
</li>
<li>
<p>The crash dump indicated an access violation in method <code>clr!ObjectNative::IsLockHeld</code>, itself called by <code>Orchard.OutputCache.Filters.OutputCacheFilter.Dispose</code></p>
</li>
<li>
<p>In WinDbg, the <code>!syncblk</code> command failed with an error</p>
</li>
</ul>
<p>Part 2 starts when, as I ran out of easy things to try, I decided to map the assembly code of the <code>IsLockHeld</code> method to the original C++ code to understand exactly where it crashed. But first I wanted to confirm with a new memory dump that the symptoms were identical, and fortunately a new crash occurred by the time I reached that point.</p>
<h1 id="into-the-second-memory-dump">Into the second memory dump</h1>
<p>At first glance, the new crash was identical to the first one: an access violation in <code>clr!ObjectNative::IsLockHeld</code>, trying to dereference the address <code>0x2B</code>. Just like before, the method was called from <code>OutputCacheFilter.Dipose</code>. However, this time the <code>!syncblk</code> command ran without any error:</p>
<pre tabindex="0"><code>0:056&gt; !syncblk
Index SyncBlock MonitorHeld Recursion Owning Thread Info  SyncBlock Owner
  217 0000023a1af311b8            1         1 0000023a1be46590 1070 101   00000236c7adf9d0 System.String
  788 0000023a1b09c438            1         1 0000000000000000     none    00000235c7d279b0 System.String
  989 0000023a1b9c0ed8            1         1 0000023a1c717030 1058  54   00000235c7d27858 System.String
</code></pre><p>One of the locks had no associated thread. After closer inspection of the <code>OutputCacheFilter</code> code, it became apparent that the lock <a href="https://github.com/OrchardCMS/Orchard/blob/dev/src/Orchard.Web/Modules/Orchard.OutputCache/Filters/OutputCacheFilter.cs#L140">was acquired in the <code>OnActionExecuting</code> event</a> of the ASP.NET MVC framework, and <a href="https://github.com/OrchardCMS/Orchard/blob/dev/src/Orchard.Web/Modules/Orchard.OutputCache/Filters/OutputCacheFilter.cs#L272">released in the <code>OnResultExecuted</code> event</a>. This could only work if both events were called from the same thread, and ASP.NET MVC does not make any guarantee about that. I concluded that we could end up with orphaned locks, and that would explain why a lock had no associated thread.</p>
<p>Still, that was bad but it didn&rsquo;t explain the crash. So I decided to focus on the assembly code to understand where the wrong value came from.</p>
<p>The disassembly code, from the beginning of the method to the point where it failed, was:</p>
<pre tabindex="0"><code> clr!ObjectNative::IsLockHeld:
00007ffb`62cb0a40 48895c2408     mov     qword ptr [rsp+8], rbx
00007ffb`62cb0a45 57             push    rdi
00007ffb`62cb0a46 4883ec20       sub     rsp, 20h
00007ffb`62cb0a4a 8b59fc         mov     ebx, dword ptr [rcx-4]
00007ffb`62cb0a4d bf01000000     mov     edi, 1
00007ffb`62cb0a52 0fbae31b       bt      ebx, 1Bh
00007ffb`62cb0a56 7340           jae     clr!ObjectNative::IsLockHeld+0x58 (00007ffb`62cb0a98)
00007ffb`62cb0a58 0fbae31a       bt      ebx, 1Ah
00007ffb`62cb0a5c 7306           jae     clr!ObjectNative::IsLockHeld+0x24 (00007ffb`62cb0a64)
00007ffb`62cb0a5e 33db           xor     ebx, ebx
00007ffb`62cb0a60 33c0           xor     eax, eax
00007ffb`62cb0a62 eb42           jmp     clr!ObjectNative::IsLockHeld+0x66 (00007ffb`62cb0aa6)
00007ffb`62cb0a64 488b055d402400 mov     rax, qword ptr [clr!g_pSyncTable (00007ffb`62ef4ac8)]
00007ffb`62cb0a6b 8bcb           mov     ecx, ebx
00007ffb`62cb0a6d 81e1ffffff03   and     ecx, 3FFFFFFh
00007ffb`62cb0a73 41b800000080   mov     r8d, 80000000h
00007ffb`62cb0a79 4803c9         add     rcx, rcx
00007ffb`62cb0a7c 488b14c8       mov     rdx, qword ptr [rax+rcx*8]
00007ffb`62cb0a80 44094214       or      dword ptr [rdx+14h], r8d
00007ffb`62cb0a84 488b4a08       mov     rcx, qword ptr [rdx+8]
00007ffb`62cb0a88 4885c9         test    rcx, rcx
00007ffb`62cb0a8b 74d1           je      clr!ObjectNative::IsLockHeld+0x1e (00007ffb`62cb0a5e)
00007ffb`62cb0a8d 8b592c         mov     ebx, dword ptr [rcx+2Ch] ds:00000000`0000002b=????????
</code></pre><p>The source code of <code>IsLockHeld</code> is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>FCIMPL1(FC_BOOL_RET, ObjectNative<span style="color:#f92672">::</span>IsLockHeld, Object<span style="color:#f92672">*</span> pThisUNSAFE)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    FCALL_CONTRACT;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    BOOL retVal;
</span></span><span style="display:flex;"><span>    DWORD owningThreadId;
</span></span><span style="display:flex;"><span>    DWORD acquisitionCount;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// If the lock is held, check if it&#39;s held by the current thread.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    retVal <span style="color:#f92672">=</span> pThisUNSAFE<span style="color:#f92672">-&gt;</span>GetThreadOwningMonitorLock(<span style="color:#f92672">&amp;</span>owningThreadId, <span style="color:#f92672">&amp;</span>acquisitionCount);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (retVal)
</span></span><span style="display:flex;"><span>        retVal <span style="color:#f92672">=</span> GetThread()<span style="color:#f92672">-&gt;</span>GetThreadId() <span style="color:#f92672">==</span> owningThreadId;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    FC_RETURN_BOOL(retVal);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>How to proceed? As I mentioned <a href="/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4">in a previous article</a>, the key is to find some kind of &ldquo;anchor&rdquo;, some easily-recognizable part in the assembly and work your way from there. The <code>mov rax, qword ptr [clr!g_pSyncTable (00007ffb`62ef4ac8)]</code> instruction was interesting, because it refers to <code>g_pSyncTable</code>. Unfortunately there was no such symbol in the <code>IsLockHeld</code> method, which probably meant that a method was inlined. So I needed to dig further into the source code. The first method called was <code>GetThreadOwningMonitorLock</code>, what did it look like?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>BOOL ObjHeader<span style="color:#f92672">::</span>GetThreadOwningMonitorLock(DWORD <span style="color:#f92672">*</span>pThreadId, DWORD <span style="color:#f92672">*</span>pAcquisitionCount)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    DWORD bits <span style="color:#f92672">=</span> GetBits();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (bits <span style="color:#f92672">&amp;</span> BIT_SBLK_IS_HASH_OR_SYNCBLKINDEX)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (bits <span style="color:#f92672">&amp;</span> BIT_SBLK_IS_HASHCODE)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// This thread does not own the lock.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">*</span>pThreadId <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*</span>pAcquisitionCount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> FALSE;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// We have a syncblk
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            DWORD index <span style="color:#f92672">=</span> bits <span style="color:#f92672">&amp;</span> MASK_SYNCBLOCKINDEX;
</span></span><span style="display:flex;"><span>            SyncBlock<span style="color:#f92672">*</span> psb <span style="color:#f92672">=</span> g_pSyncTable[(<span style="color:#66d9ef">int</span>)index].m_SyncBlock;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            _ASSERTE(psb<span style="color:#f92672">-&gt;</span>GetMonitor() <span style="color:#f92672">!=</span> NULL);
</span></span><span style="display:flex;"><span>            Thread<span style="color:#f92672">*</span> pThread <span style="color:#f92672">=</span> psb<span style="color:#f92672">-&gt;</span>GetMonitor()<span style="color:#f92672">-&gt;</span>m_HoldingThread;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(pThread <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">*</span>pThreadId <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">*</span>pAcquisitionCount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> FALSE;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">*</span>pThreadId <span style="color:#f92672">=</span> pThread<span style="color:#f92672">-&gt;</span>GetThreadId();
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">*</span>pAcquisitionCount <span style="color:#f92672">=</span> psb<span style="color:#f92672">-&gt;</span>GetMonitor()<span style="color:#f92672">-&gt;</span>m_Recursion;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> TRUE;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// We have a thinlock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I removed some bits for brevity</p>
<p>That looked really good. The method did indeed use <code>g_pSyncTable</code>. Also, it started with two bit test operations, <code>bits &amp; BIT_SBLK_IS_HASH_OR_SYNCBLKINDEX</code> and <code>bits &amp; BIT_SBLK_IS_HASHCODE</code>, which mapped nicely to the <code>bt ebx, 1Bh</code> and <code>bt ebx, 1Ah</code> instructions. Just to be sure, I confirmed that the value of <code>BIT_SBLK_IS_HASH_OR_SYNCBLKINDEX</code> was <code>0x08000000</code>, so to test that flag you would need to check the 28th bit (<code>bt ebx, 1Bh</code>). Likewise, <code>BIT_SBLK_IS_HASHCODE</code> was <code>0x04000000</code>, so the 27th bit (<code>bt ebx, 1Ah</code>).</p>
<p>What else could I use to map to the original source code? The <code>mov rax, qword ptr [clr!g_pSyncTable (00007ffb`62ef4ac8)]</code> instruction was dereferencing <code>g_pSyncTable</code> into <code>rax</code>. Then <code>mov rdx, qword ptr [rax+rcx*8]</code> read the table at index <code>rcx*8</code>. This looked a lot like <code>g_pSyncTable[(int)index]</code>. Further down, <code>test rcx, rcx</code> looked like a null check, so probably <code>if(pThread == NULL)</code>.</p>
<p>To confirm it, let&rsquo;s look up a bit. The line just before the null check was:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>Thread<span style="color:#f92672">*</span> pThread <span style="color:#f92672">=</span> psb<span style="color:#f92672">-&gt;</span>GetMonitor()<span style="color:#f92672">-&gt;</span>m_HoldingThread;
</span></span></code></pre></div><p><code>GetMonitor()</code> returns <code>m_Monitor</code>, which is the first field of the syncblock (therefore located at the base address of the syncblock). <code>m_Monitor</code> is an <code>AwareLock</code> with the following structure:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>    Volatile<span style="color:#f92672">&lt;</span>LONG<span style="color:#f92672">&gt;</span>  m_MonitorHeld;
</span></span><span style="display:flex;"><span>    ULONG           m_Recursion;
</span></span><span style="display:flex;"><span>    PTR_Thread      m_HoldingThread;
</span></span></code></pre></div><p>Both <code>LONG</code> and <code>ULONG</code> are 4 bytes wide, so <code>m_holdingThread</code> would be at offset 8, which was consistent with the <code>mov rcx, qword ptr [rdx+8]</code> instruction. So at this point it seemed reasonable to assume that the code was failing at the <code>*pThreadId = pThread-&gt;GetThreadId();</code> instruction. <code>GetThreadId</code> returned the <code>m_ThreadId</code> field of the thread. Given that the crash occurred when dereferencing <code>mov ebx, dword ptr [rcx+2Ch]</code>, I could have the definite confirmation if <code>m_ThreadId</code> was located at offset <code>2C</code> of the <code>Thread</code> class. The layout of the <code>Thread</code> class is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>    Volatile<span style="color:#f92672">&lt;</span>ThreadState<span style="color:#f92672">&gt;</span> m_State;   <span style="color:#75715e">// Bits for the state of the thread
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Volatile<span style="color:#f92672">&lt;</span>ULONG<span style="color:#f92672">&gt;</span>       m_fPreemptiveGCDisabled;
</span></span><span style="display:flex;"><span>    PTR_Frame             m_pFrame;  <span style="color:#75715e">// The Current Frame
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    PTR_Frame             m_pUnloadBoundaryFrame;
</span></span><span style="display:flex;"><span>    PTR_AppDomain         m_pDomain;
</span></span><span style="display:flex;"><span>    DWORD                 m_dwLockCount;
</span></span><span style="display:flex;"><span>    DWORD                 m_ThreadId;
</span></span></code></pre></div><p>Let&rsquo;s count:</p>
<ul>
<li>
<p><code>ThreadState</code> is an enum (4 bytes)</p>
</li>
<li>
<p><code>ULONG</code> : 4 bytes</p>
</li>
<li>
<p><code>PTR_*</code> objects are pointer to an object, so 8 bytes each (64 bits process)</p>
</li>
<li>
<p><code>DWORD</code> : 4 bytes</p>
</li>
</ul>
<p>4 + 4 + (3 * 8) + 4 = 36</p>
<p>Offset 2C would be 44 in decimal, so we&rsquo;re missing 8 bytes! Did I miss something?</p>
<p>Actually, yes: the signature of the <code>Thread</code> class.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Thread</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> IUnknown
</span></span></code></pre></div><p><code>Thread</code> inherits from <code>IUnknown</code>, which declares virtual methods. It means that <code>Thread</code> has a vtable, and the pointer of the vtable is stored at the beginning of the objects. That&rsquo;s the missing 8 bytes!</p>
<p>Now if we take the vtable into account: 8 + 4 + 4 + (3 * 8) + 4 = 44 = 2C</p>
<p>So I could conclude that the crash occurred at the <code>*pThreadId = pThread-&gt;GetThreadId();</code> line, which meant that for some reason <code>pThread</code> was <code>0xffffffff</code>. Could I confirm that from the memory dump?</p>
<p>Following my previous analysis, <code>mov rdx, qword ptr [rax+rcx*8]</code> was reading the syncblock from the synctable and storing the address into <code>rdx</code>. Since the register was untouched past this point, I could expect that the value would still be there.</p>
<pre tabindex="0"><code>0:102&gt; r rdx
rdx=0000020c6dd4ec38
</code></pre><p>Inspecting the register gave me the value <code>0000020c6dd4ec38</code>. I then dumped the value of all syncblocks and…</p>
<pre tabindex="0"><code>0:102&gt; !syncblk -all
Index SyncBlock MonitorHeld Recursion Owning Thread Info  SyncBlock Owner
    1 0000000000000000            0         0 0000000000000000     none           0 Free
    2 0000020c67f1c728            0         0 0000000000000000     none    000002091a191da0 System.__ComObject
 [...]
 1069 0000020c6dd4ec38            1         1 0000000000000000     none    000002081ad5e178 System.String
 [...]
 1279 0000020c6e81de08            0         0 0000000000000000     none    000002091da1e320 System.Data.SqlClient.SqlCommand
 1280 0000020c67f1cd68            0         0 0000000000000000     none    000002081d534ed8 System.Data.SqlClient.SqlCommand
</code></pre><p>Score! The syncblock at index 1069 had the same address, <code>0000020c6dd4ec38</code>. As mentioned earlier, the first field of a syncblock is an <code>AwareLock</code> with the following structure:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>    Volatile<span style="color:#f92672">&lt;</span>LONG<span style="color:#f92672">&gt;</span>  m_MonitorHeld;
</span></span><span style="display:flex;"><span>    ULONG           m_Recursion;
</span></span><span style="display:flex;"><span>    PTR_Thread      m_HoldingThread;
</span></span></code></pre></div><p>So if we dump the memory at the address <code>0000020c6dd4ec38</code>, we can map the values accordingly:</p>
<pre tabindex="0"><code>0:102&gt; dd 0000020c6dd4ec38
0000020c`6dd4ec38  00000001 00000001 ffffffff ffffffff
</code></pre><ul>
<li>
<p><code>m_MonitorHeld</code> = 1</p>
</li>
<li>
<p><code>m_Recursion</code> = 1</p>
</li>
<li>
<p><code>m_HoldingThread</code> = <code>ffffffff`ffffffff</code></p>
</li>
</ul>
<p>At this point there was no doubt left that the thread address associated to the syncblock was <code>ffffffff`ffffffff</code>, and this caused the crash. The next step was finding how this value ended up there.</p>
<p><code>ffffffff`ffffffff</code> is a very remarkable value, equal to <code>-1</code>. So I scanned through the CLR source code to find where the <code>-1</code> value was assigned to the <code>m_HoldingThread</code> field of the syncblock. Luckily there was only one place, in <code>ObjHeader::GetSyncBlock()</code>. This piece of code gets executed when a thin-lock is promoted to a syncblock (you can refer to part 1 of the article for a refresher on thin locks) :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>Thread <span style="color:#f92672">*</span>pThread <span style="color:#f92672">=</span> g_pThinLockThreadIdDispenser<span style="color:#f92672">-&gt;</span>IdToThreadWithValidation(lockThreadId);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (pThread <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The lock is orphaned.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pThread <span style="color:#f92672">=</span> (Thread<span style="color:#f92672">*</span>) <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>syncBlock<span style="color:#f92672">-&gt;</span>InitState();
</span></span><span style="display:flex;"><span>syncBlock<span style="color:#f92672">-&gt;</span>SetAwareLock(pThread, recursionLevel <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span></code></pre></div><p>The <code>The lock is orphaned</code> comment was very encouraging, as I already knew that Orchard was orphaning locks. But not all orphaned lock cause a crash, so I was still missing a piece of the puzzle.</p>
<p>The thread address came from <code>g_pThinLockThreadIdDispenser-&gt;IdToThreadWithValidation</code>. Upon further inspection, it looked like a table to convert some kind of thread ids to addresses. What kind of ids?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>Thread <span style="color:#f92672">*</span><span style="color:#a6e22e">IdToThreadWithValidation</span>(DWORD id)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    WRAPPER_NO_CONTRACT;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    CrstHolder ch(<span style="color:#f92672">&amp;</span>m_Crst);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Thread <span style="color:#f92672">*</span>result <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (id <span style="color:#f92672">&lt;=</span> m_highestId)
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> m_idToThread[id];
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// m_idToThread may have Thread*, or the next free slot
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> ((size_t)result <span style="color:#f92672">&lt;=</span> m_idToThreadCapacity)
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    _ASSERTE(result <span style="color:#f92672">==</span> NULL <span style="color:#f92672">||</span> ((size_t)result <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> ((Thread<span style="color:#f92672">*</span>)result)<span style="color:#f92672">-&gt;</span>GetThreadId() <span style="color:#f92672">==</span> id);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If you remember from part 1, thin locks store the information in the object header. Headers are 32 bits wide, and contain only 26 bits of usable space for the thin lock. Monitors need to keep track of the owning thread, for instance to allow recursive access. How to store that information in 26 bits? That&rsquo;s not enough for the thread address, so instead the runtime stores the managed thread id and maintains a table to map that id back to the address of the thread object. That table is <code>g_pThinLockThreadIdDispenser</code>.</p>
<p>Back to our <code>ObjHeader::GetSyncBlock()</code> method, it meant that <code>-1</code> was used as a fallback value for the thread address when the thread id couldn&rsquo;t be found in the table. So the last missing bit was to figure out when ids are removed from that table.</p>
<p>After more time spent reading the CLR code, I concluded that the table was cleaned by the finalizer of the thread object. At that point, I had all the pieces of the puzzle and could write a small repro:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> locks = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>[<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; locks.Length; i++)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        locks[i] = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; <span style="color:#ae81ff">4</span>; i++)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> thread = <span style="color:#66d9ef">new</span> Thread(state =&gt;
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Monitor.Enter(locks[(<span style="color:#66d9ef">int</span>)state]);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        thread.Start(i);
</span></span><span style="display:flex;"><span>        thread.Join();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Force the thread to be collected, orphaning the lock</span>
</span></span><span style="display:flex;"><span>    GC.Collect(<span style="color:#ae81ff">2</span>, GCCollectionMode.Forced, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>    GC.WaitForPendingFinalizers();
</span></span><span style="display:flex;"><span>    GC.Collect(<span style="color:#ae81ff">2</span>, GCCollectionMode.Forced, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Promote to a syncblock</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; locks.Length; i++)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _ = locks[i].GetHashCode();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Trigger the crash</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; <span style="color:#ae81ff">4</span>; i++)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> thread = <span style="color:#66d9ef">new</span> Thread(state =&gt;
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            _ = Monitor.IsEntered(locks[(<span style="color:#66d9ef">int</span>)state]);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        thread.Start(i);
</span></span><span style="display:flex;"><span>        thread.Join();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The program starts by creating a bunch of objects, then starts threads to lock on those objects. At that point, a thin lock is used and the thread ids are added to the <code>g_pThinLockThreadIdDispenser</code> table. Then the GC is triggered, which causes the thread finalizers to run, which in turn will remove the thread ids from the table. Line 27, a loop call <code>GetHashCode</code> on the objects, forcing the thin locks to be promoted to syncblocks. While doing so, the runtime will try to fetch the thread addresses from the table, but won&rsquo;t find them since they were removed by the finalizers. Instead, the runtime will store the <code>-1</code> fallback value in the syncblocks. Finally, the loop line 33 starts new threads and make them inspect the state of the lock. This causes the runtime to dereference the thread addresses stored in the syncblocks (that is, <code>-1</code>) and triggers the AccessViolationException.</p>
<h1 id="wrapping-things-up">Wrapping things up</h1>
<p>This is a runtime bug, that has probably been around for a very long time. I&rsquo;ve reported it <a href="https://github.com/dotnet/runtime/issues/44071">on Github</a>, so it may be fixed in time for .NET 6.0. Still, there were a few questions left:</p>
<ol>
<li>
<p>If orphaned locks could trigger a crash, how come the Orchard maintainers never noticed it?</p>
</li>
<li>
<p>At Datadog we have a test server running our instrumentation code, and a control server running without. If that was a runtime bug, why did we detect it on the test server but not on the control server?</p>
</li>
</ol>
<p>The reason for 1/ was simply that we weren&rsquo;t running vanilla Orchard. The locking scheme used by Orchard relies on the assumption that ASP.NET MVC will execute the <code>OnActionExecuting</code> and <code>OnResultExecuted</code> events in the same thread. This is actually true when using synchronous controllers. But to better test our code, we added some asynchronous workload to Orchard, and therefore switched to asynchronous controllers to follow best practices. This broke the assumption.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c-1.webp" title="We were just following best practices :(" data-fancybox="">
  
    <img class="fig-img" src="/images/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c-1.webp"  alt="We were just following best practices :(">
  
    </a>
  
   
    <span class="caption">We were just following best practices :(</span>
  
</div>

<p>For 2/, I must commend the intuition of OzCode&rsquo;s <a href="https://twitter.com/omerraviv">Omer Raviv</a>, who sensed immediately after reading part 1 that something was fishy:</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Really fascinating! The one thing I found missing from this crime novel is - how does your test server work? What type of load does it do? Does it run 24/7? Very particular that it happened just once a day.</p>&mdash; Omer Raviv (@omerraviv) <a href="https://twitter.com/omerraviv/status/1326656693925777419?ref_src=twsrc%5Etfw">November 11, 2020</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Remember that the crash is caused by some error condition that has a probability of happening every time an orphaned lock is promoted. The locks in question are used by Orchard to update its internal cache. Orchard has a finite number of caches, and therefore a finite number of locks. Once all of them are orphaned, the conditions for the crash will never happen again.
Put another way: every time the application restarted, it had some probability of crashing in the following minutes. Past that window, the crash could not happen again because the locks for all the caches would have been orphaned. The test server was redeployed every time a new change was merged in our GitHub repository, that is a few times per day. On the other hand, the control server was almost never restarted. So what caused the test server to crash wasn&rsquo;t the fact that our code was running on it, but simply that it was restarted more often.</p>

              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/dotnet/">dotnet</a>

  <a class="tag tag--primary tag--small" href="/tags/csharp/">csharp</a>

  <a class="tag tag--primary tag--small" href="/tags/debugging/">debugging</a>

  <a class="tag tag--primary tag--small" href="/tags/windbg/">windbg</a>

  <a class="tag tag--primary tag--small" href="/tags/cpp/">cpp</a>

  <a class="tag tag--primary tag--small" href="/tags/assembly/">assembly</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd/" data-tooltip="Debugging a native deadlock in a .NET Linux application" aria-label="NEXT: Debugging a native deadlock in a .NET Linux application">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a/" data-tooltip="AccessViolation in ObjectNative::IsLockHeld (part 1 of 2)" aria-label="PREVIOUS: AccessViolation in ObjectNative::IsLockHeld (part 1 of 2)">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            

<link href="https://fonts.googleapis.com/css?family=Cookie&amp;display=swap" rel="stylesheet">
<div class="bmc-btn-container"><a class="bmc-btn" target="_blank" href="https://buymeacoffee.com/kevingosse">☕<span class="bmc-btn-text">Enjoyed the article? Buy me a coffee</span></a></div>

<style>
    .bmc-btn {
        min-width: 210px;
        color: #000000;
        background-color: #FFFFFF !important;
        height: 60px;
        border-radius: 12px;
        font-size: 28px;
        font-weight: Normal;
        border: none;
        line-height: 27px;
        text-decoration: none !important;
        display: inline-flex !important;
        justify-content: center;
        align-items: center;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
    }

    .bmc-btn:hover, .bmc-btn:active, .bmc-btn:focus {
        text-decoration: none !important;
        cursor: pointer;
    }

    .bmc-btn-text {
        margin-left: 8px;
        display: inline-block;
        line-height: 0;
        width: 100%;
        flex-shrink: 0;
        font-family: [FONT] !important;
    }

    .logo-outline {
        fill: #000000;
    }

    .logo-coffee {
        fill: #ffffff;
    }</style>

  
<div id="utterances">
      <noscript>Please enable JavaScript to view the comments powered by Utterances.</noscript>
    </div>
<script src="https://utteranc.es/client.js"
        repo="kevingosse/kevingosse.github.io"
        issue-term="title"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 Kevin Gosse. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd/" data-tooltip="Debugging a native deadlock in a .NET Linux application" aria-label="NEXT: Debugging a native deadlock in a .NET Linux application">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a/" data-tooltip="AccessViolation in ObjectNative::IsLockHeld (part 1 of 2)" aria-label="PREVIOUS: AccessViolation in ObjectNative::IsLockHeld (part 1 of 2)">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="2">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fminidump.net%2Faccessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c%2F" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https%3A%2F%2Fminidump.net%2Faccessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c%2F" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i><span>Share on Linkedin</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.reddit.com/submit?url=https%3A%2F%2Fminidump.net%2Faccessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c%2F" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i><span>Share on Reddit</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fminidump.net%2Faccessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c%2F" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i><span>Share on Hacker News</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>


    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Kevin Gosse</h4>
    
      <div id="about-card-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</div>
    
    
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://minidump.net/images/code.png');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://minidump.net/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

