<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <script type="application/ld+json">

{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Have some fun with .net core startup hooks",
  
  "image": "https://minidump.net/images/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1-3.png",
  
  "datePublished": "2019-02-01T00:00:00Z",
  "dateModified": "2019-02-01T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Kevin Gosse",
    
    "image": "https://minidump.net/images/profile.png"
    
  },
  "mainEntityOfPage": { 
    "@type": "WebPage",
    "@id": "https:\/\/minidump.net\/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1\/" 
  },
  "publisher": {
    "@type": "Organization",
    "name": "minidump.net",
    
    "logo": {
      "@type": "ImageObject",
      "url": "https://minidump.net/images/profile.png"
    }
    
  },
  "description": "How to abuse .net core startup hooks to make apps behave in crazy ways.",
  "keywords": []
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.121.1 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="Kevin Gosse">
<meta name="keywords" content="">
<meta name="description" content="How to abuse .net core startup hooks to make apps behave in crazy ways.">


<meta property="og:description" content="How to abuse .net core startup hooks to make apps behave in crazy ways.">
<meta property="og:type" content="article">
<meta property="og:title" content="Have some fun with .net core startup hooks">
<meta name="twitter:title" content="Have some fun with .net core startup hooks">
<meta property="og:url" content="https://minidump.net/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1/">
<meta property="twitter:url" content="https://minidump.net/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1/">
<meta property="og:site_name" content="minidump.net">
<meta property="og:description" content="How to abuse .net core startup hooks to make apps behave in crazy ways.">
<meta name="twitter:description" content="How to abuse .net core startup hooks to make apps behave in crazy ways.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2019-02-01T00:00:00">
  
  
    <meta property="article:modified_time" content="2019-02-01T00:00:00">
  
  
  
  
    
      <meta property="article:tag" content="dotnet">
    
      <meta property="article:tag" content="fun">
    
      <meta property="article:tag" content="startup-hooks">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@kookiz">


  <meta name="twitter:creator" content="@kookiz">






  <meta property="og:image" content="https://minidump.net/images/profile.png">
  <meta property="twitter:image" content="https://minidump.net/images/profile.png">





  <meta property="og:image" content="https://minidump.net/images/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1-3.png">
  <meta property="twitter:image" content="https://minidump.net/images/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1-3.png">


    <title>Have some fun with .net core startup hooks</title>

    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    

    

    <link rel="canonical" href="https://minidump.net/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://minidump.net/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MQCXFBVCCM"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-MQCXFBVCCM', { 'anonymize_ip': false });
}
</script>

    
    <script>
    (function(h,o,u,n,d) {
      h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}}
      d=o.createElement(u);d.async=1;d.src=n
      n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n)
    })(window,document,'script','https://www.datadoghq-browser-agent.com/us1/v5/datadog-rum.js','DD_RUM')
    window.DD_RUM.onReady(function() {
      window.DD_RUM.init({
        clientToken: 'pubabeb7320d5ecb81f3b14a17c35c1a3de',
        applicationId: '78b5d24e-77d4-4bba-ae37-5a46f7386b95',
        site: 'datadoghq.com',
        service: 'minidump.net',
        env: 'kevin',
        sessionSampleRate: 100,
        sessionReplaySampleRate: 20,
        trackUserInteractions: true,
        trackResources: true,
        trackLongTasks: true,
        defaultPrivacyLevel: 'mask-user-input',
      });
    })
</script>
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/" aria-label="Go to homepage">minidump.net</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about" aria-label="Read more about the author">
          <img class="sidebar-profile-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Kevin Gosse</h4>
        
          <h5 class="sidebar-profile-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/kookiz" target="_blank" rel="noopener" title="Twitter">
    
      <i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/kevingosse" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.buymeacoffee.com/kevingosse" target="_blank" rel="noopener" title="Buy me a coffee">
    
      <i class="sidebar-button-icon fas fa-lg fa-coffee" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Buy me a coffee</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      Have some fun with .net core startup hooks
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2019-02-01T00:00:00Z">
        
  
  
  
  
    February 01 2019
  

      </time>
    
    
  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>One feature of .net core 2.2 that didn&rsquo;t catch my attention immediately is the <a href="https://github.com/dotnet/core-setup/blob/master/Documentation/design-docs/host-startup-hook.md">startup hooks</a>. Put simply, this is a way to register globally a method in an assembly that will be executed whenever a .net core application is started. This unlocks a whole range of scenarios, from injecting a profiler to tweaking a static context in a given environment.</p>
<p>How does it work? First, you need to create a new .net core assembly, and add a StartupHook class. Make sure that it&rsquo;s outside of any namespace. That class must define a static Initialize method. That&rsquo;s the method that will be called whenever a .net core application is started.</p>
<p>The following hook, for instance, will display &ldquo;Hello world!&rdquo; when an application is launched:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StartupHook</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Initialize()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>       Console.WriteLine(<span style="color:#e6db74">&#34;Hello world!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>To register the hook, you need to declare a <code>DOTNET_STARTUP_HOOKS</code> environment variable, pointing to the assembly. Once you&rsquo;ve done that, you&rsquo;ll see the message displayed:</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1-1.png" data-fancybox="">
  
    <img class="fig-img" src="/images/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1-1.png" >
  
    </a>
  
  
</div>

<p>It&rsquo;s really important to understand that <strong>the hook is executed inside of the application process</strong>. And a globally registered hook that runs inside of all .net core processes sounds like a good prank setup for unsuspecting coworkers.</p>
<h1 id="the-inverted-console">The inverted console</h1>
<p>What kind of prank? Let&rsquo;s start with something simple: what about overriding the console stream to reverse the displayed text? First we write a custom <code>TextWriter</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InvertedTextWriter</span> : TextWriter
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> TextWriter _writer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> InvertedTextWriter(TextWriter baseTextWriter)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _writer = baseTextWriter;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> Encoding Encoding =&gt; _writer.Encoding;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> Write(<span style="color:#66d9ef">string</span> <span style="color:#66d9ef">value</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _writer.Write(<span style="color:#66d9ef">string</span>.Concat(<span style="color:#66d9ef">value</span>.Reverse()));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Then we assign it to the console in the startup hook:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StartupHook</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Initialize()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Console.SetOut(<span style="color:#66d9ef">new</span> InvertedTextWriter(Console.Out));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Once the startup hook is registered, all .net core 2.2 applications will output inverted text in the console:</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1-2.png" data-fancybox="">
  
    <img class="fig-img" src="/images/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1-2.png" >
  
    </a>
  
  
</div>

<p>And the best part is that it even works for the &ldquo;dotnet.exe&rdquo; executable itself!</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1-3.png" data-fancybox="">
  
    <img class="fig-img" src="/images/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1-3.png" >
  
    </a>
  
  
</div>

<p>You can easily imagine the confusion that would come from it.</p>
<h1 id="overriding-arrayempty">Overriding Array.Empty</h1>
<p>Is there anything else we can do? I&rsquo;ve been unsuccessful at replacing the value of <code>string.Empty</code> (probably because it&rsquo;s declared as an intrinsic), but we can instead replace the value of <code>Array.Empty&lt;T&gt;</code>. For instance for <code>Array.Empty&lt;string&gt;</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StartupHook</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Initialize()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> type = Type.GetType(<span style="color:#e6db74">&#34;System.Array+EmptyArray`1&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> arrayStringType = type.MakeGenericType(<span style="color:#66d9ef">typeof</span>(<span style="color:#66d9ef">string</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> field = arrayStringType.GetField(<span style="color:#e6db74">&#34;Value&#34;</span>, System.Reflection.BindingFlags.Static | System.Reflection.BindingFlags.NonPublic);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        field.SetValue(<span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">string</span>[] { <span style="color:#e6db74">&#34;Hello world!&#34;</span> });        
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This sounds rather inoffensive, until you consider the case of methods with <code>params</code> argument. For instance, this method:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> PrintArgs(<span style="color:#66d9ef">params</span> <span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> arg <span style="color:#66d9ef">in</span> args)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Console.WriteLine(arg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>From a C# point of view, you can call it without any parameter (<code>PrintArgs()</code>). But from an IL perspective, the args parameter is just an ordinary array. The magic is done by the compiler, which automatically inserts an empty array, effectively rewriting the call to <code>PrintArgs(Array.Empty&lt;string&gt;())</code>. Therefore, with the startup hook registered, the method called without any parameter will actually display &ldquo;Hello world!&rdquo;.</p>
<h1 id="the-async-state-machine">The async state machine</h1>
<p>Those are already nice ways to confuse coworkers, but I wanted to go even farther. That&rsquo;s when I thought of replacing the default <code>TaskScheduler</code>. What could we do with it? What about… rewriting values at random in the async state machine? When a method uses async/await, it is converted to a state machine that stores among other things the local variables used by the method (to restore the context when the await continuation starts executing). If we manage to retrieve that state machine, we can therefore change the value of the locals between each await!</p>
<p>We start by declaring our custom task scheduler (and name it <code>ThreadPoolTaskScheduler</code> in case somebody would think of inspecting the callstack), and we use it to overwrite <code>TaskScheduler.Default</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StartupHook</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Initialize()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">typeof</span>(Task).GetField(<span style="color:#e6db74">&#34;s_asyncDebuggingEnabled&#34;</span>, BindingFlags.Static | BindingFlags.NonPublic)
</span></span><span style="display:flex;"><span>            .SetValue(<span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">typeof</span>(TaskScheduler).GetField(<span style="color:#e6db74">&#34;s_defaultTaskScheduler&#34;</span>, BindingFlags.Static | BindingFlags.NonPublic)
</span></span><span style="display:flex;"><span>            .SetValue(<span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">new</span> ThreadPoolTaskScheduler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">    
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [DebuggerDisplay(&#34;ThreadPoolTaskScheduler&#34;)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ThreadPoolTaskScheduler</span> : TaskScheduler
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> IEnumerable&lt;Task&gt; GetScheduledTasks()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> QueueTask(Task task)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            MutateState(task);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ThreadPool.UnsafeQueueUserWorkItem(t =&gt; TryExecuteTask((Task)t), task);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> MutateState(Task task)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// TODO</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">bool</span> TryExecuteTaskInline(Task task, <span style="color:#66d9ef">bool</span> taskWasPreviouslyQueued)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            MutateState(task);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> TryExecuteTask(task);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Note that we also always set <code>s_asyncDebuggingEnabled</code> to true to avoid having a different behavior when the debugger is attached, which would complicate our code. The task scheduler calls an empty <code>MutateState</code> method, then uses the threadpool to schedule the task execution. Now we need to implement that method.</p>
<p>How to retrieve the state machine? The first step is to retrieve the <a href="https://github.com/dotnet/corefx/blob/332d12c0a401927c84d8a2c2ea113427481689ab/src/Common/src/CoreLib/System/Runtime/CompilerServices/AsyncMethodBuilder.cs#L1107"><code>ContinuationWrapper</code></a>. This is a structure that wraps the task action when <code>s_asyncDebuggingEnabled</code> is set to true. Depending on the type of task, we can find it either on task action or on the state:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> MutateState(Task task)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> continuationWrapperType = Type.GetType(<span style="color:#e6db74">&#34;System.Runtime.CompilerServices.AsyncMethodBuilderCore+ContinuationWrapper&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> taskAction = <span style="color:#66d9ef">typeof</span>(Task).GetField(<span style="color:#e6db74">&#34;m_action&#34;</span>, BindingFlags.Instance | BindingFlags.NonPublic)
</span></span><span style="display:flex;"><span>        .GetValue(task);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Delegate func = task.AsyncState <span style="color:#66d9ef">as</span> Delegate ?? taskAction <span style="color:#66d9ef">as</span> Delegate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (func?.Target?.GetType() == continuationWrapperType)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> continuationWrapper = func.Target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>From there, we retrieve the value of the <code>_continuation</code> field and check if it is an instance of <code>AsyncStateMachineBox</code>. If it is, then we can find the state machine in the <code>StateMachine</code> field:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> continuationWrapper = func.Target;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> continuation = continuationWrapper.GetType().GetField(<span style="color:#e6db74">&#34;_continuation&#34;</span>, BindingFlags.Instance | BindingFlags.NonPublic)
</span></span><span style="display:flex;"><span>    .GetValue(continuationWrapper) <span style="color:#66d9ef">as</span> Action;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (continuation != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> asyncStateMachineBox = continuation.Target;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> stateMachineField = asyncStateMachineBox?.GetType().GetField(<span style="color:#e6db74">&#34;StateMachine&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (stateMachineField != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> stateMachine = stateMachineField.GetValue(asyncStateMachineBox);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>What does an async state machine look like?</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1-4.png" data-fancybox="">
  
    <img class="fig-img" src="/images/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1-4.png" >
  
    </a>
  
  
</div>

<p>Two public fields are always there: <code>&lt;&gt;1__state</code> and <code>&lt;&gt;t__builder</code>. <code>&lt;&gt;1__state</code> is used to store the current execution step in the async method. We could use it for instance to rewind the execution of the method. <code>&lt;&gt;t__builder</code> contains the facilities used to await other methods (nested calls). There&rsquo;s plenty of stuff we could do with it, but we&rsquo;ll focus on the locals.</p>
<p>The locals are stored in the private fields. In this case, <code>&lt;&gt;u__1</code> and <code>&lt;j&gt;5__1</code>. Those are the ones we want to play with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> stateMachine = stateMachineField.GetValue(asyncStateMachineBox);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> newStateMachine = Activator.CreateInstance(stateMachine.GetType());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> field <span style="color:#66d9ef">in</span> stateMachine.GetType().GetFields(BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (field.IsPrivate &amp;&amp; field.FieldType == <span style="color:#66d9ef">typeof</span>(<span style="color:#66d9ef">int</span>))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        field.SetValue(newStateMachine, _rnd.Next());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        field.SetValue(newStateMachine, field.GetValue(stateMachine));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stateMachineField.SetValue(asyncStateMachineBox, newStateMachine);
</span></span></code></pre></div><p>What we do here is creating a new state machine, then copy the value of the old fields to the new ones. If the field is private and is an int, we replace it by a random value.</p>
<p>Now let&rsquo;s make a simple program to test the hook:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Task.Run(Test);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Console.ReadLine();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> Task Test()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">42</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> Task.Delay(<span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Console.WriteLine(i);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And you&rsquo;ll see that… it doesn&rsquo;t work. Why? Because the TPL has been pretty well optimized. In a lot of places, the code checks the current scheduler, and completely bypasses it if it&rsquo;s the default one to directly schedule the continuation on the threadpool. For instance, <a href="https://github.com/dotnet/corefx/blob/016839c18266f33eaa6784a9725c542de151eac1/src/Common/src/CoreLib/System/Runtime/CompilerServices/YieldAwaitable.cs#L98">in the <code>YieldAwaiter</code> (used by <code>Task.Yield</code></a>).</p>
<p>How can we work around that? We absolutely need our custom task scheduler to be the default one, otherwise it won&rsquo;t be used when calling <code>Task.Run</code>. But if the default task scheduler is assigned to a task, then we won&rsquo;t be called back and we won&rsquo;t be able to mutate the state. If we check the code of the <code>YieldAwaiter</code> above, we can see that it&rsquo;s doing a simple reference comparison. So we can overwrite the scheduler of the task with a new instance of our custom scheduler to fool those checks:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> QueueTask(Task task)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    MutateState(task);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> newScheduler = <span style="color:#66d9ef">new</span> ThreadPoolTaskScheduler();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">typeof</span>(Task).GetField(<span style="color:#e6db74">&#34;m_taskScheduler&#34;</span>, BindingFlags.Instance | BindingFlags.NonPublic)
</span></span><span style="display:flex;"><span>        .SetValue(task, newScheduler);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ThreadPool.UnsafeQueueUserWorkItem(t =&gt; newScheduler.ExecuteTask((Task)t), task);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> ExecuteTask(Task t)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    TryExecuteTask(t);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Are we done? If we go back to our example, we can start debugging step by step:</p>


 
  
  
  
  
    
  

<div class="figure " >
  
    <a class="fancybox" href="/images/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1-5.png" data-fancybox="">
  
    <img class="fig-img" src="/images/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1-5.png" >
  
    </a>
  
  
</div>

<p>i is 42, all good. One more step and…</p>


 
  
  
  
  
    
  

<div class="figure " >
  
    <a class="fancybox" href="/images/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1-6.png" data-fancybox="">
  
    <img class="fig-img" src="/images/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1-6.png" >
  
    </a>
  
  
</div>

<p>Now go and enjoy the dumbfounded looks of your coworkers!</p>
<p>Note that this won&rsquo;t work when using <code>ConfigureAwait(false)</code>, because it directly enqueues the continuation to the threadpool and won&rsquo;t even check the current task scheduler (why would it?). One way around that could be to override the task builder with a custom one, but the joke already went far enough as is 🙂</p>
<p>Of course, all those tricks could have unpredictable effects on the target applications, so make sure to closely supervise the prank and stop as soon as it could become dangerous.</p>

              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/dotnet/">dotnet</a>

  <a class="tag tag--primary tag--small" href="/tags/fun/">fun</a>

  <a class="tag tag--primary tag--small" href="/tags/startup-hooks/">startup-hooks</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/writing-clrmd-extensions-for-windbg-and-lldb-916427956f66/" data-tooltip="Writing ClrMD extensions for WinDbg and LLDB" aria-label="NEXT: Writing ClrMD extensions for WinDbg and LLDB">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/implementing-java-referencequeue-and-phantomreference-in-c-827d7141b6e4/" data-tooltip="Implementing Java ReferenceQueue and PhantomReference in C#" aria-label="PREVIOUS: Implementing Java ReferenceQueue and PhantomReference in C#">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            

<link href="https://fonts.googleapis.com/css?family=Cookie&amp;display=swap" rel="stylesheet">
<div class="bmc-btn-container"><a class="bmc-btn" target="_blank" href="https://buymeacoffee.com/kevingosse">☕<span class="bmc-btn-text">Enjoyed the article? Buy me a coffee</span></a></div>

<style>
    .bmc-btn {
        min-width: 210px;
        color: #000000;
        background-color: #FFFFFF !important;
        height: 60px;
        border-radius: 12px;
        font-size: 28px;
        font-weight: Normal;
        border: none;
        line-height: 27px;
        text-decoration: none !important;
        display: inline-flex !important;
        justify-content: center;
        align-items: center;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
    }

    .bmc-btn:hover, .bmc-btn:active, .bmc-btn:focus {
        text-decoration: none !important;
        cursor: pointer;
    }

    .bmc-btn-text {
        margin-left: 8px;
        display: inline-block;
        line-height: 0;
        width: 100%;
        flex-shrink: 0;
        font-family: [FONT] !important;
    }

    .logo-outline {
        fill: #000000;
    }

    .logo-coffee {
        fill: #ffffff;
    }</style>

  
<div id="utterances">
      <noscript>Please enable JavaScript to view the comments powered by Utterances.</noscript>
    </div>
<script src="https://utteranc.es/client.js"
        repo="kevingosse/kevingosse.github.io"
        issue-term="title"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2024 Kevin Gosse. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/writing-clrmd-extensions-for-windbg-and-lldb-916427956f66/" data-tooltip="Writing ClrMD extensions for WinDbg and LLDB" aria-label="NEXT: Writing ClrMD extensions for WinDbg and LLDB">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/implementing-java-referencequeue-and-phantomreference-in-c-827d7141b6e4/" data-tooltip="Implementing Java ReferenceQueue and PhantomReference in C#" aria-label="PREVIOUS: Implementing Java ReferenceQueue and PhantomReference in C#">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/c-have-some-fun-with-net-core-startup-hooks-498b9ad001e1/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="2">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fminidump.net%2Fc-have-some-fun-with-net-core-startup-hooks-498b9ad001e1%2F" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https%3A%2F%2Fminidump.net%2Fc-have-some-fun-with-net-core-startup-hooks-498b9ad001e1%2F" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i><span>Share on Linkedin</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.reddit.com/submit?url=https%3A%2F%2Fminidump.net%2Fc-have-some-fun-with-net-core-startup-hooks-498b9ad001e1%2F" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i><span>Share on Reddit</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fminidump.net%2Fc-have-some-fun-with-net-core-startup-hooks-498b9ad001e1%2F" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i><span>Share on Hacker News</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>


    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Kevin Gosse</h4>
    
      <div id="about-card-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</div>
    
    
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://minidump.net/images/code.png');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://minidump.net/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

