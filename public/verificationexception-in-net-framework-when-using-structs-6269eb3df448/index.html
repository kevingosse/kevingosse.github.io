<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <script type="application/ld+json">

{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "VerificationException in .NET Framework when using structs",
  
  "image": "https://minidump.net/images/verificationexception-in-net-framework-when-using-structs-6269eb3df448-2.webp",
  
  "datePublished": "2023-05-01T00:00:00Z",
  "dateModified": "2023-05-01T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Kevin Gosse",
    
    "image": "https://minidump.net/images/profile.png"
    
  },
  "mainEntityOfPage": { 
    "@type": "WebPage",
    "@id": "https:\/\/minidump.net\/verificationexception-in-net-framework-when-using-structs-6269eb3df448\/" 
  },
  "publisher": {
    "@type": "Organization",
    "name": "minidump.net",
    
    "logo": {
      "@type": "ImageObject",
      "url": "https://minidump.net/images/profile.png"
    }
    
  },
  "description": "A surprising error occuring when using C# 7.3 with partial trust.",
  "keywords": []
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.121.1 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="Kevin Gosse">
<meta name="keywords" content="">
<meta name="description" content="A surprising error occuring when using C# 7.3 with partial trust.">


<meta property="og:description" content="A surprising error occuring when using C# 7.3 with partial trust.">
<meta property="og:type" content="article">
<meta property="og:title" content="VerificationException in .NET Framework when using structs">
<meta name="twitter:title" content="VerificationException in .NET Framework when using structs">
<meta property="og:url" content="https://minidump.net/verificationexception-in-net-framework-when-using-structs-6269eb3df448/">
<meta property="twitter:url" content="https://minidump.net/verificationexception-in-net-framework-when-using-structs-6269eb3df448/">
<meta property="og:site_name" content="minidump.net">
<meta property="og:description" content="A surprising error occuring when using C# 7.3 with partial trust.">
<meta name="twitter:description" content="A surprising error occuring when using C# 7.3 with partial trust.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2023-05-01T00:00:00">
  
  
    <meta property="article:modified_time" content="2023-05-01T00:00:00">
  
  
  
  
    
      <meta property="article:tag" content="dotnet">
    
      <meta property="article:tag" content="x64dbg">
    
      <meta property="article:tag" content="cpp">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@kookiz">


  <meta name="twitter:creator" content="@kookiz">






  <meta property="og:image" content="https://minidump.net/images/profile.png">
  <meta property="twitter:image" content="https://minidump.net/images/profile.png">





  <meta property="og:image" content="https://minidump.net/images/verificationexception-in-net-framework-when-using-structs-6269eb3df448-2.webp">
  <meta property="twitter:image" content="https://minidump.net/images/verificationexception-in-net-framework-when-using-structs-6269eb3df448-2.webp">


    <title>VerificationException in .NET Framework when using structs</title>

    <link rel="icon" href="/favicon.png">
    

    

    <link rel="canonical" href="https://minidump.net/verificationexception-in-net-framework-when-using-structs-6269eb3df448/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://minidump.net/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/" aria-label="Go to homepage">minidump.net</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about" aria-label="Read more about the author">
          <img class="sidebar-profile-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Kevin Gosse</h4>
        
          <h5 class="sidebar-profile-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/kookiz" target="_blank" rel="noopener" title="Twitter">
    
      <i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/kevingosse" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.buymeacoffee.com/kevingosse" target="_blank" rel="noopener" title="Buy me a coffee">
    
      <i class="sidebar-button-icon fas fa-lg fa-coffee" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Buy me a coffee</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      VerificationException in .NET Framework when using structs
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-05-01T00:00:00Z">
        
  
  
  
  
    May 01 2023
  

      </time>
    
    
  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>Consider the following code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> ReadonlyStruct Struct;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Read()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Console.WriteLine(Struct.Value);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ReadonlyStruct</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ReadonlyStruct(<span style="color:#66d9ef">int</span> <span style="color:#66d9ef">value</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Value = <span style="color:#66d9ef">value</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Value;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This looks pretty straightforward, right? We store a struct in a readonly field, and read it.</p>
<p>Yet, what happens if we try to run this program in .NET Framework under partial trust?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> permissionSet = <span style="color:#66d9ef">new</span> PermissionSet(PermissionState.None);
</span></span><span style="display:flex;"><span>    permissionSet.AddPermission(<span style="color:#66d9ef">new</span> SecurityPermission(SecurityPermissionFlag.Execution));
</span></span><span style="display:flex;"><span>    permissionSet.AddPermission(<span style="color:#66d9ef">new</span> ReflectionPermission(PermissionState.Unrestricted));
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> appDomain = AppDomain.CreateDomain(<span style="color:#e6db74">&#34;ChildDomain&#34;</span>, <span style="color:#66d9ef">null</span>, AppDomain.CurrentDomain.SetupInformation, permissionSet);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        appDomain.DoCallBack(RRead);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> (VerificationException ex)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Console.WriteLine(<span style="color:#e6db74">&#34;Read failed: &#34;</span> + ex);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The answer is… It crashes with a <code>VerificationException</code> and a scary message (&ldquo;Operation could destabilize the runtime&rdquo;).</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/verificationexception-in-net-framework-when-using-structs-6269eb3df448-1.webp" data-fancybox="">
  
    <img class="fig-img" src="/images/verificationexception-in-net-framework-when-using-structs-6269eb3df448-1.webp" >
  
    </a>
  
  
</div>

<p>The application stops crashing as soon as I remove the <code>readonly</code> keyword from the <code>Struct</code> field. Even weirder, it also stops crashing if you target an older version of C#, for instance by setting <code>&lt;LangVersion&gt;7&lt;/LangVersion&gt;</code> in the csproj file.</p>
<p>Besides the obvious &ldquo;why would anybody use partial trust nowadays&rdquo; question, I was really surprised by this behavior. There&rsquo;s nothing obviously unsafe in this code, so I decided to dig further.</p>
<blockquote>
<p>To answer the part about using partial trust, we caught this error in the Datadog .NET tracer, which until now supported partial trust. The reason why we supported such an obsolete feature is simply that we never had a compelling reason to drop support. We now do.</p>
</blockquote>
<h1 id="a-brief-reminder-about-partial-trust">A brief reminder about partial trust</h1>
<p>For the people who are lucky enough to never have to deal with partial trust, this is a feature that existed since the early days of .NET Framework. It allows to limit what type of code can be run in a given appdomain (or in the whole application), in theory to safely execute code coming from a potentially unsafe source (think for instance of a plugin system). Among other things, partial trust forbids the usage of the <code>unsafe</code> keyword, because otherwise it could be used to circumvent the limitations.</p>
<p>I didn&rsquo;t think much of this until I realized that forbidding <code>unsafe</code> is not as straightforward as it sounds. <code>unsafe</code> is a C# language feature, but partial trust operates at the IL level, where this concept does not exist. You could imagine that a special attribute is added when compiling unsafe C# code, but that wouldn&rsquo;t protect you from an assembly hand-crafted directly from IL. So how does the runtime detects the usage of <code>unsafe</code>? It does so by scanning the IL and checking for instructions that could <em>potentially</em> be unsafe (for instance, anything that directly loads an address), and restricts their usage to well-defined (&ldquo;verifiable&rdquo;) conditions.</p>
<h1 id="so-what-is-potentially-unsafe">So what is &ldquo;potentially unsafe&rdquo;?</h1>
<p>Now that we know that code verification operates at the IL level, let&rsquo;s check what our sample code produces. I annotated it to make it easier to understand to people who are not familiar with IL:</p>
<pre tabindex="0"><code>.field private static initonly valuetype PartialTrust.ReadonlyStruct Struct

.method public hidebysig static void  Read() cil managed
{
  .maxstack  8
  // Load the address of the static Program.Struct field
  ldsflda    valuetype PartialTrust.ReadonlyStruct PartialTrust.Program::Struct
  // Read the Value field as an int32
  ldfld      int32 PartialTrust.ReadonlyStruct::Value
  // Invoke Console.WriteLine
  call       void [mscorlib]System.Console::WriteLine(int32)
  // Return
  ret
}
</code></pre><p>For comparison, here is the IL code emitted if I change the csproj to target C# 7:</p>
<pre tabindex="0"><code>.field private static initonly valuetype PartialTrust.ReadonlyStruct Struct

.method public hidebysig static void  Read() cil managed
{
  .maxstack  8
  // Load the value of the static Program.Struct field
  ldsfld    valuetype PartialTrust.ReadonlyStruct PartialTrust.Program::Struct
  // Read the Value field as an int32
  ldfld      int32 PartialTrust.ReadonlyStruct::Value
  // Invoke Console.WriteLine
  call       void [mscorlib]System.Console::WriteLine(int32)
  // Return
  ret
}
</code></pre><p>The only difference is the <code>ldsflda</code> instruction being replaced with <code>ldsfld</code>. The former loads the address of the field on the stack, while the latter loads the value of the field (and therefore makes a copy of the struct).</p>
<p>It seems like this change was introduced in C# 7.2. This version introduced readonly structs, which are guaranteed to be immutable and allow the compiler to perform additional optimizations (reading the struct by reference instead of having to do a defensive copy). In my sample, the struct is not actually readonly, but because it&rsquo;s stored in a readonly field it looks like it&rsquo;s enough for the compiler to perform the same optimization.</p>
<p>In short, until C# 7.1, the compiler makes a copy of the struct because it&rsquo;s stored in a readonly field and it must guarantee that no change is made to the original value. Starting with C# 7.2, the compiler is smarter about it and realizes that reading a field from the struct is not going to cause any side-effect, and therefore stops making a copy.</p>
<blockquote>
<p>Note: there are a number of other situations where C# 7.2+ stops making a defensive copy, if you decorate the struct with the readonly keyword. Likewise, they will cause a VerificationException in partial trust. But the sample I&rsquo;m showing in this article is in my opinion more interesting because it does not use that new keyword, and the code compiles without any change with earlier versions of C#.</p>
</blockquote>
<h1 id="why-is-ldsflda-an-issue">Why is <code>ldsflda</code> an issue</h1>
<p>So far we&rsquo;ve explained two things:</p>
<ul>
<li>
<p>Partial trust verifies the IL to make sure the code isn&rsquo;t doing anything dangerous</p>
</li>
<li>
<p>Starting from C# 7.2 the <code>ldsfld</code> instruction in this sample gets replaced with <code>ldsflda</code>, causing the struct to be read by reference instead of value</p>
</li>
</ul>
<p>However, we still don&rsquo;t know why this is a problem at all. One critical thing to understand is that C# 7.2 is a compiler update. The runtime, and therefore the JIT compiler, hasn&rsquo;t been updated. The version of the JIT compiler bundled in .NET Framework does not expect the <code>ldsflda</code> instruction to be used in that situation.</p>
<p>I wanted to understand exactly what rule gets broken by the usage of <code>ldsflda</code>, so I checked the source code of the JIT. Partial trust has been removed in .NET Core, so we need to check the source code of .NET Framework. It&rsquo;s not publicly available, but you can get a close approximation <a href="https://github.com/dotnet/coreclr/tree/ef1e2ab328087c61a6878c1e84f4fc5d710aebce">by checking the first commit of the CoreCLR repository on github</a>, before it diverged too much.</p>
<p>By executing the code with a native debugger (<a href="https://x64dbg.com">x64dbg</a>&rsquo;s disassembly window is great, I recommend it), and cross-referencing the CoreCLR C++ code, I was eventually able to narrow it down to those few lines:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>CORINFO_CLASS_HANDLE enclosingClass <span style="color:#f92672">=</span> pResolvedToken<span style="color:#f92672">-&gt;</span>hClass;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> fieldFlags <span style="color:#f92672">=</span> fieldInfo.fieldFlags;
</span></span><span style="display:flex;"><span>CORINFO_CLASS_HANDLE instanceClass <span style="color:#f92672">=</span> info.compClassHnd; <span style="color:#75715e">// for statics, we imagine the instance is the current class.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> isStaticField <span style="color:#f92672">=</span> ((fieldFlags <span style="color:#f92672">&amp;</span> CORINFO_FLG_FIELD_STATIC) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (mutator)  
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Verify(<span style="color:#f92672">!</span>(fieldFlags <span style="color:#f92672">&amp;</span> CORINFO_FLG_FIELD_UNMANAGED), <span style="color:#e6db74">&#34;mutating an RVA bases static&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((fieldFlags <span style="color:#f92672">&amp;</span> CORINFO_FLG_FIELD_FINAL))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Verify((info.compFlags <span style="color:#f92672">&amp;</span> CORINFO_FLG_CONSTRUCTOR) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>               enclosingClass <span style="color:#f92672">==</span> info.compClassHnd <span style="color:#f92672">&amp;&amp;</span> info.compIsStatic <span style="color:#f92672">==</span> isStaticField,
</span></span><span style="display:flex;"><span>               <span style="color:#e6db74">&#34;bad use of initonly field (set or address taken)&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>

 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/verificationexception-in-net-framework-when-using-structs-6269eb3df448-2.webp" title="x64dbg is great to annotate the assembly" data-fancybox="">
  
    <img class="fig-img" src="/images/verificationexception-in-net-framework-when-using-structs-6269eb3df448-2.webp"  alt="x64dbg is great to annotate the assembly">
  
    </a>
  
   
    <span class="caption">x64dbg is great to annotate the assembly</span>
  
</div>

<p>This code is invoked when the JIT compiler verifies a method and finds a <code>ldsflda</code> instruction. Specifically, our <code>VerificationException</code> is caused by this line:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>Verify((info.compFlags <span style="color:#f92672">&amp;</span> CORINFO_FLG_CONSTRUCTOR) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>               enclosingClass <span style="color:#f92672">==</span> info.compClassHnd <span style="color:#f92672">&amp;&amp;</span> info.compIsStatic <span style="color:#f92672">==</span> isStaticField,
</span></span><span style="display:flex;"><span>               <span style="color:#e6db74">&#34;bad use of initonly field (set or address taken)&#34;</span>);
</span></span></code></pre></div><p>It verifies that <code>ldsflda</code> is used in the constructor of the class, as this is the only place where mutating a readonly field is allowed. Outside of that case, it assumes that the address of the field (returned by <code>ldsflda</code>) can be used to mutate the value, and so it forbids it. I&rsquo;m not a compiler expert but I feel like flow analysis could prove that reading the address is safe in that case, but because this optimization didn&rsquo;t exist when that JIT was written, they had no reason to do so. When the optimization was introduced with C# 7.2, Microsoft apparently didn&rsquo;t feel like it was necessary to upgrade the JIT compiler, probably because partial trust was already considered as obsolete.</p>
<h1 id="the-fix">The fix</h1>
<p>If for some reason you still need to support partial trust, I recommend adding this flag to the csproj:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;Features&gt;</span>peverify-compat<span style="color:#f92672">&lt;/Features&gt;</span>
</span></span></code></pre></div><p>It opts-out of those new incompatible optimizations. The name implies it was designed to maintain compatibility with the <code>peverify</code> tool, but it works with partial trust as well.</p>

              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/dotnet/">dotnet</a>

  <a class="tag tag--primary tag--small" href="/tags/x64dbg/">x64dbg</a>

  <a class="tag tag--primary tag--small" href="/tags/cpp/">cpp</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/writing-a-net-profiler-in-c-part-4-c54df903b9ce/" data-tooltip="Writing a .NET profiler in C# — Part 4" aria-label="NEXT: Writing a .NET profiler in C# — Part 4">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/writing-a-net-profiler-in-c-part-3-7d2c59fc017f/" data-tooltip="Writing a .NET profiler in C#   — Part 3" aria-label="PREVIOUS: Writing a .NET profiler in C#   — Part 3">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/verificationexception-in-net-framework-when-using-structs-6269eb3df448/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/verificationexception-in-net-framework-when-using-structs-6269eb3df448/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/verificationexception-in-net-framework-when-using-structs-6269eb3df448/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/verificationexception-in-net-framework-when-using-structs-6269eb3df448/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            

<link href="https://fonts.googleapis.com/css?family=Cookie&amp;display=swap" rel="stylesheet">
<div class="bmc-btn-container"><a class="bmc-btn" target="_blank" href="https://buymeacoffee.com/kevingosse">☕<span class="bmc-btn-text">Enjoyed the article? Buy me a coffee</span></a></div>

<style>
    .bmc-btn {
        min-width: 210px;
        color: #000000;
        background-color: #FFFFFF !important;
        height: 60px;
        border-radius: 12px;
        font-size: 28px;
        font-weight: Normal;
        border: none;
        line-height: 27px;
        text-decoration: none !important;
        display: inline-flex !important;
        justify-content: center;
        align-items: center;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
    }

    .bmc-btn:hover, .bmc-btn:active, .bmc-btn:focus {
        text-decoration: none !important;
        cursor: pointer;
    }

    .bmc-btn-text {
        margin-left: 8px;
        display: inline-block;
        line-height: 0;
        width: 100%;
        flex-shrink: 0;
        font-family: [FONT] !important;
    }

    .logo-outline {
        fill: #000000;
    }

    .logo-coffee {
        fill: #ffffff;
    }</style>

  
<div id="utterances">
      <noscript>Please enable JavaScript to view the comments powered by Utterances.</noscript>
    </div>
<script src="https://utteranc.es/client.js"
        repo="kevingosse/kevingosse.github.io"
        issue-term="title"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2024 Kevin Gosse. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/writing-a-net-profiler-in-c-part-4-c54df903b9ce/" data-tooltip="Writing a .NET profiler in C# — Part 4" aria-label="NEXT: Writing a .NET profiler in C# — Part 4">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/writing-a-net-profiler-in-c-part-3-7d2c59fc017f/" data-tooltip="Writing a .NET profiler in C#   — Part 3" aria-label="PREVIOUS: Writing a .NET profiler in C#   — Part 3">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/verificationexception-in-net-framework-when-using-structs-6269eb3df448/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/verificationexception-in-net-framework-when-using-structs-6269eb3df448/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/verificationexception-in-net-framework-when-using-structs-6269eb3df448/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/verificationexception-in-net-framework-when-using-structs-6269eb3df448/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="2">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fminidump.net%2Fverificationexception-in-net-framework-when-using-structs-6269eb3df448%2F" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https%3A%2F%2Fminidump.net%2Fverificationexception-in-net-framework-when-using-structs-6269eb3df448%2F" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i><span>Share on Linkedin</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.reddit.com/submit?url=https%3A%2F%2Fminidump.net%2Fverificationexception-in-net-framework-when-using-structs-6269eb3df448%2F" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i><span>Share on Reddit</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fminidump.net%2Fverificationexception-in-net-framework-when-using-structs-6269eb3df448%2F" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i><span>Share on Hacker News</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>


    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Kevin Gosse</h4>
    
      <div id="about-card-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</div>
    
    
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://minidump.net/images/code.png');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://minidump.net/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

