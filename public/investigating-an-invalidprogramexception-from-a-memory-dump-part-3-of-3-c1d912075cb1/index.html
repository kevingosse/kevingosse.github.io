<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <script type="application/ld+json">

{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Investigating an InvalidProgramException from a memory dump (part 3 of 3)",
  
  "image": "https://minidump.net/images/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1-2.webp",
  
  "datePublished": "2020-09-10T00:00:00Z",
  "dateModified": "2020-09-10T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Kevin Gosse",
    
    "image": "https://minidump.net/images/profile.png"
    
  },
  "mainEntityOfPage": { 
    "@type": "WebPage",
    "@id": "https:\/\/minidump.net\/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1\/" 
  },
  "publisher": {
    "@type": "Organization",
    "name": "minidump.net",
    
    "logo": {
      "@type": "ImageObject",
      "url": "https://minidump.net/images/profile.png"
    }
    
  },
  "description": "In this series of article, we\u0026rsquo;re retracing how I debugged an InvalidProgramException, caused by a bug in the Datadog profiler, from a memory dump sent by a customer. This is the last part of the investigation, about figuring out what is wrong with the IL code.",
  "keywords": []
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.121.1 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="Kevin Gosse">
<meta name="keywords" content="">
<meta name="description" content="In this series of article, we&rsquo;re retracing how I debugged an InvalidProgramException, caused by a bug in the Datadog profiler, from a memory dump sent by a customer. This is the last part of the investigation, about figuring out what is wrong with the IL code.">


<meta property="og:description" content="In this series of article, we&rsquo;re retracing how I debugged an InvalidProgramException, caused by a bug in the Datadog profiler, from a memory dump sent by a customer. This is the last part of the investigation, about figuring out what is wrong with the IL code.">
<meta property="og:type" content="article">
<meta property="og:title" content="Investigating an InvalidProgramException from a memory dump (part 3 of 3)">
<meta name="twitter:title" content="Investigating an InvalidProgramException from a memory dump (part 3 of 3)">
<meta property="og:url" content="https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1/">
<meta property="twitter:url" content="https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1/">
<meta property="og:site_name" content="minidump.net">
<meta property="og:description" content="In this series of article, we&rsquo;re retracing how I debugged an InvalidProgramException, caused by a bug in the Datadog profiler, from a memory dump sent by a customer. This is the last part of the investigation, about figuring out what is wrong with the IL code.">
<meta name="twitter:description" content="In this series of article, we&rsquo;re retracing how I debugged an InvalidProgramException, caused by a bug in the Datadog profiler, from a memory dump sent by a customer. This is the last part of the investigation, about figuring out what is wrong with the IL code.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2020-09-10T00:00:00">
  
  
    <meta property="article:modified_time" content="2020-09-10T00:00:00">
  
  
  
  
    
      <meta property="article:tag" content="dotnet">
    
      <meta property="article:tag" content="debugging">
    
      <meta property="article:tag" content="lldb">
    
      <meta property="article:tag" content="windbg">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@kookiz">


  <meta name="twitter:creator" content="@kookiz">






  <meta property="og:image" content="https://minidump.net/images/profile.png">
  <meta property="twitter:image" content="https://minidump.net/images/profile.png">





  <meta property="og:image" content="https://minidump.net/images/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1-2.webp">
  <meta property="twitter:image" content="https://minidump.net/images/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1-2.webp">


    <title>Investigating an InvalidProgramException from a memory dump (part 3 of 3)</title>

    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    

    

    <link rel="canonical" href="https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://minidump.net/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MQCXFBVCCM"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-MQCXFBVCCM', { 'anonymize_ip': false });
}
</script>

    
    <script>
    (function(h,o,u,n,d) {
      h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}}
      d=o.createElement(u);d.async=1;d.src=n
      n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n)
    })(window,document,'script','https://www.datadoghq-browser-agent.com/us1/v5/datadog-rum.js','DD_RUM')
    window.DD_RUM.onReady(function() {
      window.DD_RUM.init({
        clientToken: 'pubabeb7320d5ecb81f3b14a17c35c1a3de',
        applicationId: '78b5d24e-77d4-4bba-ae37-5a46f7386b95',
        site: 'datadoghq.com',
        service: 'minidump.net',
        env: 'kevin',
        sessionSampleRate: 100,
        sessionReplaySampleRate: 20,
        trackUserInteractions: true,
        trackResources: true,
        trackLongTasks: true,
        defaultPrivacyLevel: 'mask-user-input',
      });
    })
</script>
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/" aria-label="Go to homepage">minidump.net</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about" aria-label="Read more about the author">
          <img class="sidebar-profile-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Kevin Gosse</h4>
        
          <h5 class="sidebar-profile-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/kookiz" target="_blank" rel="noopener" title="Twitter">
    
      <i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/kevingosse" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.buymeacoffee.com/kevingosse" target="_blank" rel="noopener" title="Buy me a coffee">
    
      <i class="sidebar-button-icon fas fa-lg fa-coffee" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Buy me a coffee</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      Investigating an InvalidProgramException from a memory dump (part 3 of 3)
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2020-09-10T00:00:00Z">
        
  
  
  
  
    September 10 2020
  

      </time>
    
    
  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>In this series of articles, we&rsquo;re retracing how I debugged an <code>InvalidProgramException</code>, caused by a bug in the Datadog profiler, from a memory dump sent by a customer.</p>
<ul>
<li>
<p><a href="/investigating-an-invalidprogramexception-from-a-memory-dump-part-1-of-3-bce634460cc3">Part 1: Preliminary exploration</a></p>
</li>
<li>
<p><a href="/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4">Part 2: Finding the generated IL</a></p>
</li>
<li>
<p>Part 3: Identifying the error and fixing the bug</p>
</li>
</ul>
<p>In the previous part, we&rsquo;ve located the bad generated IL, stored in an internal CLR structure. The third part is going to be about understanding what&rsquo;s wrong with the IL, and finding the root cause.</p>
<h1 id="identifying-the-error">Identifying the error</h1>
<p>There are a lot of things that can be wrong in some IL code, so I wasn&rsquo;t short of stuff to try. I decided to start by checking the method size.</p>
<p>There are two different formats of header for IL methods: the fat header and the tiny header. A method can have a tiny header only if it doesn&rsquo;t use local variables and don&rsquo;t have try/catch blocks, so in my case I knew it had to be a fat header. The layout of the fat header is:</p>
<ul>
<li>
<p>2 bytes: flags + size of the header (always 12 bytes)</p>
</li>
<li>
<p>2 bytes: maximum size of the stack (<code>maxstack</code>)</p>
</li>
<li>
<p>4 bytes: <strong>size of the method</strong></p>
</li>
<li>
<p>4 bytes: LocalVarSig token</p>
</li>
</ul>
<p>With that information in hand, I just had to dump 4 bytes at a 4-byte offset from the memory location of the IL:</p>
<pre tabindex="0"><code>(lldb) memory read --count 1 --size 4 --format x 0x0007fce8c983790+4
0x7fce8c983794: 0x000005fe
</code></pre><p>0x5fe means 1534 in decimal. How to check if the method body had the right size? <a href="https://twitter.com/tonywanhjor">My co-worker Tony</a> had a bright idea: we knew that the method would finish with a <code>ret</code> instruction (opcode 0x2A), so I just had to look for that value at the supposed end of the method body.</p>
<p>I went on and dumped 1546 bytes of memory (12 bytes for the header, then the 1534 bytes for the body) to check the value of the last byte:</p>
<pre tabindex="0"><code>(lldb) memory read --count 1546 --size 1 --force --format x 0x00007fce8c983790
0x7fce8c983790: 0x1b 0x30 0x02 0x00 0xfe 0x05 0x00 0x00
0x7fce8c983798: 0x75 0x02 0x00 0x11 0x02 0x7b 0x00 0x08
[...]
0x7fce8c983d90: 0x08 0x00 0x04 0x08 0x28 0xc3 0x08 0x00
0x7fce8c983d98: 0x0a 0x2a
</code></pre><p>The method was the correct size, it was time to check the body itself. I could easily dump the raw data on the disk, but I was moderately motivated at the perspective of writing an IL parser to read it. I then realized that the <code>dumpil</code> command had a <code>/i</code> flag to print the IL from an arbitrary location:</p>
<pre tabindex="0"><code>&gt; help dumpil
--------------------------------------------------------------------
DumpIL &lt;Managed DynamicMethod object&gt; |
       &lt;DynamicMethodDesc pointer&gt; |
       &lt;MethodDesc pointer&gt; |
        /i &lt;IL pointer&gt;
</code></pre><p>I happily gave it a try, without much success:</p>
<pre tabindex="0"><code>&gt; dumpil /i 0x00007fce8c983790
Incorrect argument: 0x00007fce8c983790
&gt; dumpil -i 0x00007fce8c983790
Unknown option: -i
</code></pre><p>Since the IL was supposed to be invalid to begin with, I wasn&rsquo;t really surprised that the command wouldn&rsquo;t work. I decided to have a look at the source code to understand why it was failing, hoping that this would give me a clue. But it turned out that it was failing for completely unrelated reasons.</p>
<p><a href="https://github.com/dotnet/diagnostics/blob/release/3.0/src/SOS/Strike/strike.cpp#L847">In the definition of the <code>dumpil</code> command</a>, the <code>/i</code> option is declared, as expected:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>    CMDOption option[] <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    {   <span style="color:#75715e">// name, vptr, type, hasValue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        {<span style="color:#e6db74">&#34;/d&#34;</span>, <span style="color:#f92672">&amp;</span>dml, COBOOL, FALSE},
</span></span><span style="display:flex;"><span>        {<span style="color:#e6db74">&#34;/i&#34;</span>, <span style="color:#f92672">&amp;</span>fILPointerDirectlySpecified, COBOOL, FALSE},
</span></span><span style="display:flex;"><span>    };
</span></span></code></pre></div><p>But then, <a href="https://github.com/dotnet/diagnostics/blob/release/3.0/src/SOS/Strike/util.cpp#L3745">in the argument parsing code</a>, only <code>-</code> is accepted as prefix on Linux!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">#ifndef FEATURE_PAL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (ptr[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#f92672">&amp;&amp;</span> ptr[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;/&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (ptr[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;-&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><p><em>For those who are not used to browsing the CLR code, <code>FEATURE_PAL</code> is defined when compiling for platforms other than Windows.</em></p>
<p>To summarize, <code>dumpil</code> is declaring a <code>/i</code> argument, but the parsing code looks for<code>-i</code>. Therefore, the command simply couldn&rsquo;t work on Linux. <a href="https://github.com/dotnet/diagnostics/issues/1478">I filled an issue</a>, and in the meantime I compiled my own version of dotnet-dump which fixed the issue. I was finally able to use the <code>dumpil</code> command:</p>
<pre tabindex="0"><code>&gt; dumpil -i 0x00007fce8c983790
IL_0000: ldarg.0
IL_0001: ldfld TOKEN 4000800
IL_0006: stloc.0
IL_0007: ldarg.0
IL_0008: ldfld TOKEN 4000803
[...]
IL_05f2: ldflda TOKEN 4000801
IL_05f7: ldloc.2
IL_05f8: call TOKEN a0008c3
IL_05fd: ret
</code></pre><p>I methodically compared it with the original IL, paying special attention to the parts that we rewrote, but found nothing wrong.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1-1.webp" title="Always have a diff tool ready" data-fancybox="">
  
    <img class="fig-img" src="/images/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1-1.webp"  alt="Always have a diff tool ready">
  
    </a>
  
   
    <span class="caption">Always have a diff tool ready</span>
  
</div>

<p>Note that the method tokens are not resolved in the <code>dumpil -i</code> output. That&rsquo;s because it doesn&rsquo;t have the context of the method, so it cannot guess what module to use to resolve them (so instead of, say, <code>call Hello::World()</code>, it would display <code>call TOKEN a000b60</code>). Suspecting that the token could be wrong in the rewritten method, I tried resolving them manually. The token is named a &ldquo;MemberRef token&rdquo; (recognizable because it starts with <code>a0</code>). According to the specification, this is an index to a table that maps it to a MethodDesc (which I can then dump using the <code>dumpmd</code> command, as I did in previous parts of the investigation).</p>
<p>Quoting <a href="http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-335.pdf">the ECMA specification</a>:</p>
<pre tabindex="0"><code>II.22.25 MemberRef : 0x0A 
The MemberRef table combines two sorts of references, to Methods and to Fields of a class, known as ‘MethodRef&#39; and ‘FieldRef&#39;, respectively. 
[...]
An entry is made into the MemberRef table whenever a reference is made in the CIL code to a method or field which is defined in another module or assembly. 
</code></pre><p>I tried using the <code>dumpmodule</code> command to locate that table, but…</p>
<pre tabindex="0"><code>&gt; dumpmodule 00007fcf13ec67d8
Name: /Npgsql.dll
Attributes:              PEFile SupportsUpdateableMethods IsFileLayout
Assembly:                0000000002a3f590
BaseAddress:             00007FCF8079E000
PEFile:                  0000000002A638B0
ModuleId:                00007FCF13EC7FE0
ModuleIndex:             0000000000000091
LoaderHeap:              0000000000000000
TypeDefToMethodTableMap: 00007FCF13F30020
TypeRefToMethodTableMap: 00007FCF13F31270
MethodDefToDescMap:      00007FCF13F31EE8
FieldDefToDescMap:       00007FCF13F392E0
MemberRefToDescMap:      0000000000000000
FileReferencesMap:       00007FCF13F3F740
AssemblyReferencesMap:   00007FCF13F3F748
MetaData start address:  00007FCF807DF410 (496736 bytes)
</code></pre><p>No matter what module I tried, the <code>MemberRefToDescMap</code>field would always be missing. I checked <a href="https://github.com/dotnet/runtime/blob/29e9b5b7fd95231d9cd9d3ae351404e63cbb6d5a/src/coreclr/src/debug/daccess/request.cpp#L1680">the DAC implementation</a>, and it turns out there is actually no logic to populate that field!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>ModuleData<span style="color:#f92672">-&gt;</span>MemberRefToDescMap <span style="color:#f92672">=</span> NULL;
</span></span></code></pre></div><p><a href="https://github.com/dotnet/diagnostics/issues/1487">I filled an issue</a>, then tried locating the table myself. Unfortunately, the assembly metadata is a real mess (read <a href="https://www.ntcore.com/files/dotnetformat.htm#MetaTables">this article</a> for an appetizer), so I decided to leave it as last resort and focus on other hypotheses first.</p>
<p>Following a suggestion from Tony, I checked the SEH table for the method. I won&rsquo;t go into the details, but basically the location of the try/catch/finally blocks in a method is stored in a table at the end of the IL body. If you&rsquo;re feeling playful, the structure of the table is detailed <a href="http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-335.pdf">in the specification</a>, section <code>II.25.4.5 Method data section</code>.</p>
<p>There was nothing wrong with the SEH table either, so I turned my attention to <code>maxstack</code>. Every method has a <code>maxstack</code> directive, which indicates the maximum number of items that is expected to be pushed on the stack at any given time. This information is stored on two bytes in the method header, as described in the beginning of this article.</p>
<pre tabindex="0"><code>(lldb) memory read --count 6 --size 2 --format x 0x00007fce8c983790
0x7fce8c983790: 0x301b 0x0002 0x05fe 0x0000 0x0275 0x1100
</code></pre><p>We see here that <code>maxstack</code> is set to 2. This is abnormally low, considering that the original method had a <code>maxstack</code> of 4!</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1-2.webp" data-fancybox="">
  
    <img class="fig-img" src="/images/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1-2.webp" >
  
    </a>
  
  
</div>

<p>This was enough to explain why the JIT would throw an <code>InvalidProgramException</code>. But I still had to figure out how we ended up with this value.</p>
<h1 id="fixing-the-bug">Fixing the bug</h1>
<p>The IL rewriter used in the Datadog profiler is based <a href="https://github.com/microsoft/clr-samples/blob/master/ProfilingAPI/ReJITEnterLeaveHooks/ILRewriter.cpp">on a sample provided by Microsoft</a>. First, you need to be fully aware of how complex it is to rewrite IL. Let&rsquo;s say we want to inject a single instruction in the middle of the method. One could think it&rsquo;s just a matter of allocating a bigger buffer and inserting the new opcode. However, just doing that has a lot of impacts on the method:</p>
<ul>
<li>
<p>The size of the body has changed, so the header must be updated</p>
</li>
<li>
<p><code>maxstack</code> could be impacted</p>
</li>
<li>
<p>Since an instruction was inserted, all jumps destination must be recomputed</p>
</li>
<li>
<p>Same for the SEH table, delimiting the try/catch/finally blocks</p>
</li>
<li>
<p>Some instruction could need to be converted (for instance, <a href="https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes.brfalse_s?view=netcore-3.1&amp;WT.mc_id=DT-MVP-5003493"><code>brfalse_s</code></a> stores the jump offset on a single byte. If the additional instruction increases the offset past the maximum size, it&rsquo;ll need to be converted to a <a href="https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes.brfalse?view=netcore-3.1&amp;WT.mc_id=DT-MVP-5003493"><code>brfalse</code></a>)</p>
</li>
<li>
<p>… and I&rsquo;m probably forgetting some</p>
</li>
</ul>
<p>Because of all those impacts, the rewriter works by disassembling the method into a tree structure, then reassembling it into bytecode after applying the changes.</p>
<p>Back to <code>maxstack</code>. By inspecting the code of the rewriter, I discovered that it doesn&rsquo;t bother running a flow analysis, and instead relies on a worst-case prediction. It enumerates all the instructions in the method, and increments a value every time it sees an instruction that pushes something on the stack. That value is then assigned to <code>maxstack</code>. It is also never decremented when an instruction pops something from the stack.</p>
<p>In other words, have a look at this IL code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>IL_0000: <span style="color:#a6e22e">ldarg.0</span> <span style="color:#75715e">// Loads first argument on the stack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>IL_0001: <span style="color:#a6e22e">brtrue</span> <span style="color:#66d9ef">IL_0005</span> <span style="color:#75715e">// Jumps to IL_0005 if true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>IL_0002: <span style="color:#a6e22e">ldc.i4</span> <span style="color:#ae81ff">42</span> <span style="color:#75715e">// Loads the value 42 on the stack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>IL_0004: <span style="color:#a6e22e">br</span> <span style="color:#66d9ef">IL_0008</span>  <span style="color:#75715e">// Jumps to the end
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>IL_0005: <span style="color:#a6e22e">ldarg.1</span> <span style="color:#75715e">// Loads the second argument on the stack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>IL_0006: <span style="color:#a6e22e">ldc.i4</span> <span style="color:#ae81ff">42</span> <span style="color:#75715e">// Loads the value 42 on the stack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>IL_0007: <span style="color:#a6e22e">add</span> <span style="color:#75715e">// Adds the two values
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>IL_0008: <span style="color:#a6e22e">ret</span> <span style="color:#75715e">// End of the method
</span></span></span></code></pre></div><p>In C#, the method could be translated to:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> SomeMethod(<span style="color:#66d9ef">bool</span> addValue, <span style="color:#66d9ef">int</span> <span style="color:#66d9ef">value</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (addValue)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">value</span> + <span style="color:#ae81ff">42</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">42</span>;
</span></span><span style="display:flex;"><span>    }	
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If we run a flow analysis, we&rsquo;ll see that either of two branches can be executed.</p>
<ul>
<li>If <code>addValue</code> is true, then we&rsquo;ll compute <code>value + 42</code>. At the IL level, we use up to 2 slots on the stack:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">ldarg.0</span> <span style="color:#75715e">// stack = 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">brtrue</span> <span style="color:#66d9ef">IL_0005</span> <span style="color:#75715e">// stack = 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">ldarg.1</span> <span style="color:#75715e">// stack = 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">ldc.i4</span> <span style="color:#ae81ff">42</span> <span style="color:#75715e">// stack = 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">add</span> <span style="color:#75715e">// stack = 1
</span></span></span></code></pre></div><ul>
<li>If <code>addValue</code> is false, then we&rsquo;ll directly return <code>42</code> . At the IL level, we use up to 1 slot on the stack:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">ldarg.0</span> <span style="color:#75715e">// stack = 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">brtrue</span> <span style="color:#66d9ef">IL_0005</span> <span style="color:#75715e">// stack = 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">ldc.i4</span> <span style="color:#ae81ff">42</span> <span style="color:#75715e">// stack = 1
</span></span></span></code></pre></div><p>With this flow analysis, we can conclude that <code>maxstack</code> should be set to 2. However, the worst-case analysis performed by the rewriter will just sum up all the instructions that update the stack, with no respect to the flow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">ldarg.0</span> <span style="color:#75715e">// stack = 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">ldc.i4</span> <span style="color:#ae81ff">42</span> <span style="color:#75715e">// stack = 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">ldarg.1</span> <span style="color:#75715e">// stack = 3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">ldc.i4</span> <span style="color:#ae81ff">42</span> <span style="color:#75715e">// stack = 4
</span></span></span></code></pre></div><p>In this example, the rewriter concludes that <code>maxstack</code> should be set to 4.</p>
<p>This means that we grossly overestimate the value of <code>maxstack</code>. This could have some performance implications (surprisingly, I found no source explaining what the effects of a big <code>maxstack</code> would be. This could be the subject of a future article), but it shouldn&rsquo;t cause any error. Plus we&rsquo;ve seen that in the memory dump we end up with a value smaller than it should be (2 instead of 4), not bigger.</p>
<p>I then suspected an overflow, but <code>maxstack</code> is coded on 2 bytes, and so has a maximum value of 65535. In my tests, we computed a value of up to 350, impressive but very far from overflowing.</p>
<p>There was still something missing in the equation. Tony ran into <a href="https://social.msdn.microsoft.com/Forums/sqlserver/en-US/5003f5f0-696f-4357-83fd-370b424658ab/invalid-il-program-detected-in-event-log-net-profiler?forum=clr&amp;WT.mc_id=DT-MVP-5003493">this forum thread</a> which gave us the final piece.</p>
<p>Remember when I explained that the IL rewriter disassembles the instructions into a tree structure? There&rsquo;s a quirk to it. There are 294 IL opcodes defined, all of them with fixed size. All of them except one: <a href="https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes.switch?view=netcore-3.1&amp;WT.mc_id=DT-MVP-5003493"><code>switch</code></a>. <code>switch</code> has a variable size, depending on the number of branches in the switch block. Now imagine you were defining a data structure to store those 294 opcodes. A fixed-size structure would work for all of them except one. Are you going to rethink your structure just for that one case, or find some clever trick? The original author of the IL rewriter chose the latter, and introduced a fictional opcode: <code>switch_arg</code>. Thanks to that, the switch block can be disassembled into a fixed-size <code>switch</code> instruction followed by an arbitrary number of <code>switch_arg</code> instructions. Then everything is stitched back together when re-assembling the method.</p>
<p>How does that impact us? As I mentioned before, to compute <code>maxstack</code>, the rewriter uses a table that associates instructions to their effect on the stack. That table is defined as an array, mapping the index of the opcode to a value (1 or 0). That value is used to increment <code>maxstack</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">AdjustState</span>(ILInstr <span style="color:#f92672">*</span> pNewInstr)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        m_maxStack <span style="color:#f92672">+=</span> k_rgnStackPushes[pNewInstr<span style="color:#f92672">-&gt;</span>m_opcode];
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p><code>k_rgnStackPushes</code> is the table. <code>AdjustState</code> is called for every IL instruction in the method.</p>
<p>The <code>k_rgnStackPushes</code> array is automatically populated from the <a href="https://github.com/dotnet/runtime/blob/master/src/coreclr/src/inc/opcode.def"><code>opcode.def</code></a> file provided by Microsoft (see the &ldquo;stack behavior&rdquo; columns), using some macros. See the problem yet? Since <code>switch_arg</code> is a fictional opcode, it is not defined in the official list provided by Microsoft, and the IL rewriter author forgot to take that into account. We end up with a table of 294 elements, but we manipulate 295 different opcodes. Whenever we try to increment <code>maxstack</code> for the 295th opcode, we read a value outside of the array and all bets are off.</p>
<p>This is fine most of the time: it means that the <code>maxstack</code> value that we compute is complete garbage, but we always overestimate it… Unless the garbage value is big enough to cause an overflow.</p>
<p>I wanted that ultimate confirmation of what was happening, so I decided to check the memory dump to see what was the value just outside of the array.</p>
<p>To do so, I started by locating the array in our symbols:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ nm -C Datadog.Trace.ClrProfiler.Native.so  | grep k_rgnStackPushes
</span></span><span style="display:flex;"><span>0000000000472e60 d k_rgnStackPushes
</span></span></code></pre></div><p>Then I used LLDB to get the base address of the module:</p>
<pre tabindex="0"><code>(lldb) image dump sections Datadog.Trace.ClrProfiler.Native.so

Sections for &#39;/opt/datadog/Datadog.Trace.ClrProfiler.Native.so&#39; (x86_64):
  SectID     Type             Load Address                             Perm File Off.  File Size  Flags      Section Name
  ---------- ---------------- ---------------------------------------  ---- ---------- ---------- ---------- ----------------------------
  0xffffffffffffffff container        [0x00007fcf8629c000-0x00007fcf864fc3cd)  r-x  0x00000000 0x002603cd 0x00000000 Datadog.Trace.ClrProfiler.Native.so.PT_LOAD[0]
[...]
</code></pre><p>This told me that the module was mapped at the address <code>0x00007fcf8629c000</code>. I then added the offset of the array found in the symbols to compute the final address: <code>0x00007fcf8629c000 + 0x472e60 = 0x7fcf8670ee60</code></p>
<p>I dumped a few bytes to be sure, and as expected found a sequence of 0 and 1:</p>
<pre tabindex="0"><code>(lldb) memory read --count 4 --size 4 --format x 0x7fcf8670ee60
0x7fcf8670ee60: 0x00000000 0x00000000 0x00000001 0x00000001
</code></pre><p>I then dumped 295 elements to find the garbage value:</p>
<pre tabindex="0"><code>(lldb) memory read --count 295 --size 4 --force --format x 0x7fcf8670ee60
0x7fcf8670ee60: 0x00000000 0x00000000 0x00000001 0x00000001
[...]
0x7fcf8670f2e0: 0x00000000 0x00000000 0x00000000 0x00000000
0x7fcf8670f2f0: 0x00000000 0x00000000 0x866fe7a0
</code></pre><p><code>0x866fe7a0</code>! That was more than enough to overflow the 2-bytes <code>maxstack</code>.</p>
<p>After identifying the issue, the fix was disappointingly simple. We just had to <a href="https://github.com/DataDog/dd-trace-dotnet/pull/875/files">add the missing value to the <code>k_rgnStackPushes</code> array</a>.</p>
<p>… A two lines patch to conclude one week of investigation.</p>
<h1 id="wrapping-things-up">Wrapping things up</h1>
<p>That investigation was a good reminder of some key debugging principles I learned through the years:</p>
<ul>
<li>
<p>Debugging is a creative process. Every problem is unique, you won&rsquo;t find step-by-step instructions to debug your exact case. This means you&rsquo;ll often get stuck, expect it and don&rsquo;t lose hope.</p>
</li>
<li>
<p>If your debugging tools don&rsquo;t have a command to get that you need, it doesn&rsquo;t mean you have to give up. There are probably other means to get the information you seek, as long as you&rsquo;re not afraid of digging into the lower layers of abstraction.</p>
</li>
<li>
<p>When you&rsquo;re out of ideas, find a coworker and explain your understanding of the situation. It&rsquo;s very likely that they&rsquo;ll come with a different angle, giving you new things to try.</p>
</li>
</ul>

              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/dotnet/">dotnet</a>

  <a class="tag tag--primary tag--small" href="/tags/debugging/">debugging</a>

  <a class="tag tag--primary tag--small" href="/tags/lldb/">lldb</a>

  <a class="tag tag--primary tag--small" href="/tags/windbg/">windbg</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a/" data-tooltip="AccessViolation in ObjectNative::IsLockHeld (part 1 of 2)" aria-label="NEXT: AccessViolation in ObjectNative::IsLockHeld (part 1 of 2)">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4/" data-tooltip="Investigating an InvalidProgramException from a memory dump (part 2 of 3)" aria-label="PREVIOUS: Investigating an InvalidProgramException from a memory dump (part 2 of 3)">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            

<link href="https://fonts.googleapis.com/css?family=Cookie&amp;display=swap" rel="stylesheet">
<div class="bmc-btn-container"><a class="bmc-btn" target="_blank" href="https://buymeacoffee.com/kevingosse">☕<span class="bmc-btn-text">Enjoyed the article? Buy me a coffee</span></a></div>

<style>
    .bmc-btn {
        min-width: 210px;
        color: #000000;
        background-color: #FFFFFF !important;
        height: 60px;
        border-radius: 12px;
        font-size: 28px;
        font-weight: Normal;
        border: none;
        line-height: 27px;
        text-decoration: none !important;
        display: inline-flex !important;
        justify-content: center;
        align-items: center;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
    }

    .bmc-btn:hover, .bmc-btn:active, .bmc-btn:focus {
        text-decoration: none !important;
        cursor: pointer;
    }

    .bmc-btn-text {
        margin-left: 8px;
        display: inline-block;
        line-height: 0;
        width: 100%;
        flex-shrink: 0;
        font-family: [FONT] !important;
    }

    .logo-outline {
        fill: #000000;
    }

    .logo-coffee {
        fill: #ffffff;
    }</style>

  
<div id="utterances">
      <noscript>Please enable JavaScript to view the comments powered by Utterances.</noscript>
    </div>
<script src="https://utteranc.es/client.js"
        repo="kevingosse/kevingosse.github.io"
        issue-term="title"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2024 Kevin Gosse. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a/" data-tooltip="AccessViolation in ObjectNative::IsLockHeld (part 1 of 2)" aria-label="NEXT: AccessViolation in ObjectNative::IsLockHeld (part 1 of 2)">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4/" data-tooltip="Investigating an InvalidProgramException from a memory dump (part 2 of 3)" aria-label="PREVIOUS: Investigating an InvalidProgramException from a memory dump (part 2 of 3)">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="2">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fminidump.net%2Finvestigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1%2F" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https%3A%2F%2Fminidump.net%2Finvestigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1%2F" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i><span>Share on Linkedin</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.reddit.com/submit?url=https%3A%2F%2Fminidump.net%2Finvestigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1%2F" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i><span>Share on Reddit</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fminidump.net%2Finvestigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1%2F" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i><span>Share on Hacker News</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>


    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Kevin Gosse</h4>
    
      <div id="about-card-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</div>
    
    
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://minidump.net/images/code.png');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://minidump.net/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

