<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <script type="application/ld+json">

{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Dumping stack objects with ClrMD",
  
  "image": "https://minidump.net/images/dumping-stack-objects-with-clrmd-c002dab4651b-1.webp",
  
  "datePublished": "2019-12-18T00:00:00Z",
  "dateModified": "2019-12-18T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Kevin Gosse",
    
    "image": "https://minidump.net/images/profile.png"
    
  },
  "mainEntityOfPage": { 
    "@type": "WebPage",
    "@id": "https:\/\/minidump.net\/dumping-stack-objects-with-clrmd-c002dab4651b\/" 
  },
  "publisher": {
    "@type": "Organization",
    "name": "minidump.net",
    
    "logo": {
      "@type": "ImageObject",
      "url": "https://minidump.net/images/profile.png"
    }
    
  },
  "description": "How to implement the WinDbg DumpStackObjects command in ClrMD.",
  "keywords": []
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.121.1 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="Kevin Gosse">
<meta name="keywords" content="">
<meta name="description" content="How to implement the WinDbg DumpStackObjects command in ClrMD.">


<meta property="og:description" content="How to implement the WinDbg DumpStackObjects command in ClrMD.">
<meta property="og:type" content="article">
<meta property="og:title" content="Dumping stack objects with ClrMD">
<meta name="twitter:title" content="Dumping stack objects with ClrMD">
<meta property="og:url" content="https://minidump.net/dumping-stack-objects-with-clrmd-c002dab4651b/">
<meta property="twitter:url" content="https://minidump.net/dumping-stack-objects-with-clrmd-c002dab4651b/">
<meta property="og:site_name" content="minidump.net">
<meta property="og:description" content="How to implement the WinDbg DumpStackObjects command in ClrMD.">
<meta name="twitter:description" content="How to implement the WinDbg DumpStackObjects command in ClrMD.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2019-12-18T00:00:00">
  
  
    <meta property="article:modified_time" content="2019-12-18T00:00:00">
  
  
  
  
    
      <meta property="article:tag" content="dotnet">
    
      <meta property="article:tag" content="clrmd">
    
      <meta property="article:tag" content="debugging">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@kookiz">


  <meta name="twitter:creator" content="@kookiz">






  <meta property="og:image" content="https://minidump.net/images/profile.png">
  <meta property="twitter:image" content="https://minidump.net/images/profile.png">





  <meta property="og:image" content="https://minidump.net/images/dumping-stack-objects-with-clrmd-c002dab4651b-1.webp">
  <meta property="twitter:image" content="https://minidump.net/images/dumping-stack-objects-with-clrmd-c002dab4651b-1.webp">


    <title>Dumping stack objects with ClrMD</title>

    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    

    

    <link rel="canonical" href="https://minidump.net/dumping-stack-objects-with-clrmd-c002dab4651b/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://minidump.net/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MQCXFBVCCM"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-MQCXFBVCCM', { 'anonymize_ip': false });
}
</script>

    
    <script>
    (function(h,o,u,n,d) {
      h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}}
      d=o.createElement(u);d.async=1;d.src=n
      n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n)
    })(window,document,'script','https://www.datadoghq-browser-agent.com/us1/v5/datadog-rum.js','DD_RUM')
    window.DD_RUM.onReady(function() {
      window.DD_RUM.init({
        clientToken: 'pubabeb7320d5ecb81f3b14a17c35c1a3de',
        applicationId: '78b5d24e-77d4-4bba-ae37-5a46f7386b95',
        site: 'datadoghq.com',
        service: 'minidump.net',
        env: 'kevin',
        sessionSampleRate: 100,
        sessionReplaySampleRate: 20,
        trackUserInteractions: true,
        trackResources: true,
        trackLongTasks: true,
        defaultPrivacyLevel: 'mask-user-input',
      });
    })
</script>
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/" aria-label="Go to homepage">minidump.net</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about" aria-label="Read more about the author">
          <img class="sidebar-profile-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Kevin Gosse</h4>
        
          <h5 class="sidebar-profile-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/kookiz" target="_blank" rel="noopener" title="Twitter">
    
      <i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/kevingosse" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.buymeacoffee.com/kevingosse" target="_blank" rel="noopener" title="Buy me a coffee">
    
      <i class="sidebar-button-icon fas fa-lg fa-coffee" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Buy me a coffee</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      Dumping stack objects with ClrMD
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2019-12-18T00:00:00Z">
        
  
  
  
  
    December 18 2019
  

      </time>
    
    
  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>The SOS extension for WinDbg defines a command, <code>!DumpStackObjects</code> (or <code>!dso</code>), that allows to list all the references on the stack for a given thread. It&rsquo;s convenient to retrieve the value of arguments or local variables of methods in the callstack. Recently, for an investigation, I ran across the need to dump those values for a few thousand threads. Obviously this is not something you&rsquo;d want to do by hand, so I checked what was possible to do with ClrMD.</p>
<p>ClrMD defines an <code>EnumerateStackObjects</code> method on the <code>ClrThread</code> object, which seems to do exactly what&rsquo;s needed. To make sure, we can write this small program and compare the output with the !DumpStackObjects command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Linq;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Microsoft.Diagnostics.Runtime;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> DumpStackObjects
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> target = DataTarget.LoadCrashDump(<span style="color:#e6db74">@&#34;E:\CoreConsoleApp1.dmp&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> runtime = target.ClrVersions[<span style="color:#ae81ff">0</span>].CreateRuntime();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> thread = runtime.Threads.First(t =&gt; t.ManagedThreadId == <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> reference <span style="color:#66d9ef">in</span> thread.EnumerateStackObjects())
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                Console.WriteLine(<span style="color:#e6db74">$&#34;{reference.Address:x16} {reference.Object:x16} {reference.Type.Name}&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s see what&rsquo;s going on here. <code>EnumerateStackObjects</code> returns a list of <code>ClrRoot</code> instances. Those instances represent references. The <code>Address</code> field contains the address of the reference <strong>on the stack</strong>, whereas the <code>Object</code> field contains the address of the object the reference is pointing to (the value you&rsquo;re likely interested in). If we compare the output of our program with WinDbg, it seems indeed to match:</p>


 
  
  
  
  
    
  

<div class="figure " >
  
    <a class="fancybox" href="/images/dumping-stack-objects-with-clrmd-c002dab4651b-1.webp" title="ClrMD on the left, WinDbg/SOS on the right" data-fancybox="">
  
    <img class="fig-img" src="/images/dumping-stack-objects-with-clrmd-c002dab4651b-1.webp"  alt="ClrMD on the left, WinDbg/SOS on the right">
  
    </a>
  
   
    <span class="caption">ClrMD on the left, WinDbg/SOS on the right</span>
  
</div>

<p>That is… on Windows. For my investigation, I needed to do the same thing with a Linux coredump. ClrMD is compatible with Linux, so it shouldn&rsquo;t be a problem, or so I thought. But when I ran the same code on Linux, no stack objects were found.</p>


 
  
  
  
  
    
  

<div class="figure " >
  
    <a class="fancybox" href="/images/dumping-stack-objects-with-clrmd-c002dab4651b-2.webp" title="LLDB/SOS on the left, ClrMD on the right" data-fancybox="">
  
    <img class="fig-img" src="/images/dumping-stack-objects-with-clrmd-c002dab4651b-2.webp"  alt="LLDB/SOS on the left, ClrMD on the right">
  
    </a>
  
   
    <span class="caption">LLDB/SOS on the left, ClrMD on the right</span>
  
</div>

<p>Digging into the <code>EnumerateStackObjects</code> implementation, it seems that it gets the address range of the stack by inspecting <code>ClrThread.StackBase</code> and <code>ClrThread.StackLimit</code>, then checks every value in that range to find references. In my case, <code>StackBase</code> and <code>StackLimit</code> both returned 0, so it makes sense that the algorithm would then fail to find anything. So how are <code>StackBase</code> and <code>StackLimit</code> implemented?</p>
<p>In ClrMD, <code>StackBase</code> and <code>StackLimit</code> are read from the <a href="https://en.wikipedia.org/wiki/Win32_Thread_Information_Block">thread environment block (TEB)</a>. The contents of the TEB are retrieved directly from the DAC using the <code>GetThreadData</code> method. If we look at <a href="https://github.com/dotnet/coreclr/blob/d2a8b55d4c944438df1599c9a78262bc48f07266/src/debug/daccess/request.cpp#L752">the implementation of that function in the CoreCLR repository</a>, the problem becomes quite obvious:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">#ifndef FEATURE_PAL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    threadData<span style="color:#f92672">-&gt;</span>teb <span style="color:#f92672">=</span> TO_CDADDR(<span style="color:#66d9ef">thread</span><span style="color:#f92672">-&gt;</span>m_pTEB);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    threadData<span style="color:#f92672">-&gt;</span>teb <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><p><code>FEATURE_PAL</code> is defined on all other platforms than Windows. It means that when running .net core on Linux, the TEB information of the thread will be empty. It actually makes sense since TEB is a Windows concept, but then how is the SOS DumpStackObjects function working on Linux?</p>
<p>This time, the answer lies <a href="https://github.com/dotnet/diagnostics/blob/367aa5cd433e5e5a9e128aee5acb8196231ac769/src/SOS/Strike/strike.cpp#L616">in the dotnet/diagnostics repository</a>. Here is a stripped down version with only the interesting bits:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>HRESULT <span style="color:#a6e22e">DumpStackObjectsRaw</span>(size_t nArg, __in_z LPSTR exprBottom, __in_z LPSTR exprTop, BOOL bVerify)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    size_t StackTop <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    size_t StackBottom <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (nArg<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        ULONG64 StackOffset;
</span></span><span style="display:flex;"><span>        g_ExtRegisters<span style="color:#f92672">-&gt;</span>GetStackOffset(<span style="color:#f92672">&amp;</span>StackOffset);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StackTop <span style="color:#f92672">=</span> TO_TADDR(StackOffset);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Additional logic to handle the arguments
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifndef FEATURE_PAL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Read StackBottom from the TEB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (StackBottom <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        StackBottom <span style="color:#f92672">=</span> StackTop <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xFFFF</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Browse the stack and retrieve the references
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>The code starts by getting the current stack pointer from the registers by calling the <code>GetStackOffset</code> method, and assigns it to <code>StackTop</code>. Then, <strong>only on Windows</strong>, it reads the TEB to get the address of the beginning the stack. For other platforms, there&rsquo;s a fallback code where <code>StackBottom</code> is initialized to <code>StackTop + 0xFFFF</code> if no value has been assigned. This hack puzzles me quite a bit. 0xFFFF (64KB) is much smaller than the default size of the stack, and at the same time I don&rsquo;t think it offers any guarantee that we won&rsquo;t read memory outside of the stack (I searched for a while but couldn&rsquo;t find any evidence that a guard page is allocated above the stack).</p>
<p>However surprising it may look, our goal is just to mimic the DumpStackObject output, so can we implement the same logic in ClrMD?</p>
<p>For that, we need a way to retrieve the value of the RSP register, to get the stack offset. This is done by calling the <code>GetThreadContext</code> method with the id of the thread. It takes as parameter a byte array (or an <code>IntPtr</code>), in which is serialized the contents of a structure representing the registers. That structure is <code>AMD64Context</code>, <code>ArmContext</code>, or <code>Arm64Context</code> depending on the target architecture. In our case, we only care about AMD64:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> bytes = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#66d9ef">sizeof</span>(AMD64Context)];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (!target.DataReader.GetThreadContext(thread.OSThreadId, <span style="color:#ae81ff">0</span>, (<span style="color:#66d9ef">uint</span>)bytes.Length, bytes))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Console.WriteLine(<span style="color:#e6db74">&#34;GetThreadContext failed&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> context = MemoryMarshal.Read&lt;AMD64Context&gt;(bytes);
</span></span></code></pre></div><p>Once we have this information, we can start browsing the stack and search for references (the code is shamelessly copied <a href="https://github.com/microsoft/dotnet-samples/blob/master/Microsoft.Diagnostics.Runtime/CLRMD/ClrStack/Program.cs#L81">from the ClrMD samples</a>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> stackTop = context.Rsp;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> stackLimit = stackTop + <span style="color:#ae81ff">0xFFFF</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">ulong</span> ptr = stackTop; ptr &lt;= stackLimit; ptr += (<span style="color:#66d9ef">ulong</span>)runtime.PointerSize)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">ulong</span> obj;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (!runtime.ReadPointer(ptr, <span style="color:#66d9ef">out</span> obj))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }       
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> type = heap.GetObjectType(obj);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (type == <span style="color:#66d9ef">null</span> || type.IsFree)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Console.WriteLine(<span style="color:#e6db74">$&#34;{ptr:x16} {obj:x16} {type.Name}&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We start by trying to dereference any value we find in the stack, then we call <code>ClrHeap.GetObjectType</code> to find if it points to a valid object. If so, we display the result to the console.</p>
<p>I tried running this code and it worked fine for a few hundred threads, then it crashed with a segmentation fault. I managed to track it down to a call to <code>ClrHeap.GetObjectType</code> with a specific address. It&rsquo;s likely that we found a pointer to a value outside of the managed heap, which is causing some unpredictable behavior. How is SOS coping with this? Looking back at <a href="https://github.com/dotnet/diagnostics/blob/master/src/SOS/Strike/util.cpp#L1988">the implementation</a>, it looks like we forgot a sanity check:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">// rule out pointers that are outside of the gc heap.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (g_snapshot.GetHeap(objAddr) <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span></code></pre></div><p>With ClrMD, we can achieve the same result by enumerating the GC segments and making sure our address is inside one of those:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> IsInHeap(ClrHeap heap, <span style="color:#66d9ef">ulong</span> obj)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> segment <span style="color:#66d9ef">in</span> heap.Segments)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (segment.Start &lt;= obj &amp;&amp; segment.End &gt; obj)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now we have everything we need to finish our implementation of DumpStackObjects for Linux:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Linq;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Runtime.InteropServices;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Microsoft.Diagnostics.Runtime;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> DumpStackObjects
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> threadId = <span style="color:#66d9ef">int</span>.Parse(args[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> target = DataTarget.LoadCoreDump(args[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> runtime = target.ClrVersions[<span style="color:#ae81ff">0</span>].CreateRuntime();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> heap = runtime.Heap;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> thread = runtime.Threads.First(t =&gt; t.ManagedThreadId == threadId);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> bytes = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#66d9ef">sizeof</span>(AMD64Context)];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (!target.DataReader.GetThreadContext(thread.OSThreadId, <span style="color:#ae81ff">0</span>, (<span style="color:#66d9ef">uint</span>)bytes.Length, bytes))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                Console.WriteLine(<span style="color:#e6db74">&#34;GetThreadContext failed&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> context = MemoryMarshal.Read&lt;AMD64Context&gt;(bytes);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> stackTop = context.Rsp;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> stackLimit = stackTop + <span style="color:#ae81ff">0xFFFF</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">ulong</span> ptr = stackTop; ptr &lt;= stackLimit; ptr += (<span style="color:#66d9ef">ulong</span>)runtime.PointerSize)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">ulong</span> obj;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (!runtime.ReadPointer(ptr, <span style="color:#66d9ef">out</span> obj))
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (!IsInHeap(heap, obj))
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">var</span> type = heap.GetObjectType(obj);
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (type == <span style="color:#66d9ef">null</span> || type.IsFree)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                Console.WriteLine(<span style="color:#e6db74">$&#34;{ptr:x16} {obj:x16} {type.Name}&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> IsInHeap(ClrHeap heap, <span style="color:#66d9ef">ulong</span> obj)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> segment <span style="color:#66d9ef">in</span> heap.Segments)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (segment.Start &lt;= obj &amp;&amp; segment.End &gt; obj)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And this time, we get the same output as the <code>!DumpStackObjects</code> command, as expected:</p>


 
  
  
  
  
    
  

<div class="figure " >
  
    <a class="fancybox" href="/images/dumping-stack-objects-with-clrmd-c002dab4651b-3.webp" data-fancybox="">
  
    <img class="fig-img" src="/images/dumping-stack-objects-with-clrmd-c002dab4651b-3.webp" >
  
    </a>
  
  
</div>


              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/dotnet/">dotnet</a>

  <a class="tag tag--primary tag--small" href="/tags/clrmd/">clrmd</a>

  <a class="tag tag--primary tag--small" href="/tags/debugging/">debugging</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/another-way-to-use-your-debugging-tools-7e7f498d7a2b/" data-tooltip="Another way to use your debugging tools" aria-label="NEXT: Another way to use your debugging tools">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/debugging-and-fixing-the-twitch-desktop-client-d1b38a349186/" data-tooltip="Debugging and fixing the Twitch desktop client" aria-label="PREVIOUS: Debugging and fixing the Twitch desktop client">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/dumping-stack-objects-with-clrmd-c002dab4651b/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/dumping-stack-objects-with-clrmd-c002dab4651b/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/dumping-stack-objects-with-clrmd-c002dab4651b/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/dumping-stack-objects-with-clrmd-c002dab4651b/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            

<link href="https://fonts.googleapis.com/css?family=Cookie&amp;display=swap" rel="stylesheet">
<div class="bmc-btn-container"><a class="bmc-btn" target="_blank" href="https://buymeacoffee.com/kevingosse">☕<span class="bmc-btn-text">Enjoyed the article? Buy me a coffee</span></a></div>

<style>
    .bmc-btn {
        min-width: 210px;
        color: #000000;
        background-color: #FFFFFF !important;
        height: 60px;
        border-radius: 12px;
        font-size: 28px;
        font-weight: Normal;
        border: none;
        line-height: 27px;
        text-decoration: none !important;
        display: inline-flex !important;
        justify-content: center;
        align-items: center;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
    }

    .bmc-btn:hover, .bmc-btn:active, .bmc-btn:focus {
        text-decoration: none !important;
        cursor: pointer;
    }

    .bmc-btn-text {
        margin-left: 8px;
        display: inline-block;
        line-height: 0;
        width: 100%;
        flex-shrink: 0;
        font-family: [FONT] !important;
    }

    .logo-outline {
        fill: #000000;
    }

    .logo-coffee {
        fill: #ffffff;
    }</style>

  
<div id="utterances">
      <noscript>Please enable JavaScript to view the comments powered by Utterances.</noscript>
    </div>
<script src="https://utteranc.es/client.js"
        repo="kevingosse/kevingosse.github.io"
        issue-term="title"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2024 Kevin Gosse. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/another-way-to-use-your-debugging-tools-7e7f498d7a2b/" data-tooltip="Another way to use your debugging tools" aria-label="NEXT: Another way to use your debugging tools">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/debugging-and-fixing-the-twitch-desktop-client-d1b38a349186/" data-tooltip="Debugging and fixing the Twitch desktop client" aria-label="PREVIOUS: Debugging and fixing the Twitch desktop client">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/dumping-stack-objects-with-clrmd-c002dab4651b/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/dumping-stack-objects-with-clrmd-c002dab4651b/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/dumping-stack-objects-with-clrmd-c002dab4651b/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/dumping-stack-objects-with-clrmd-c002dab4651b/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="2">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fminidump.net%2Fdumping-stack-objects-with-clrmd-c002dab4651b%2F" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https%3A%2F%2Fminidump.net%2Fdumping-stack-objects-with-clrmd-c002dab4651b%2F" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i><span>Share on Linkedin</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.reddit.com/submit?url=https%3A%2F%2Fminidump.net%2Fdumping-stack-objects-with-clrmd-c002dab4651b%2F" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i><span>Share on Reddit</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fminidump.net%2Fdumping-stack-objects-with-clrmd-c002dab4651b%2F" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i><span>Share on Hacker News</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>


    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Kevin Gosse</h4>
    
      <div id="about-card-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</div>
    
    
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://minidump.net/images/code.png');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://minidump.net/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

