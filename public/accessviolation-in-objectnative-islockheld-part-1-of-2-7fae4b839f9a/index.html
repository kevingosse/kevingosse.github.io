<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <script type="application/ld+json">

{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "AccessViolation in ObjectNative::IsLockHeld (part 1 of 2)",
  
  "image": "https://minidump.net/images/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a-3.webp",
  
  "datePublished": "2020-11-05T00:00:00Z",
  "dateModified": "2020-11-05T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Kevin Gosse",
    
    "image": "https://minidump.net/images/profile.png"
    
  },
  "mainEntityOfPage": { 
    "@type": "WebPage",
    "@id": "https:\/\/minidump.net\/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a\/" 
  },
  "publisher": {
    "@type": "Organization",
    "name": "minidump.net",
    
    "logo": {
      "@type": "ImageObject",
      "url": "https://minidump.net/images/profile.png"
    }
    
  },
  "description": "Investigating a crash in a .NET application, caused by an AccessViolationException when inspecting the state of a lock.",
  "keywords": []
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.121.1 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="Kevin Gosse">
<meta name="keywords" content="">
<meta name="description" content="Investigating a crash in a .NET application, caused by an AccessViolationException when inspecting the state of a lock.">


<meta property="og:description" content="Investigating a crash in a .NET application, caused by an AccessViolationException when inspecting the state of a lock.">
<meta property="og:type" content="article">
<meta property="og:title" content="AccessViolation in ObjectNative::IsLockHeld (part 1 of 2)">
<meta name="twitter:title" content="AccessViolation in ObjectNative::IsLockHeld (part 1 of 2)">
<meta property="og:url" content="https://minidump.net/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a/">
<meta property="twitter:url" content="https://minidump.net/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a/">
<meta property="og:site_name" content="minidump.net">
<meta property="og:description" content="Investigating a crash in a .NET application, caused by an AccessViolationException when inspecting the state of a lock.">
<meta name="twitter:description" content="Investigating a crash in a .NET application, caused by an AccessViolationException when inspecting the state of a lock.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2020-11-05T00:00:00">
  
  
    <meta property="article:modified_time" content="2020-11-05T00:00:00">
  
  
  
  
    
      <meta property="article:tag" content="dotnet">
    
      <meta property="article:tag" content="debugging">
    
      <meta property="article:tag" content="cpp">
    
      <meta property="article:tag" content="windbg">
    
      <meta property="article:tag" content="assembly">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@kookiz">


  <meta name="twitter:creator" content="@kookiz">






  <meta property="og:image" content="https://minidump.net/images/profile.png">
  <meta property="twitter:image" content="https://minidump.net/images/profile.png">





  <meta property="og:image" content="https://minidump.net/images/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a-3.webp">
  <meta property="twitter:image" content="https://minidump.net/images/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a-3.webp">


    <title>AccessViolation in ObjectNative::IsLockHeld (part 1 of 2)</title>

    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    

    

    <link rel="canonical" href="https://minidump.net/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://minidump.net/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    <script>
    (function(h,o,u,n,d) {
      h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}}
      d=o.createElement(u);d.async=1;d.src=n
      n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n)
    })(window,document,'script','https://www.datadoghq-browser-agent.com/us1/v5/datadog-rum.js','DD_RUM')
    window.DD_RUM.onReady(function() {
      window.DD_RUM.init({
        clientToken: 'pubabeb7320d5ecb81f3b14a17c35c1a3de',
        applicationId: '78b5d24e-77d4-4bba-ae37-5a46f7386b95',
        site: 'datadoghq.com',
        service: 'minidump.net',
        env: 'kevin',
        sessionSampleRate: 100,
        sessionReplaySampleRate: 20,
        trackUserInteractions: true,
        trackResources: true,
        trackLongTasks: true,
        defaultPrivacyLevel: 'mask-user-input',
      });
    })
</script>
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/" aria-label="Go to homepage">minidump.net</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about" aria-label="Read more about the author">
          <img class="sidebar-profile-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Kevin Gosse</h4>
        
          <h5 class="sidebar-profile-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/kookiz" target="_blank" rel="noopener" title="Twitter">
    
      <i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/kevingosse" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.buymeacoffee.com/kevingosse" target="_blank" rel="noopener" title="Buy me a coffee">
    
      <i class="sidebar-button-icon fas fa-lg fa-coffee" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Buy me a coffee</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      AccessViolation in ObjectNative::IsLockHeld (part 1 of 2)
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2020-11-05T00:00:00Z">
        
  
  
  
  
    November 05 2020
  

      </time>
    
    
  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p><em>This is a two parts article. <a href="/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c">Part two is available here</a>.</em></p>
<h1 id="symptoms">Symptoms</h1>
<p>To monitor the stability of the Datadog .NET tracer, we have a reliability environment where we continuously run mainstream applications such as <a href="https://github.com/OrchardCMS/Orchard">Orchard</a>. This story starts when, while preparing a release, we discovered that the latest version of our tracer was crashing the app with the message:</p>
<blockquote>
<p>Application: w3wp.exe
Framework Version: v4.0.30319
Description: The process was terminated due to an internal error in the .NET Runtime at IP 00007FFB62CB0A8D (00007FFB625B0000) with exit code 80131506.</p>
</blockquote>
<p>A look at the reliability monitor showed that the app was crashing once or twice per day:</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a-1.webp" title="Not something you like to see before a release" data-fancybox="">
  
    <img class="fig-img" src="/images/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a-1.webp"  alt="Not something you like to see before a release">
  
    </a>
  
   
    <span class="caption">Not something you like to see before a release</span>
  
</div>

<p>Unfortunately I couldn&rsquo;t tell much from the error message. You can&rsquo;t normally cause this kind of crash from managed code (unless of course you use <code>unsafe</code>), so I scanned the changes we made to our native libraries and found nothing suspicious. As there wasn&rsquo;t anything more I could do, I configured the server <a href="https://docs.microsoft.com/en-us/windows/win32/wer/collecting-user-mode-dumps?WT.mc_id=DT-MVP-5003493">to capture a memory dump at next crash</a>, and waited.</p>
<p>Thankfully the app crashed again during the night, and I could start my analysis in the morning.</p>
<h1 id="into-the-crash-dump">Into the crash dump</h1>
<p>Just by opening the dump, WinDbg gives a bit more information about the error:</p>
<pre tabindex="0"><code>This dump file has an exception of interest stored in it.
The stored exception information can be accessed via .ecxr.
(13c0.16f0): Access violation - code c0000005 (first/second chance not available)
For analysis of this file, run !analyze -v
clr!ObjectNative::IsLockHeld+0x4d:
00007ffb`62cb0a8d 8b592c          mov     ebx,dword ptr [rcx+2Ch] ds:00000000`0000002b=????????
</code></pre><p>The error tells us two thing: the issue occurred in <code>clr!ObjectNative::IsLockHeld</code>, and we tried to read the memory at address <code>0x2B</code>. <code>0x2B</code> is clearly not a valid address, and it looks like an &ldquo;actual&rdquo; value rather than something random. I tried running <code>!clrstack</code> to get the managed stacktrace, but the command was not working. At this point I started suspecting that something overwrote values on the stack, causing the crash.</p>
<p>Getting the native stacktrace worked, but it only gave me addresses for the managed frames:</p>
<pre tabindex="0"><code>0:045&gt; k
 # Child-SP          RetAddr               Call Site
00 000000d9`67bfdca0 00007ffb`064c776f     clr!ObjectNative::IsLockHeld+0x4d
01 000000d9`67bfdcd0 00007ffb`064c771a     0x00007ffb`064c776f
02 000000d9`67bfdd00 00007ffb`059d6983     0x00007ffb`064c771a
03 000000d9`67bfdd30 00007ffb`059d6842     0x00007ffb`059d6983
04 000000d9`67bfdd80 00007ffb`059d68cc     0x00007ffb`059d6842
05 000000d9`67bfddb0 00007ffb`059d6842     0x00007ffb`059d68cc
06 000000d9`67bfde00 00007ffb`05a1d031     0x00007ffb`059d6842
07 000000d9`67bfde30 00007ffb`05a1cfbf     0x00007ffb`05a1d031
08 000000d9`67bfde90 00007ffb`0388f1bf     0x00007ffb`05a1cfbf
09 000000d9`67bfdf00 00007ffb`0388dd34     0x00007ffb`0388f1bf
0a 000000d9`67bfdfd0 00007ffb`03acd942     0x00007ffb`0388dd34
0b 000000d9`67bfe000 00007ffb`0676e69c     0x00007ffb`03acd942
0c 000000d9`67bfe050 00007ffb`03a82752     0x00007ffb`0676e69c
0d 000000d9`67bfe0b0 00007ffb`03c9deb5     0x00007ffb`03a82752
[...]
45 000000d9`67bff8c0 00007ffb`707084d4     clr!Thread::intermediateThreadProc+0x86
46 000000d9`67bffe00 00007ffb`7081e871     kernel32!BaseThreadInitThunk+0x14
47 000000d9`67bffe30 00000000`00000000     ntdll!RtlUserThreadStart+0x21
</code></pre><p>Fortunately, I could resolve them with the <code>ip2md</code> command:</p>
<pre tabindex="0"><code>0:045&gt; !ip2md 0x00007ffb`064c776f
MethodDesc:   00007ffb05c99698
Method Name:  Orchard.OutputCache.Filters.OutputCacheFilter.Dispose(Boolean)
Class:        00007ffb05ca3f18
MethodTable:  00007ffb05c996f8
mdToken:      000000000600013e
Module:       00007ffb05c58508
IsJitted:     yes
CodeAddr:     00007ffb064c7750
Transparency: Critical
</code></pre><p>By checking the <a href="https://github.com/OrchardCMS/Orchard/blob/dev/src/Orchard.Web/Modules/Orchard.OutputCache/Filters/OutputCacheFilter.cs#L662">Orchard source code</a>, we can confirm that <code>OutputCacheFilter.Dispose</code> indeed calls <code>Monitor.IsEntered</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> Dispose(<span style="color:#66d9ef">bool</span> disposing) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (!_isDisposed) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (disposing) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Free other state (managed objects).</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (_cacheKey != <span style="color:#66d9ef">null</span> &amp;&amp; Monitor.IsEntered(_cacheKey)) {
</span></span><span style="display:flex;"><span>            Monitor.Exit(_cacheKey);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        _isDisposed = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It sounds reasonable to assume that <code>Monitor.IsEntered</code> is going to call <code>ObjectNative::IsLockHeld</code> , but just for the sake of it we can confirm it.
First, <a href="https://referencesource.microsoft.com/#mscorlib/system/threading/monitor.cs,414e36aeee566e2c">the source code of the BCL on .NET Framework</a> shows that <code>Monitor.IsEntered</code> calls <code>Monitor.IsEnteredNative</code> , which is implemented in the CLR. Unfortunately we don&rsquo;t have the code of the .NET Framework CLR, but the .NET Core one is usually close enough. And indeed, we can see that <a href="https://github.com/dotnet/runtime/blob/ae47aa26544227ef632598d91a798b8f83d56634/src/coreclr/src/vm/ecalllist.h#L872"><code>Monitor.IsEnteredNative</code> is mapped to <code>ObjectNative::IsLockHeld</code></a> , as expected:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>FCFuncElement(<span style="color:#e6db74">&#34;IsEnteredNative&#34;</span>, ObjectNative<span style="color:#f92672">::</span>IsLockHeld)
</span></span></code></pre></div><p>Looking further at the Orchard code, I could see that the <code>OutputCacheFilter</code> is locking on an interned string. That&rsquo;s a dangerous pattern, but not necessarily wrong. I suppose they did that as a cheap way of ensuring all instances share the same locks.</p>
<p>Where to look next? I wanted to check the instance of string that was given to <code>Monitor.IsEntered</code> , to see if there was anything suspicious about it, but I couldn&rsquo;t find it on the stack. So I focused instead on the native code.</p>
<p>The error occurred when executing the instruction <code>mov ebx,dword ptr [rcx+2Ch]</code>, meaning: &ldquo;read the memory at the address <code>rcx+0x2C</code>, and store it in <code>ebx</code>&rdquo;. I used the WinDbg Registers window to check the value of the registers at the time of the error:</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a-2.webp" data-fancybox="">
  
    <img class="fig-img" src="/images/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a-2.webp" >
  
    </a>
  
  
</div>

<p>The value of <code>rcx</code> was <code>0xffffffffffffffff</code> (that is, -1). This explained where the <code>0x2B</code> came from: <code>rcx + 2C = -1 + 2C = 2B</code> . <code>2C</code> was probably the offset of a field in an object, so it looked like the address of that object was wrong.</p>
<p>I then decided to check where the value in <code>rcx</code> came from. The disassembly window of WinDbg shows the assembly code near the exception:</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a-3.webp" data-fancybox="">
  
    <img class="fig-img" src="/images/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a-3.webp" >
  
    </a>
  
  
</div>

<p><code>rcx</code> was written for the last time by the instruction <code>mov rcx, qword ptr [rdx+8]</code>, with <code>rdx</code> having a value of <code>0x0000029704f50208</code>. It looked like an address, so I tried to figure out what kind. The value of the stack pointer register, <code>rsp</code> , was <code>0x000000d967bfdca0</code>, so definitely not a stack address. The managed heap maybe? The command <code>!eeheap -gc</code> gives the range of all the GC segments, and allowed me to confirm that <code>0x0000029704f50208</code> was not on the managed heap either.</p>
<p>At this point, I decided to take a step back. <code>IsLockHeld</code> takes only one parameter: the object used for locking. Therefore, I could think of only 3 possibilities to explain the error:</p>
<ul>
<li>
<p>The address of the parameter was wrong</p>
</li>
<li>
<p>The sync table was corrupted</p>
</li>
<li>
<p>The header of the object (with the index to the sync table) was corrupted</p>
</li>
</ul>
<p>Wait, what &ldquo;sync table&rdquo;? Let&rsquo;s introduce the concept for those who are not familiar with it.</p>
<h1 id="the-sync-table">The sync table</h1>
<p>Whenever you lock on an object, either by using <code>lock (obj)</code> or <code>Monitor.Enter(obj)</code> , the CLR has to keep track of what thread owns the lock in a specific data structure. As much as possible, the CLR tries to stores that information in the object header. Since the header is next to the object itself, it&rsquo;s almost guaranteed to be present in the CPU cache, which makes the lock really fast. This kind of lock is called a thin lock.</p>
<p>Unfortunately, the object header is only 4 bytes long, so the amount of data it can store is very limited. It&rsquo;s going to run out of room in two situations:</p>
<ul>
<li>
<p>When the lock is contended (e.g. if multiple threads are trying to acquire it at the same time). In this case, the runtime needs to store the list of threads waiting on the lock, to wake them up when it is released.</p>
</li>
<li>
<p>When <code>GetHashcode</code> is called on the object.</p>
</li>
</ul>
<p>Let&rsquo;s elaborate a bit on that last point. Have you ever wondered what happens when you call <code>GetHashCode</code> on an object? The runtime needs to generate a hashcode that satisfies at least two properties:</p>
<ul>
<li>
<p>The probability of another object having the same hashcode must be low</p>
</li>
<li>
<p>The hashcode of a given object must not change over time</p>
</li>
</ul>
<p>At first I thought using the address of the object would be an elegant solution, but it doesn&rsquo;t work because the address of an object can actually change (during a garbage collection). So instead the runtime just generates a random value, but since the value needs to be stable it has to be stored somewhere. And that &ldquo;somewhere&rdquo; is the object header.</p>
<p>There isn&rsquo;t enough room in the object header to store both the thin lock and the hashcode. So when the header runs out of room, the information is moved to a structure named a sync block. The address of all the sync blocks is stored in a table, named the sync block table, or sync table. And the index of the sync block in the table is stored in the object header.</p>
<p>You can find a more detailed explanation and an estimation of the performance overhead of a sync block versus a thin lock <a href="https://devblogs.microsoft.com/premier-developer/managed-object-internals-part-2-object-header-layout-and-the-cost-of-locking/?WT.mc_id=DT-MVP-5003493">in this excellent article</a>.</p>
<h1 id="back-to-the-memory-dump">Back to the memory dump</h1>
<p>Now that everybody knows what the sync table is, let&rsquo;s remind my 3 theories:</p>
<ul>
<li>
<p>The address of the parameter was wrong</p>
</li>
<li>
<p>The sync table was corrupted</p>
</li>
<li>
<p>The header of the object (with the index to the sync table) was corrupted</p>
</li>
</ul>
<p>In WinDbg, you can use the <code>!syncblk</code> command to dump all the sync blocks that contain a lock currently owned by a thread:</p>
<pre tabindex="0"><code>0:045&gt; !syncblk
Index SyncBlock MonitorHeld Recursion Owning Thread Info  SyncBlock Owner
  226 0000029703e38fa8            1         1 0000029704768650 Failed to request Thread at 0000029704768650
</code></pre><p>The <code>Failed to request Thread at 0000029704768650</code> message is very suspicious. Could it be a sign of data corruption? I decided to have a look to the full sync table, using the command <code>!syncblk -all</code> :</p>
<pre tabindex="0"><code>0:045&gt; !syncblk -all
Index SyncBlock MonitorHeld Recursion Owning Thread Info  SyncBlock Owner
    1 0000000000000000            0         0 0000000000000000     none           0 Free
    2 00000296facff698            0         0 0000000000000000     none    00000295b0301da0 System.__ComObject
    3 00000296facff6e8            0         0 0000000000000000     none    00000295b0301dd8 System.Web.Hosting.ProcessHost
    4 00000296facff738            0         0 0000000000000000     none    00000295b0307b30 Microsoft.Win32.UnsafeNativeMethods+ManifestEtw+EtwEnableCallback
[...]
  224 0000000000000000            0         0 0000000000000000     none           0 Free
  225 0000000000000000            0         0 0000000000000000     none           0 Free
  226 0000029703e38fa8            1         1 0000029704768650 Failed to request Thread at 0000029704768650
</code></pre><p>It is very suspicious that the output would stop right after the <code>Failed to request Thread</code> error. I don&rsquo;t know if it means that the table has 226 entries and there was coincidentally an error at the last one, or if the output stopped on the first error.</p>
<p>In any case, the address of the sync blocks, given in the second column, was very interesting. The last entry, <code>0x0000029703e38fa8</code> , was quite close to the value I found in the <code>rcx</code> register (<code>0x0000029704f50208</code>). The &ldquo;corrupted sync block&rdquo; theory seemed more and more plausible. But I checked the source code of <code>IsLockHeld</code> and it was only reading memory, not writing anything.</p>
<blockquote>
<p>Since the code of the .NET Framework CLR is not available, a good approximation is to look <a href="https://github.com/dotnet/coreclr/tree/ef1e2ab328087c61a6878c1e84f4fc5d710aebce">at the very first commit of the dotnet/coreclr repository</a>, before the code diverged too much.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>FCIMPL1(FC_BOOL_RET, ObjectNative<span style="color:#f92672">::</span>IsLockHeld, Object<span style="color:#f92672">*</span> pThisUNSAFE)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    FCALL_CONTRACT;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    BOOL retVal;
</span></span><span style="display:flex;"><span>    DWORD owningThreadId;
</span></span><span style="display:flex;"><span>    DWORD acquisitionCount;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// If the lock is held, check if it&#39;s held by the current thread.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    retVal <span style="color:#f92672">=</span> pThisUNSAFE<span style="color:#f92672">-&gt;</span>GetThreadOwningMonitorLock(<span style="color:#f92672">&amp;</span>owningThreadId, <span style="color:#f92672">&amp;</span>acquisitionCount);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (retVal)
</span></span><span style="display:flex;"><span>        retVal <span style="color:#f92672">=</span> GetThread()<span style="color:#f92672">-&gt;</span>GetThreadId() <span style="color:#f92672">==</span> owningThreadId;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    FC_RETURN_BOOL(retVal);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>FCIMPLEND
</span></span></code></pre></div><p>So if some value in the sync block was corrupted, it meant this happened <em>before</em> the <code>IsLockedHeld</code> method was called.</p>
<p>To get further, I needed to understand exactly what was corrupted. In other words, what was the code trying to read when it got the <code>0xffffffffffffffff</code> value?</p>
<p>Mapping the assembly code to the original C++ was going to take a lot of effort, so I decided to first wait for another occurrence of the crash to confirm that the symptoms were identical. Fortunately, a fresh new crash dump was waiting for me on the server. This will be the subject of the next part!</p>

              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/dotnet/">dotnet</a>

  <a class="tag tag--primary tag--small" href="/tags/debugging/">debugging</a>

  <a class="tag tag--primary tag--small" href="/tags/cpp/">cpp</a>

  <a class="tag tag--primary tag--small" href="/tags/windbg/">windbg</a>

  <a class="tag tag--primary tag--small" href="/tags/assembly/">assembly</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c/" data-tooltip="AccessViolation in ObjectNative::IsLockHeld (part 2 of 2)" aria-label="NEXT: AccessViolation in ObjectNative::IsLockHeld (part 2 of 2)">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1/" data-tooltip="Investigating an InvalidProgramException from a memory dump (part 3 of 3)" aria-label="PREVIOUS: Investigating an InvalidProgramException from a memory dump (part 3 of 3)">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            

<link href="https://fonts.googleapis.com/css?family=Cookie&amp;display=swap" rel="stylesheet">
<div class="bmc-btn-container"><a class="bmc-btn" target="_blank" href="https://buymeacoffee.com/kevingosse">☕<span class="bmc-btn-text">Enjoyed the article? Buy me a coffee</span></a></div>

<style>
    .bmc-btn {
        min-width: 210px;
        color: #000000;
        background-color: #FFFFFF !important;
        height: 60px;
        border-radius: 12px;
        font-size: 28px;
        font-weight: Normal;
        border: none;
        line-height: 27px;
        text-decoration: none !important;
        display: inline-flex !important;
        justify-content: center;
        align-items: center;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
    }

    .bmc-btn:hover, .bmc-btn:active, .bmc-btn:focus {
        text-decoration: none !important;
        cursor: pointer;
    }

    .bmc-btn-text {
        margin-left: 8px;
        display: inline-block;
        line-height: 0;
        width: 100%;
        flex-shrink: 0;
        font-family: [FONT] !important;
    }

    .logo-outline {
        fill: #000000;
    }

    .logo-coffee {
        fill: #ffffff;
    }</style>

  
<div id="utterances">
      <noscript>Please enable JavaScript to view the comments powered by Utterances.</noscript>
    </div>
<script src="https://utteranc.es/client.js"
        repo="kevingosse/kevingosse.github.io"
        issue-term="title"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2024 Kevin Gosse. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c/" data-tooltip="AccessViolation in ObjectNative::IsLockHeld (part 2 of 2)" aria-label="NEXT: AccessViolation in ObjectNative::IsLockHeld (part 2 of 2)">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1/" data-tooltip="Investigating an InvalidProgramException from a memory dump (part 3 of 3)" aria-label="PREVIOUS: Investigating an InvalidProgramException from a memory dump (part 3 of 3)">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/accessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="2">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fminidump.net%2Faccessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a%2F" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https%3A%2F%2Fminidump.net%2Faccessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a%2F" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i><span>Share on Linkedin</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.reddit.com/submit?url=https%3A%2F%2Fminidump.net%2Faccessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a%2F" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i><span>Share on Reddit</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fminidump.net%2Faccessviolation-in-objectnative-islockheld-part-1-of-2-7fae4b839f9a%2F" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i><span>Share on Hacker News</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>


    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Kevin Gosse</h4>
    
      <div id="about-card-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</div>
    
    
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://minidump.net/images/code.png');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://minidump.net/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

