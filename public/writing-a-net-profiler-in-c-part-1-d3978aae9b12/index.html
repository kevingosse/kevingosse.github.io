<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <script type="application/ld+json">

{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Writing a .NET profiler in C# - Part 1",
  
  "image": "https://minidump.net/images/writing-a-net-profiler-in-c-part-1-d3978aae9b12-1.webp",
  
  "datePublished": "2022-07-11T00:00:00Z",
  "dateModified": "2022-07-11T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Kevin Gosse",
    
    "image": "https://minidump.net/images/profile.png"
    
  },
  "mainEntityOfPage": { 
    "@type": "WebPage",
    "@id": "https:\/\/minidump.net\/writing-a-net-profiler-in-c-part-1-d3978aae9b12\/" 
  },
  "publisher": {
    "@type": "Organization",
    "name": "minidump.net",
    
    "logo": {
      "@type": "ImageObject",
      "url": "https://minidump.net/images/profile.png"
    }
    
  },
  "description": "Part 1 of the series about using NativeAOT to write a .NET profiler in C#, learning many things about native interop in the process. In this part, we will see how to mimic a COM interface in C#.",
  "keywords": []
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.121.1 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="Kevin Gosse">
<meta name="keywords" content="">
<meta name="description" content="Part 1 of the series about using NativeAOT to write a .NET profiler in C#, learning many things about native interop in the process. In this part, we will see how to mimic a COM interface in C#.">


<meta property="og:description" content="Part 1 of the series about using NativeAOT to write a .NET profiler in C#, learning many things about native interop in the process. In this part, we will see how to mimic a COM interface in C#.">
<meta property="og:type" content="article">
<meta property="og:title" content="Writing a .NET profiler in C# - Part 1">
<meta name="twitter:title" content="Writing a .NET profiler in C# - Part 1">
<meta property="og:url" content="https://minidump.net/writing-a-net-profiler-in-c-part-1-d3978aae9b12/">
<meta property="twitter:url" content="https://minidump.net/writing-a-net-profiler-in-c-part-1-d3978aae9b12/">
<meta property="og:site_name" content="minidump.net">
<meta property="og:description" content="Part 1 of the series about using NativeAOT to write a .NET profiler in C#, learning many things about native interop in the process. In this part, we will see how to mimic a COM interface in C#.">
<meta name="twitter:description" content="Part 1 of the series about using NativeAOT to write a .NET profiler in C#, learning many things about native interop in the process. In this part, we will see how to mimic a COM interface in C#.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2022-07-11T00:00:00">
  
  
    <meta property="article:modified_time" content="2022-07-11T00:00:00">
  
  
  
  
    
      <meta property="article:tag" content="dotnet">
    
      <meta property="article:tag" content="csharp">
    
      <meta property="article:tag" content="nativeaot">
    
      <meta property="article:tag" content="profiler">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@kookiz">


  <meta name="twitter:creator" content="@kookiz">






  <meta property="og:image" content="https://minidump.net/images/profile.png">
  <meta property="twitter:image" content="https://minidump.net/images/profile.png">





  <meta property="og:image" content="https://minidump.net/images/writing-a-net-profiler-in-c-part-1-d3978aae9b12-1.webp">
  <meta property="twitter:image" content="https://minidump.net/images/writing-a-net-profiler-in-c-part-1-d3978aae9b12-1.webp">


    <title>Writing a .NET profiler in C# - Part 1</title>

    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    

    

    <link rel="canonical" href="https://minidump.net/writing-a-net-profiler-in-c-part-1-d3978aae9b12/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://minidump.net/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    <script>
    (function(h,o,u,n,d) {
      h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}}
      d=o.createElement(u);d.async=1;d.src=n
      n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n)
    })(window,document,'script','https://www.datadoghq-browser-agent.com/us1/v5/datadog-rum.js','DD_RUM')
    window.DD_RUM.onReady(function() {
      window.DD_RUM.init({
        clientToken: 'pubabeb7320d5ecb81f3b14a17c35c1a3de',
        applicationId: '78b5d24e-77d4-4bba-ae37-5a46f7386b95',
        site: 'datadoghq.com',
        service: 'minidump.net',
        env: 'kevin',
        sessionSampleRate: 100,
        sessionReplaySampleRate: 20,
        trackUserInteractions: true,
        trackResources: true,
        trackLongTasks: true,
        defaultPrivacyLevel: 'mask-user-input',
      });
    })
</script>
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/" aria-label="Go to homepage">minidump.net</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about" aria-label="Read more about the author">
          <img class="sidebar-profile-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Kevin Gosse</h4>
        
          <h5 class="sidebar-profile-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/kookiz" target="_blank" rel="noopener" title="Twitter">
    
      <i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/kevingosse" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.buymeacoffee.com/kevingosse" target="_blank" rel="noopener" title="Buy me a coffee">
    
      <i class="sidebar-button-icon fas fa-lg fa-coffee" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Buy me a coffee</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      Writing a .NET profiler in C# - Part 1
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2022-07-11T00:00:00Z">
        
  
  
  
  
    July 11 2022
  

      </time>
    
    
  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>.NET has a very powerful profiling API, that allows to closely monitor the runtime, dynamically rewrite methods during execution, walk the callstack of threads at arbitrary points in time, and much more. However, the entry cost to learn how to use that API is quite high. The first reason is that many features require a good knowledge of how the .NET metadata system works. The other reason is that all the documentation and examples are written in C++.</p>
<p>In theory, most languages could be used to write a .NET profiler. For instance, there is <a href="https://github.com/camdenreslink/clr-profiler">this proof-of-concept using Rust</a>. But it has been close to impossible to use C#. If the profiler is a .NET library, it will use the same runtime as the profiled application, which causes a few issues:</p>
<ul>
<li>
<p>Since the profiler would be a .NET library, it would end up profiling itself. This is more problematic than it sounds. For instance, when a method in the profiled application is compiled, the runtime raises the profiling event <a href="https://docs.microsoft.com/en-us/dotnet/framework/unmanaged-api/profiling/icorprofilercallback-jitcompilationstarted-method?WT.mc_id=DT-MVP-5003493"><code>JITCompilationStarted</code></a>. This would invoke a callback in the profiler, which needs first to be compiled by the JIT. So that would raise another <code>JITCompilationStarted</code> event, which would invoke the callback, which would need first to be compiled by the JIT, so that would raise another <code>JITCompilationStarted</code>… You get my point.</p>
</li>
<li>
<p>Even if you manage to find a fix for that problem, there is a much more practical one: the profiler is loaded very early during the runtime initialization, at a point where the system is not ready to run .NET code.</p>
</li>
</ul>
<p>I&rsquo;ve always felt like it was a shame, because C# is by far the language C# developers are the most familiar with. Fortunately, the situation has changed.</p>
<p>I&rsquo;ve already mentioned it <a href="/writing-native-windbg-extensions-in-c-5390726f3cec">in a previous article</a>, Microsoft is actively working on NativeAOT. This tool allows to compile a .NET library into a native, standalone library. Standalone is the key here: because it comes with its own runtime (its own GC, its own threadpool, its own type system…), it can be loaded into a process with exactly the same limitations as any native library. Which means that we can in theory use it to write a .NET profiler in C#.</p>
<h1 id="the-setup">The setup</h1>
<p>To learn how to write a .NET profiler, you can refer to <a href="https://chnasarre.medium.com/start-a-journey-into-the-net-profiling-apis-40c76e2e36cc">the articles written by Christophe Nasarre</a>. In a nutshell, we need to expose a <a href="https://docs.microsoft.com/en-us/windows/win32/api/combaseapi/nf-combaseapi-dllgetclassobject"><code>DllGetClassObject</code></a> method that will return an instance of <a href="https://docs.microsoft.com/en-us/windows/win32/api/unknwn/nn-unknwn-iclassfactory?WT.mc_id=DT-MVP-5003493"><code>IClassFactory</code></a>. The .NET runtime will call the <code>CreateInstance</code> method on the class factory, which will return an instance of <a href="https://docs.microsoft.com/en-us/dotnet/framework/unmanaged-api/profiling/icorprofilercallback-interface?WT.mc_id=DT-MVP-5003493"><code>ICorProfilerCallback</code></a> (or <a href="https://docs.microsoft.com/en-us/dotnet/framework/unmanaged-api/profiling/icorprofilercallback2-interface?WT.mc_id=DT-MVP-5003493"><code>ICorProfilerCallback2</code></a>, <a href="https://docs.microsoft.com/en-us/dotnet/framework/unmanaged-api/profiling/icorprofilercallback3-interfaceICorProfilerCallback3"><code>ICorProfilerCallback3</code></a>, &hellip;, depending on which version of the profiling API we want to support). Last but not least, the runtime will call the <a href="https://docs.microsoft.com/en-us/dotnet/framework/unmanaged-api/profiling/icorprofilercallback-initialize-method?WT.mc_id=DT-MVP-5003493"><code>Initialize</code></a> method on that instance with an <a href="https://docs.microsoft.com/en-us/windows/win32/api/unknwn/nn-unknwn-iunknown?WT.mc_id=DT-MVP-5003493"><code>IUnknown</code></a> parameter that we can use to fetch an instance of <a href="https://docs.microsoft.com/en-us/dotnet/framework/unmanaged-api/profiling/icorprofilerinfo-interface?WT.mc_id=DT-MVP-5003493"><code>ICorProfilerInfo</code></a> (or <a href="https://docs.microsoft.com/en-us/dotnet/framework/unmanaged-api/profiling/icorprofilerinfo2-interface?WT.mc_id=DT-MVP-5003493"><code>ICorProfilerInfo2</code></a>, <a href="https://docs.microsoft.com/en-us/dotnet/framework/unmanaged-api/profiling/icorprofilerinfo3-interface"><code>ICorProfilerInfo3</code></a>, &hellip;) that we will need to query the profiling API.</p>
<p>Well that&rsquo;s a lot. Let&rsquo;s start with the first step: exporting a <code>DllGetClassObject</code> method. First we create a .NET 6 class library project, and add a reference to <a href="https://www.nuget.org/packages/Microsoft.DotNet.ILCompiler"><code>Microsoft.DotNet.ILCompiler</code></a> in version <code>7.0.0-preview.*</code>. Then we create a <code>DllMain</code> class (the name doesn&rsquo;t really matter) with a <code>DllGetClassObject</code> method. We also decorate this method with a <a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.unmanagedcallersonlyattribute?view=net-6.0&amp;?WT.mc_id=DT-MVP-5003493"><code>UnmanagedCallersOnly</code></a> attribute to instruct the NativeAOT toolchain to export the method.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Runtime.InteropServices;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> ManagedDotnetProfiler;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DllMain</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [UnmanagedCallersOnly(EntryPoint = &#34;DllGetClassObject&#34;)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">int</span> DllGetClassObject(Guid* rclsid, Guid* riid, IntPtr* ppv)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Console.WriteLine(<span style="color:#e6db74">&#34;Hello from the profiling API&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Then we run the <code>dotnet publish</code> command with the <code>/p:NativeLib=Shared</code> command to generate a native library:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>$ dotnet publish /p:NativeLib=Shared /p:SelfContained=true -r win-x64 -c Release
</span></span></code></pre></div><p>The output is a .dll file (or .so on Linux). To test that everything is working as expected, we can launch any .NET console application after setting the right environment variables:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span><span style="color:#66d9ef">set</span> CORECLR_ENABLE_PROFILING=1
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> CORECLR_PROFILER={B3A10128-F10D-4044-AB27-A799DB8B7E4F}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> CORECLR_PROFILER_PATH=C:\git\ManagedDotnetProfiler\ManagedDotnetProfiler\bin\Release\net6.0\win-x64\publish\ManagedDotnetProfiler.dll
</span></span></code></pre></div><p><code>CORECLR_ENABLE_PROFILING</code> instructs the runtime to load the profiler. <code>CORECLR_PROFILER</code> is a GUID uniquely identifying the profiler (any value will do for now). <code>CORECLR_PROFILER_PATH</code> is the path to the dll we published with NativeAOT. If everything worked properly, you should see the message displayed during the loading of the target app:</p>
<pre tabindex="0"><code>C:\console\bin\Debug\net6.0&gt;console.exe
Hello from the profiling API
Hello, World!
</code></pre><p>That&rsquo;s great, but not really useful yet. How to write an actual profiler? We now need to understand how to expose an instance of <code>IClassFactory</code>.</p>
<h1 id="exposing-a-c-interface-kind-of">Exposing a C++ interface (kind of)</h1>
<p>The MSDN documentation indicates that <code>IClassFactory</code> is an interface. But &ldquo;interface&rdquo; means different things in C++ and C#, so we can&rsquo;t just implement an <code>IClassFactory</code> in our .NET code and call it a day.</p>
<p>As a matter of fact, the concept of interface doesn&rsquo;t really exist in C++. In practice, it just designates an abstract class that only contains pure virtual functions. So we need to build and expose an object that will look like a C++ abstract class. For that, we need to understand the concept of <a href="https://en.wikipedia.org/wiki/Virtual_method_table"><em>vtable</em></a>.</p>
<p>Imagine we have an interface <code>IInterface</code> with a single method <code>DoSomething</code>, and two implementations, <code>ClassA</code> and <code>ClassB</code>. Because both <code>ClassA</code> and <code>ClassB</code> can declare their own implementation of <code>DoSomething</code>, the runtime needs a level of indirection to know which one to invoke when given a pointer to an instance of <code>IInterface</code>. This indirection is called the virtual table, or vtable.</p>
<p>By convention, when a class implements virtual methods, the C++ compiler emits a hidden field at the beginning of the object. That hidden field contains a pointer to the vtable. The vtable is a chunk of memory that contains the address of the implementation of each virtual method, in the order they are declared. When invoking a virtual method, the runtime will first fetch the vtable, then use it to get the address of the implementation.</p>
<p>There are more specificities to the vtable, for instance to handle multiple inheritance, but we don&rsquo;t need to know about those for this article.</p>
<p>To summarize, to create an <code>IClassFactory</code> object that can be used by the C++ runtime, we need to allocate a chunk of memory to store the address of our functions. This is our vtable. Then we need another chunk of memory that contains a pointer to the vtable. This is our instance.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/writing-a-net-profiler-in-c-part-1-d3978aae9b12-1.webp" data-fancybox="">
  
    <img class="fig-img" src="/images/writing-a-net-profiler-in-c-part-1-d3978aae9b12-1.webp" >
  
    </a>
  
  
</div>

<p>For simplicity, we can merge the instance and the vtable into a single chunk of memory:</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/writing-a-net-profiler-in-c-part-1-d3978aae9b12-2.webp" data-fancybox="">
  
    <img class="fig-img" src="/images/writing-a-net-profiler-in-c-part-1-d3978aae9b12-2.webp" >
  
    </a>
  
  
</div>

<p>So what does it look like in C#? First we declare a static method for each function in the <code>IClassFactory</code> interface, and decorate them with <code>UnmanagedCallersOnly</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#a6e22e">[UnmanagedCallersOnly]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">int</span> QueryInterface(IntPtr self, Guid* guid, IntPtr* ptr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Console.WriteLine(<span style="color:#e6db74">&#34;QueryInterface&#34;</span>);
</span></span><span style="display:flex;"><span>    *ptr = IntPtr.Zero;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">[UnmanagedCallersOnly]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> AddRef(IntPtr self)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Console.WriteLine(<span style="color:#e6db74">&#34;AddRef&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">[UnmanagedCallersOnly]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> Release(IntPtr self)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Console.WriteLine(<span style="color:#e6db74">&#34;Release&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">[UnmanagedCallersOnly]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">int</span> CreateInstance(IntPtr self, IntPtr outer, Guid* guid, IntPtr* instance)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Console.WriteLine(<span style="color:#e6db74">&#34;CreateInstance&#34;</span>);
</span></span><span style="display:flex;"><span>    *instance = IntPtr.Zero;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">[UnmanagedCallersOnly]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> LockServer(IntPtr self, <span style="color:#66d9ef">bool</span> @lock)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Then, in <code>DllGetClassObject</code>, we allocate the chunk of memory that will be used to store the pointer to the vtable (our fake instance) and the vtable itself. Since this memory will be used by native code, we must make sure it won&rsquo;t be moved by the garbage collector. We could declare an array of <code>IntPtr</code> and pin it, but I prefer to instead use <a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.nativememory.alloc?view=net-6.0&amp;WT.mc_id=DT-MVP-5003493"><code>NativeMemory.Alloc</code></a> to allocate memory that won&rsquo;t be tracked by the GC. To get the addresses of our static methods, we can cast them to function pointers, then to <code>IntPtr</code>. Finally, we return the address of the chunk of memory through the <code>ppv</code> argument of the function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#a6e22e">[UnmanagedCallersOnly(EntryPoint = &#34;DllGetClassObject&#34;)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">int</span> DllGetClassObject(Guid* rclsid, Guid* riid, IntPtr* ppv)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Console.WriteLine(<span style="color:#e6db74">&#34;Hello from the profiling API&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Allocate the chunk of memory for the vtable pointer + the pointers to the 5 methods</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> chunk = (IntPtr*)NativeMemory.Alloc(<span style="color:#ae81ff">1</span> + <span style="color:#ae81ff">5</span>, (nuint)IntPtr.Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Pointer to the vtable</span>
</span></span><span style="display:flex;"><span>    *chunk = (IntPtr)(chunk + <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Pointers to each method of the interface</span>
</span></span><span style="display:flex;"><span>    *(chunk + <span style="color:#ae81ff">1</span>) = (IntPtr)(<span style="color:#66d9ef">delegate</span>* unmanaged&lt;IntPtr, Guid*, IntPtr*, <span style="color:#66d9ef">int</span>&gt;)&amp;QueryInterface;
</span></span><span style="display:flex;"><span>    *(chunk + <span style="color:#ae81ff">2</span>) = (IntPtr)(<span style="color:#66d9ef">delegate</span>* unmanaged&lt;IntPtr, <span style="color:#66d9ef">int</span>&gt;)&amp;AddRef;
</span></span><span style="display:flex;"><span>    *(chunk + <span style="color:#ae81ff">3</span>) = (IntPtr)(<span style="color:#66d9ef">delegate</span>* unmanaged&lt;IntPtr, <span style="color:#66d9ef">int</span>&gt;)&amp;Release;
</span></span><span style="display:flex;"><span>    *(chunk + <span style="color:#ae81ff">4</span>) = (IntPtr)(<span style="color:#66d9ef">delegate</span>* unmanaged&lt;IntPtr, IntPtr, Guid*, IntPtr*, <span style="color:#66d9ef">int</span>&gt;)&amp;CreateInstance;
</span></span><span style="display:flex;"><span>    *(chunk + <span style="color:#ae81ff">5</span>) = (IntPtr)(<span style="color:#66d9ef">delegate</span>* unmanaged&lt;IntPtr, <span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">int</span>&gt;)&amp;LockServer;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    *ppv = (IntPtr)chunk;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HResult.S_OK;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>After compiling and testing, we can see that the <code>CreateInstance</code> method of our fake <code>IClassFactory</code> is called as expected:</p>
<pre tabindex="0"><code>C:\console\bin\Debug\net6.0&gt; .\console.exe
Hello from the profiling API
CreateInstance
Release
Hello, World!
</code></pre><h1 id="were-just-getting-started">We&rsquo;re just getting started</h1>
<p>The next step would be to implement that <code>CreateInstance</code> method. As explained earlier, we are expected to return an instance of <code>ICorProfilerCallback</code>. To implement this interface, we could do the same thing as we just did for <code>IClassFactory</code>, however <code>ICorProfilerCallback</code> contains almost 70 methods! That&rsquo;s a lot of boilerplate code to write, not mentioning <code>ICorProfilerCallback2</code>, <code>ICorProfilerCallback3</code> and so on. Plus, our current solution only works with static methods, it would be really nice to have something that works with instance methods. In the next article of the series, we will see how to solve those issues.</p>

              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/dotnet/">dotnet</a>

  <a class="tag tag--primary tag--small" href="/tags/csharp/">csharp</a>

  <a class="tag tag--primary tag--small" href="/tags/nativeaot/">nativeaot</a>

  <a class="tag tag--primary tag--small" href="/tags/profiler/">profiler</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/c-why-function-pointers-cant-be-used-on-instance-methods-8a99fc99b040/" data-tooltip="Why function pointers can&#39;t be used on instance methods in C#" aria-label="NEXT: Why function pointers can&#39;t be used on instance methods in C#">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/writing-native-windbg-extensions-in-c-5390726f3cec/" data-tooltip="Writing native WinDbg extensions in C#" aria-label="PREVIOUS: Writing native WinDbg extensions in C#">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/writing-a-net-profiler-in-c-part-1-d3978aae9b12/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/writing-a-net-profiler-in-c-part-1-d3978aae9b12/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/writing-a-net-profiler-in-c-part-1-d3978aae9b12/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/writing-a-net-profiler-in-c-part-1-d3978aae9b12/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            

<link href="https://fonts.googleapis.com/css?family=Cookie&amp;display=swap" rel="stylesheet">
<div class="bmc-btn-container"><a class="bmc-btn" target="_blank" href="https://buymeacoffee.com/kevingosse">☕<span class="bmc-btn-text">Enjoyed the article? Buy me a coffee</span></a></div>

<style>
    .bmc-btn {
        min-width: 210px;
        color: #000000;
        background-color: #FFFFFF !important;
        height: 60px;
        border-radius: 12px;
        font-size: 28px;
        font-weight: Normal;
        border: none;
        line-height: 27px;
        text-decoration: none !important;
        display: inline-flex !important;
        justify-content: center;
        align-items: center;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
    }

    .bmc-btn:hover, .bmc-btn:active, .bmc-btn:focus {
        text-decoration: none !important;
        cursor: pointer;
    }

    .bmc-btn-text {
        margin-left: 8px;
        display: inline-block;
        line-height: 0;
        width: 100%;
        flex-shrink: 0;
        font-family: [FONT] !important;
    }

    .logo-outline {
        fill: #000000;
    }

    .logo-coffee {
        fill: #ffffff;
    }</style>

  
<div id="utterances">
      <noscript>Please enable JavaScript to view the comments powered by Utterances.</noscript>
    </div>
<script src="https://utteranc.es/client.js"
        repo="kevingosse/kevingosse.github.io"
        issue-term="title"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2024 Kevin Gosse. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/c-why-function-pointers-cant-be-used-on-instance-methods-8a99fc99b040/" data-tooltip="Why function pointers can&#39;t be used on instance methods in C#" aria-label="NEXT: Why function pointers can&#39;t be used on instance methods in C#">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/writing-native-windbg-extensions-in-c-5390726f3cec/" data-tooltip="Writing native WinDbg extensions in C#" aria-label="PREVIOUS: Writing native WinDbg extensions in C#">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/writing-a-net-profiler-in-c-part-1-d3978aae9b12/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/writing-a-net-profiler-in-c-part-1-d3978aae9b12/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/writing-a-net-profiler-in-c-part-1-d3978aae9b12/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/writing-a-net-profiler-in-c-part-1-d3978aae9b12/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="2">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fminidump.net%2Fwriting-a-net-profiler-in-c-part-1-d3978aae9b12%2F" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https%3A%2F%2Fminidump.net%2Fwriting-a-net-profiler-in-c-part-1-d3978aae9b12%2F" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i><span>Share on Linkedin</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.reddit.com/submit?url=https%3A%2F%2Fminidump.net%2Fwriting-a-net-profiler-in-c-part-1-d3978aae9b12%2F" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i><span>Share on Reddit</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fminidump.net%2Fwriting-a-net-profiler-in-c-part-1-d3978aae9b12%2F" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i><span>Share on Hacker News</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>


    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Kevin Gosse</h4>
    
      <div id="about-card-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</div>
    
    
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://minidump.net/images/code.png');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://minidump.net/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

