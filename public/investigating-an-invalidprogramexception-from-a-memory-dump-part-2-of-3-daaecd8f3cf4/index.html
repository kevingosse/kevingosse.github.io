<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <script type="application/ld+json">

{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Investigating an InvalidProgramException from a memory dump (part 2 of 3)",
  
  "image": "https://minidump.net/images/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4-1.webp",
  
  "datePublished": "2020-09-01T00:00:00Z",
  "dateModified": "2020-09-01T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Kevin Gosse",
    
    "image": "https://minidump.net/images/profile.png"
    
  },
  "mainEntityOfPage": { 
    "@type": "WebPage",
    "@id": "https:\/\/minidump.net\/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4\/" 
  },
  "publisher": {
    "@type": "Organization",
    "name": "minidump.net",
    
    "logo": {
      "@type": "ImageObject",
      "url": "https://minidump.net/images/profile.png"
    }
    
  },
  "description": "In this series of article, we\u0026rsquo;re retracing how I debugged an InvalidProgramException, caused by a bug in the Datadog profiler, from a memory dump sent by a customer. In this part, we extract the dynamic IL from the memory dump.",
  "keywords": []
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.121.1 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="Kevin Gosse">
<meta name="keywords" content="">
<meta name="description" content="In this series of article, we&rsquo;re retracing how I debugged an InvalidProgramException, caused by a bug in the Datadog profiler, from a memory dump sent by a customer. In this part, we extract the dynamic IL from the memory dump.">


<meta property="og:description" content="In this series of article, we&rsquo;re retracing how I debugged an InvalidProgramException, caused by a bug in the Datadog profiler, from a memory dump sent by a customer. In this part, we extract the dynamic IL from the memory dump.">
<meta property="og:type" content="article">
<meta property="og:title" content="Investigating an InvalidProgramException from a memory dump (part 2 of 3)">
<meta name="twitter:title" content="Investigating an InvalidProgramException from a memory dump (part 2 of 3)">
<meta property="og:url" content="https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4/">
<meta property="twitter:url" content="https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4/">
<meta property="og:site_name" content="minidump.net">
<meta property="og:description" content="In this series of article, we&rsquo;re retracing how I debugged an InvalidProgramException, caused by a bug in the Datadog profiler, from a memory dump sent by a customer. In this part, we extract the dynamic IL from the memory dump.">
<meta name="twitter:description" content="In this series of article, we&rsquo;re retracing how I debugged an InvalidProgramException, caused by a bug in the Datadog profiler, from a memory dump sent by a customer. In this part, we extract the dynamic IL from the memory dump.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2020-09-01T00:00:00">
  
  
    <meta property="article:modified_time" content="2020-09-01T00:00:00">
  
  
  
  
    
      <meta property="article:tag" content="dotnet">
    
      <meta property="article:tag" content="debugging">
    
      <meta property="article:tag" content="windbg">
    
      <meta property="article:tag" content="lldb">
    
      <meta property="article:tag" content="cpp">
    
      <meta property="article:tag" content="assembly">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@kookiz">


  <meta name="twitter:creator" content="@kookiz">






  <meta property="og:image" content="https://minidump.net/images/profile.png">
  <meta property="twitter:image" content="https://minidump.net/images/profile.png">





  <meta property="og:image" content="https://minidump.net/images/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4-1.webp">
  <meta property="twitter:image" content="https://minidump.net/images/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4-1.webp">


    <title>Investigating an InvalidProgramException from a memory dump (part 2 of 3)</title>

    <link rel="icon" href="/favicon.png">
    

    

    <link rel="canonical" href="https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://minidump.net/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MQCXFBVCCM"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-MQCXFBVCCM', { 'anonymize_ip': false });
}
</script>

    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/" aria-label="Go to homepage">minidump.net</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about" aria-label="Read more about the author">
          <img class="sidebar-profile-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Kevin Gosse</h4>
        
          <h5 class="sidebar-profile-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/kookiz" target="_blank" rel="noopener" title="Twitter">
    
      <i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/kevingosse" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.buymeacoffee.com/kevingosse" target="_blank" rel="noopener" title="Buy me a coffee">
    
      <i class="sidebar-button-icon fas fa-lg fa-coffee" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Buy me a coffee</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      Investigating an InvalidProgramException from a memory dump (part 2 of 3)
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2020-09-01T00:00:00Z">
        
  
  
  
  
    September 01 2020
  

      </time>
    
    
  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>In this series of articles, we&rsquo;re retracing how I debugged an <code>InvalidProgramException</code>, caused by a bug in the Datadog profiler, from a memory dump sent by a customer.</p>
<ul>
<li>
<p><a href="/investigating-an-invalidprogramexception-from-a-memory-dump-part-1-of-3-bce634460cc3">Part 1: Preliminary exploration</a></p>
</li>
<li>
<p>Part 2: Finding the generated IL</p>
</li>
<li>
<p><a href="/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1">Part 3: Identifying the error and fixing the bug</a></p>
</li>
</ul>
<p>Let&rsquo;s start with a quick reminder. The profiler works by rewriting the IL of interesting methods to inject instrumentation code. The <code>InvalidProgramException</code> is thrown by the JIT when trying to compile the IL emitted by the profiler, which must be somehow invalid. <a href="/investigating-an-invalidprogramexception-from-a-memory-dump-part-1-of-3-bce634460cc3">The first part</a> was about identifying in what method the exception was thrown, and I ended up concluding that <code>Npgsql.PostgresDatabaseInfo.LoadBackendTypes</code> was the culprit. The second part is going to be about how to find the generated IL for that method.</p>
<h1 id="finding-the-generated-il">Finding the generated IL</h1>
<p><code>Npgsql.PostgresDatabaseInfo.LoadBackendTypes</code> is an asynchronous method. The logic of an async method is stored in the <code>MoveNext</code> method of its state-machine, so that&rsquo;s the one I was interested in.</p>
<p>There&rsquo;s a function in <code>dotnet-dump</code> to display the IL of a method: <code>dumpil</code>. This method requires the MethodDescriptor (MD) of the target method, so I needed to find it for <code>MoveNext</code>.</p>
<p>I started by dumping all the types in the module, using the <code>dumpmodule -mt</code> command, to find the state-machine:</p>
<pre tabindex="0"><code>&gt; dumpmodule -mt 00007FCF13EC67D8

Name: /Npgsql.dll
Attributes:              PEFile SupportsUpdateableMethods IsFileLayout
Assembly:                0000000002a3f590
BaseAddress:             00007FCF8079E000
PEFile:                  0000000002A638B0
ModuleId:                00007FCF13EC7FE0
ModuleIndex:             0000000000000091
LoaderHeap:              0000000000000000
TypeDefToMethodTableMap: 00007FCF13F30020
TypeRefToMethodTableMap: 00007FCF13F31270
MethodDefToDescMap:      00007FCF13F31EE8
FieldDefToDescMap:       00007FCF13F392E0
MemberRefToDescMap:      0000000000000000
FileReferencesMap:       00007FCF13F3F740
AssemblyReferencesMap:   00007FCF13F3F748
MetaData start address:  00007FCF807DF410 (496736 bytes)

Types defined in this module

              MT          TypeDef Name
------------------------------------------------------------------------------
00007fcf161d7698 0x02000002 &lt;&gt;f__AnonymousType0`2
00007fcf161d7bb0 0x02000003 &lt;&gt;f__AnonymousType1`2
[...]
00007fcf16509c10 0x020001b0 Npgsql.PostgresDatabaseInfo+&lt;LoadBackendTypes&gt;d__16
[...]
</code></pre><p>This gave me the MT (MethodTable) of the state-machine type: <code>00007fcf16509c10</code>. Then I fed it to the <code>dumpmt -md</code> command to get the MD:</p>
<pre tabindex="0"><code>&gt; dumpmt -md 00007fcf16509c10

EEClass:         00007FCF164EBD70
Module:          00007FCF13EC67D8
Name:            Npgsql.PostgresDatabaseInfo+&lt;LoadBackendTypes&gt;d__16
mdToken:         00000000020001B0
File:            /Npgsql.dll
BaseSize:        0x60
ComponentSize:   0x0
DynamicStatics:  false
ContainsPointers true
Slots in VTable: 8
Number of IFaces in IFaceMap: 1
--------------------------------------
MethodDesc Table
           Entry       MethodDesc    JIT Name
[...]
00007FCF16265300 00007FCF16509B58   NONE Npgsql.PostgresDatabaseInfo+&lt;LoadBackendTypes&gt;d__16.MoveNext()
[...]
</code></pre><p>The command outputs all the methods from the given type, and from there we can see that our MD is <code>00007FCF16509B58</code>.</p>
<p>Unfortunately, the <code>dumpil</code> command returned the original IL, not the rewritten one. Looking for ideas, I used the <code>dumpmd</code> command to get more information about the method:</p>
<pre tabindex="0"><code>&gt; dumpmd 00007FCF16509B58

Method Name:          Npgsql.PostgresDatabaseInfo+&lt;LoadBackendTypes&gt;d__16.MoveNext()
Class:                00007fcf164ebd70
MethodTable:          00007fcf16509c10
mdToken:              0000000006000D24
Module:               00007fcf13ec67d8
IsJitted:             no
Current CodeAddr:     ffffffffffffffff
Version History:
  ILCodeVersion:      0000000000000000
  ReJIT ID:           0
  IL Addr:            0000000000000000
     CodeAddr:           0000000000000000  (OptimizedTier1)
     NativeCodeVersion:  00007FCE84156100
     CodeAddr:           0000000000000000  (QuickJitted)
     NativeCodeVersion:  0000000000000000
</code></pre><p>Interestingly, the method was marked as not jitted. In hindsight, that makes sense. We rewrite the method using the <a href="https://docs.microsoft.com/en-us/dotnet/framework/unmanaged-api/profiling/icorprofilercallback-jitcompilationstarted-method?WT.mc_id=DT-MVP-5003493"><code>JitCompilationStarted</code></a> event of the profiler API. The JIT then tries to compile it, fails, and throws away the rewritten IL.</p>
<blockquote>
<p><em>Fun fact for those who know about <a href="https://github.com/dotnet/coreclr/blob/master/Documentation/design-docs/tiered-compilation.md">tiered compilation</a>: you may have noticed in the <code>dumpmd</code> output that there are two versions of the method, QuickJitted and OptimizedTier1, despite the <code>IsJitted</code> flag being false. I managed to reproduce this on a test app with a profiler emitting bad IL: after calling the method 30 times, the tiered JIT promotes it to tier 1, even though the method was never jitted successfully</em></p>
</blockquote>
<p>Dead-end? I really didn&rsquo;t want to give up after going through the tedious process of finding the method, so I decided to get creative. The same way that I managed to find the <code>InvalidProgramException</code> on the heap even though it wasn&rsquo;t referenced anymore, I figured out that there could still be traces of the generated IL somewhere.</p>
<p>To give the rewritten IL to the JIT, the profiler uses the <a href="https://docs.microsoft.com/en-us/dotnet/framework/unmanaged-api/profiling/icorprofilerinfo-setilfunctionbody-method?WT.mc_id=DT-MVP-5003493"><code>SetILFunctionBody</code></a> API. What&rsquo;s interesting about it is that the buffer, used to write the IL, is provided by the JIT own&rsquo;s allocator. Quoting the documentation:</p>
<pre tabindex="0"><code>Use the ICorProfilerInfo::GetILFunctionBodyAllocator method to allocate space for the new method to ensure that the buffer is compatible.
</code></pre><p>Maybe I could find traces of the IL in whatever data structure is used internally by the body allocator? Unfortunately, the allocator <a href="https://github.com/dotnet/runtime/blob/v5.0.0-preview.8.20407.11/src/coreclr/src/vm/proftoeeinterfaceimpl.cpp#L463">is just a call to the <code>new</code> operator</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">//---------------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Profiler entrypoint to allocate space from this module&#39;s heap.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Arguments
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//      cb - size in bytes of allocation request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Return value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//      pointer to allocated memory, or NULL if there was an error
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span> STDMETHODCALLTYPE ModuleILHeap<span style="color:#f92672">::</span>Alloc(ULONG cb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    CONTRACTL
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Yay!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        NOTHROW;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// (see GC_TRIGGERS comment below)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        CAN_TAKE_LOCK;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Allocations using loader heaps below enter a critsec, which switches
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// to preemptive, which is effectively a GC trigger
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        GC_TRIGGERS;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Yay!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        MODE_ANY;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    CONTRACTL_END;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    LOG((LF_CORPROF, LL_INFO1000, <span style="color:#e6db74">&#34;**PROF: ModuleILHeap::Alloc 0x%08xp.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, cb));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (cb <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">new</span> (nothrow) BYTE[cb];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I have no clue how the <code>new</code> operator works in C++, so I decided to follow another lead. What happens to that buffer after it&rsquo;s given to the <code>SetILFunctionBody</code> method? I&rsquo;m not going to show <a href="https://github.com/dotnet/runtime/blob/v5.0.0-preview.8.20407.11/src/coreclr/src/vm/proftoeeinterfaceimpl.cpp#L4428">the method implementation</a>, but the interesting bit is how it ends up calling <code>Module::SetDynamicIL</code>. In turn, <code>SetDynamicIL</code> stores the IL body in an internal table (this time I&rsquo;m showing the implementation because it&rsquo;ll be important for later):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> Module<span style="color:#f92672">::</span>SetDynamicIL(mdToken token, TADDR blobAddress, BOOL fTemporaryOverride)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    DynamicILBlobEntry entry <span style="color:#f92672">=</span> {mdToken(token), TADDR(blobAddress)};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Lazily allocate a Crst to serialize update access to the info structure.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Carefully synchronize to ensure we don&#39;t leak a Crst in race conditions.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (m_debuggerSpecificData.m_pDynamicILCrst <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        InitializeDynamicILCrst();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    CrstHolder <span style="color:#a6e22e">ch</span>(m_debuggerSpecificData.m_pDynamicILCrst);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Figure out which table to fill in
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    PTR_DynamicILBlobTable <span style="color:#f92672">&amp;</span>table(fTemporaryOverride <span style="color:#f92672">?</span> m_debuggerSpecificData.m_pTemporaryILBlobTable
</span></span><span style="display:flex;"><span>                                                     : m_debuggerSpecificData.m_pDynamicILBlobTable);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Lazily allocate the hash table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (table <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        table <span style="color:#f92672">=</span> PTR_DynamicILBlobTable(<span style="color:#66d9ef">new</span> DynamicILBlobTable);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    table<span style="color:#f92672">-&gt;</span>AddOrReplace(entry);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>fTemporaryOverride</code> is false in this codepath, so <code>m_debuggerSpecificData.m_pDynamicILBlobTable</code> is used to store the IL. If I could find the address of that table in the memory dump, then maybe I could retrieve the generated IL!</p>
<p><a href="https://medium.com/@kevingosse/check-what-net-core-gc-keywords-are-enabled-without-a-debugger-d616745c0d0e">As I shown in a previous article</a>, it&rsquo;s possible to export all the symbols of a module on Linux by using the <code>nm</code> command. So I tried looking for <code>m_debuggerSpecificData</code>, but no luck:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ nm -C libcoreclr.so | grep m_debuggerSpecificData
</span></span><span style="display:flex;"><span>$
</span></span></code></pre></div><p>How could I possibly find this structure without symbols?</p>
<p>I firmly believe that <a href="https://www.youtube.com/watch?v=uXOl5MXglWs">debugging is a creative process</a>. So I took a step back and started thinking. When <code>Module::SetDynamicIL</code> is called, the runtime is capable, somehow, of locating that structure. So the answer, whatever it is, must be somewhere in the assembly code of that method.</p>
<blockquote>
<p><em>Reading this article makes it sound like it&rsquo;s an instantaneous process, but locating <code>m_debuggerSpecificData</code> without symbols is the result of 2 hours of trial and error and bouncing ideas back and forth with my coworkers <a href="https://twitter.com/chnasarre">Christophe Nasarre</a> and <a href="https://twitter.com/GregoryLeocadie">Gregory Leocadie</a>
In the process, I also discovered that <a href="https://github.com/dotnet/coreclr/pull/26227">a ISOSDacInterface7 is being implemented for .NET 5</a>, and it has <a href="https://github.com/dotnet/runtime/blob/v5.0.0-preview.8.20407.11/src/coreclr/src/debug/daccess/request.cpp#L4425">all the facilities I needed to find the dynamic IL</a>. <strong>sigh</strong></em></p>
</blockquote>
<p>Fortunately, that method is exported in the symbols:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ nm -C libcoreclr.so | grep Module::SetDynamicIL
</span></span><span style="display:flex;"><span>0000000000543da0 t Module::SetDynamicIL<span style="color:#f92672">(</span>unsigned int, unsigned long, int<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>I used gdb to decompile it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gdb ./libcoreclr.so -batch -ex <span style="color:#e6db74">&#34;set disassembly-flavor intel&#34;</span> -ex <span style="color:#e6db74">&#34;disassemble Module::SetDynamicIL&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">function</span> Module::SetDynamicIL<span style="color:#f92672">(</span>unsigned int, unsigned long, int<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>   0x26bf00 &lt;+0&gt;:     push   rbp
</span></span><span style="display:flex;"><span>   0x26bf01 &lt;+1&gt;:     mov    rbp,rsp
</span></span><span style="display:flex;"><span>   0x26bf04 &lt;+4&gt;:     push   r15
</span></span><span style="display:flex;"><span>   0x26bf06 &lt;+6&gt;:     push   r14
</span></span><span style="display:flex;"><span>   0x26bf08 &lt;+8&gt;:     push   rbx
</span></span><span style="display:flex;"><span>   0x26bf09 &lt;+9&gt;:     sub    rsp,0x18
</span></span><span style="display:flex;"><span>   0x26bf0d &lt;+13&gt;:    mov    r15d,ecx
</span></span><span style="display:flex;"><span>   0x26bf10 &lt;+16&gt;:    mov    rbx,rdi
</span></span><span style="display:flex;"><span>   0x26bf13 &lt;+19&gt;:    mov    rax,QWORD PTR fs:0x28
</span></span><span style="display:flex;"><span>   0x26bf1c &lt;+28&gt;:    mov    QWORD PTR <span style="color:#f92672">[</span>rbp-0x20<span style="color:#f92672">]</span>,rax
</span></span><span style="display:flex;"><span>   0x26bf20 &lt;+32&gt;:    mov    DWORD PTR <span style="color:#f92672">[</span>rbp-0x30<span style="color:#f92672">]</span>,esi
</span></span><span style="display:flex;"><span>   0x26bf23 &lt;+35&gt;:    mov    QWORD PTR <span style="color:#f92672">[</span>rbp-0x28<span style="color:#f92672">]</span>,rdx
</span></span><span style="display:flex;"><span>   0x26bf27 &lt;+39&gt;:    mov    r14,QWORD PTR <span style="color:#f92672">[</span>rbx+0x568<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>   0x26bf2e &lt;+46&gt;:    test   r14,r14
</span></span><span style="display:flex;"><span>   0x26bf31 &lt;+49&gt;:    jne    0x26bf42 &lt;Module::SetDynamicIL<span style="color:#f92672">(</span>unsigned int, unsigned long, int<span style="color:#f92672">)</span>+66&gt;
</span></span><span style="display:flex;"><span>   0x26bf33 &lt;+51&gt;:    mov    rdi,rbx
</span></span><span style="display:flex;"><span>   0x26bf36 &lt;+54&gt;:    call   0x26be90 &lt;Module::InitializeDynamicILCrst<span style="color:#f92672">()</span>&gt;
</span></span><span style="display:flex;"><span>   0x26bf3b &lt;+59&gt;:    mov    r14,QWORD PTR <span style="color:#f92672">[</span>rbx+0x568<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>   0x26bf42 &lt;+66&gt;:    mov    rdi,r14
</span></span><span style="display:flex;"><span>   0x26bf45 &lt;+69&gt;:    call   0xcf150 &lt;CrstBase::Enter<span style="color:#f92672">()</span>&gt;
</span></span><span style="display:flex;"><span>   0x26bf4a &lt;+74&gt;:    lea    rax,<span style="color:#f92672">[</span>rbx+0x578<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>   0x26bf51 &lt;+81&gt;:    add    rbx,0x570
</span></span><span style="display:flex;"><span>   0x26bf58 &lt;+88&gt;:    test   r15d,r15d
</span></span><span style="display:flex;"><span>   0x26bf5b &lt;+91&gt;:    cmovne rbx,rax
</span></span><span style="display:flex;"><span>   0x26bf5f &lt;+95&gt;:    mov    rdi,QWORD PTR <span style="color:#f92672">[</span>rbx<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>   0x26bf62 &lt;+98&gt;:    test   rdi,rdi
</span></span><span style="display:flex;"><span>   0x26bf65 &lt;+101&gt;:   jne    0x26bf85 &lt;Module::SetDynamicIL<span style="color:#f92672">(</span>unsigned int, unsigned long, int<span style="color:#f92672">)</span>+133&gt;
</span></span><span style="display:flex;"><span>   0x26bf67 &lt;+103&gt;:   mov    edi,0x18
</span></span><span style="display:flex;"><span>   0x26bf6c &lt;+108&gt;:   call   0xa4100 &lt;operator new<span style="color:#f92672">(</span>unsigned long<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>   0x26bf71 &lt;+113&gt;:   mov    rdi,rax
</span></span><span style="display:flex;"><span>   0x26bf74 &lt;+116&gt;:   xorps  xmm0,xmm0
</span></span><span style="display:flex;"><span>   0x26bf77 &lt;+119&gt;:   movups XMMWORD PTR <span style="color:#f92672">[</span>rdi<span style="color:#f92672">]</span>,xmm0
</span></span><span style="display:flex;"><span>   0x26bf7a &lt;+122&gt;:   mov    QWORD PTR <span style="color:#f92672">[</span>rdi+0x10<span style="color:#f92672">]</span>,0x0
</span></span><span style="display:flex;"><span>   0x26bf82 &lt;+130&gt;:   mov    QWORD PTR <span style="color:#f92672">[</span>rbx<span style="color:#f92672">]</span>,rdi
</span></span><span style="display:flex;"><span>   0x26bf85 &lt;+133&gt;:   lea    rsi,<span style="color:#f92672">[</span>rbp-0x30<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>   0x26bf89 &lt;+137&gt;:   call   0x2768b0 &lt;SHash&lt;DynamicILBlobTraits&gt;::AddOrReplace<span style="color:#f92672">(</span>DynamicILBlobEntry const&amp;<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>   0x26bf8e &lt;+142&gt;:   mov    rdi,r14
</span></span><span style="display:flex;"><span>   0x26bf91 &lt;+145&gt;:   call   0xcf0c0 &lt;CrstBase::Leave<span style="color:#f92672">()</span>&gt;
</span></span><span style="display:flex;"><span>   0x26bf96 &lt;+150&gt;:   mov    rax,QWORD PTR fs:0x28
</span></span><span style="display:flex;"><span>   0x26bf9f &lt;+159&gt;:   cmp    rax,QWORD PTR <span style="color:#f92672">[</span>rbp-0x20<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>   0x26bfa3 &lt;+163&gt;:   jne    0x26bfb0 &lt;Module::SetDynamicIL<span style="color:#f92672">(</span>unsigned int, unsigned long, int<span style="color:#f92672">)</span>+176&gt;
</span></span><span style="display:flex;"><span>   0x26bfa5 &lt;+165&gt;:   add    rsp,0x18
</span></span><span style="display:flex;"><span>   0x26bfa9 &lt;+169&gt;:   pop    rbx
</span></span><span style="display:flex;"><span>   0x26bfaa &lt;+170&gt;:   pop    r14
</span></span><span style="display:flex;"><span>   0x26bfac &lt;+172&gt;:   pop    r15
</span></span><span style="display:flex;"><span>   0x26bfae &lt;+174&gt;:   pop    rbp
</span></span><span style="display:flex;"><span>   0x26bfaf &lt;+175&gt;:   ret
</span></span><span style="display:flex;"><span>   0x26bfb0 &lt;+176&gt;:   call   0xa0ac0 &lt;__stack_chk_fail@plt&gt;
</span></span><span style="display:flex;"><span>   0x26bfb5 &lt;+181&gt;:   mov    rdi,rax
</span></span><span style="display:flex;"><span>   0x26bfb8 &lt;+184&gt;:   call   0xa3eb0 &lt;__clang_call_terminate&gt;
</span></span><span style="display:flex;"><span>   0x26bfbd &lt;+189&gt;:   mov    rbx,rax
</span></span><span style="display:flex;"><span>   0x26bfc0 &lt;+192&gt;:   mov    rdi,r14
</span></span><span style="display:flex;"><span>   0x26bfc3 &lt;+195&gt;:   call   0xcf0c0 &lt;CrstBase::Leave<span style="color:#f92672">()</span>&gt;
</span></span><span style="display:flex;"><span>   0x26bfc8 &lt;+200&gt;:   mov    rdi,rbx
</span></span><span style="display:flex;"><span>   0x26bfcb &lt;+203&gt;:   call   0xa0af0 &lt;_Unwind_Resume@plt&gt;
</span></span><span style="display:flex;"><span>   0x26bfd0 &lt;+208&gt;:   mov    rdi,rax
</span></span><span style="display:flex;"><span>   0x26bfd3 &lt;+211&gt;:   call   0xa3eb0 &lt;__clang_call_terminate&gt;
</span></span></code></pre></div><p>OK, that&rsquo;s <strong>a lot</strong> to process. Especially if, like me, you&rsquo;re not that familiar with native disassembly. The trick is to compare it with the original source code (that&rsquo;s why I posted <a href="https://gist.githubusercontent.com/kevingosse/8c2d5b6301930d9dff9e613f7c980ec7"><code>SetDynamicIL</code></a> earlier), and focus exclusively on what you&rsquo;re looking for.</p>
<p>First, we need to locate the <code>this</code> parameter. Object-oriented programming does not exist at the assembly level, so the <code>this</code> pointer that we magically use must be given to the target function somehow. By convention, when calling an instance method, <code>this</code> is the first argument of the function.</p>
<p>Next, we need to know how arguments are given to the function. <a href="https://en.wikipedia.org/wiki/X86_calling_conventions">Calling Wikipedia to the rescue</a>, we learn that Linux uses the &ldquo;System V AMD64 ABI&rdquo; calling convention. In that convention, the first argument of a function is stored in the <code>rdi</code> register.</p>
<p>Now we need some kind of &ldquo;anchor&rdquo;. A well-identified point within the function that we can focus on. Right at the beginning of <code>SetDynamicIL</code>, we find this condition:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (m_debuggerSpecificData.m_pDynamicILCrst <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        InitializeDynamicILCrst();
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>This is great because it uses <code>m_debuggerSpecificData</code> (the field we&rsquo;re looking for), it has a condition, and it calls a method (<code>InitializeDynamicILCrst</code>). This makes it very easy to spot in the disassembly. Now we know we have to focus on this bit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>   0x26bf00 &lt;+0&gt;:     push   rbp
</span></span><span style="display:flex;"><span>   0x26bf01 &lt;+1&gt;:     mov    rbp,rsp
</span></span><span style="display:flex;"><span>   0x26bf04 &lt;+4&gt;:     push   r15
</span></span><span style="display:flex;"><span>   0x26bf06 &lt;+6&gt;:     push   r14
</span></span><span style="display:flex;"><span>   0x26bf08 &lt;+8&gt;:     push   rbx
</span></span><span style="display:flex;"><span>   0x26bf09 &lt;+9&gt;:     sub    rsp,0x18
</span></span><span style="display:flex;"><span>   0x26bf0d &lt;+13&gt;:    mov    r15d,ecx
</span></span><span style="display:flex;"><span>   0x26bf10 &lt;+16&gt;:    mov    rbx,rdi
</span></span><span style="display:flex;"><span>   0x26bf13 &lt;+19&gt;:    mov    rax,QWORD PTR fs:0x28
</span></span><span style="display:flex;"><span>   0x26bf1c &lt;+28&gt;:    mov    QWORD PTR <span style="color:#f92672">[</span>rbp-0x20<span style="color:#f92672">]</span>,rax
</span></span><span style="display:flex;"><span>   0x26bf20 &lt;+32&gt;:    mov    DWORD PTR <span style="color:#f92672">[</span>rbp-0x30<span style="color:#f92672">]</span>,esi
</span></span><span style="display:flex;"><span>   0x26bf23 &lt;+35&gt;:    mov    QWORD PTR <span style="color:#f92672">[</span>rbp-0x28<span style="color:#f92672">]</span>,rdx
</span></span><span style="display:flex;"><span>   0x26bf27 &lt;+39&gt;:    mov    r14,QWORD PTR <span style="color:#f92672">[</span>rbx+0x568<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>   0x26bf2e &lt;+46&gt;:    test   r14,r14
</span></span><span style="display:flex;"><span>   0x26bf31 &lt;+49&gt;:    jne    0x26bf42 &lt;Module::SetDynamicIL<span style="color:#f92672">(</span>unsigned int, unsigned long, int<span style="color:#f92672">)</span>+66&gt;
</span></span><span style="display:flex;"><span>   0x26bf33 &lt;+51&gt;:    mov    rdi,rbx
</span></span><span style="display:flex;"><span>   0x26bf36 &lt;+54&gt;:    call   0x26be90 &lt;Module::InitializeDynamicILCrst<span style="color:#f92672">()</span>&gt;
</span></span></code></pre></div><p>Remember, <code>this</code> is stored in the <code>rdi</code> register. This register is copied to <code>rbx</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>   0x26bf10 &lt;+16&gt;:    mov    rbx,rdi
</span></span></code></pre></div><p>Then we reuse this register here:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>   0x26bf27 &lt;+39&gt;:    mov    r14,QWORD PTR <span style="color:#f92672">[</span>rbx+0x568<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>   0x26bf2e &lt;+46&gt;:    test   r14,r14
</span></span><span style="display:flex;"><span>   0x26bf31 &lt;+49&gt;:    jne    0x26bf42 &lt;Module::SetDynamicIL<span style="color:#f92672">(</span>unsigned int, unsigned long, int<span style="color:#f92672">)</span>+66&gt;
</span></span></code></pre></div><p>This code reads the memory at the address <code>rbx+0x568</code>, pushes the contents to the <code>r14</code> register, then tests something: <code>test r14,r14</code>. Testing a register against itself is the assembly way of checking if a value is empty. That&rsquo;s our <code>if (m_debuggerSpecificData.m_pDynamicILCrst == NULL)</code> check! This means that <code>m_debuggerSpecificData.m_pDynamicILCrst</code> is located at the offset <code>0x568</code> from the address of the module instance.</p>
<p>That&rsquo;s great, but I needed <code>m_debuggerSpecificData.m_pDynamicILBlobTable</code>, not <code>m_debuggerSpecificData.m_pDynamicILCrst</code>. So I had a look at the structure stored in the <code>m_debuggerSpecificData</code> field:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DebuggerSpecificData</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Mutex protecting update access to the DynamicILBlobTable and TemporaryILBlobTable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        PTR_Crst                 m_pDynamicILCrst;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#75715e">// maps tokens for EnC/dynamics/reflection emit to their corresponding IL blobs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                                <span style="color:#75715e">// this map *always* overrides the Metadata RVA
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        PTR_DynamicILBlobTable   m_pDynamicILBlobTable;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#75715e">// maps tokens for to their corresponding overriden IL blobs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                                <span style="color:#75715e">// this map conditionally overrides the Metadata RVA and the DynamicILBlobTable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        PTR_DynamicILBlobTable   m_pTemporaryILBlobTable;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// hash table storing any profiler-provided instrumented IL offset mapping
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        PTR_ILOffsetMappingTable m_pILOffsetMappingTable;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Strict count of # of methods in this module that are JMC-enabled.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        LONG    m_cTotalJMCFuncs;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// The default JMC status for methods in this module.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// Individual methods can be overridden.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">bool</span>    m_fDefaultJMCStatus;
</span></span><span style="display:flex;"><span>    };
</span></span></code></pre></div><p>Fields are stored in memory in the same order as they are declared in the code. So <code>m_pDynamicILBlobTable</code> is the pointer stored right after <code>m_pDynamicILCrst</code> in the memory.</p>
<p>To test this, I first needed the address of the module containing <code>LoadBackendTypes</code>. If you scroll all the way back to where I called <code>dumpmd</code>, you can find it in the output:</p>
<pre tabindex="0"><code>&gt; dumpmd 00007FCF16509B58

Method Name:          Npgsql.PostgresDatabaseInfo+&lt;LoadBackendTypes&gt;d__16.MoveNext()
[...]
Module:               00007fcf13ec67d8
[...]
</code></pre><p>I was looking for the content of the memory at the offset <code>0x568</code> of the Module, so I added that to the Module address to get <code>0x7FCF13EC67D8 + 0x568 = 0x7FCF13EC6D40</code></p>
<p>I then used LLDB to dump the memory at that address:</p>
<pre tabindex="0"><code>(lldb) memory read --count 4 --size 8 --format x 7FCF13EC6D40

0x7fcf13ec6d40: 0x00007fce8c90c820 0x00007fce8c938380
0x7fcf13ec6d50: 0x0000000000000000 0x0000000000000000
</code></pre><p>Assuming my reasoning was correct, <code>0x00007fce8c90c820</code> would be the address of <code>m_pDynamicILCrst</code>, and <code>0x00007fce8c938380</code> the address of <code>m_pDynamicILBlobTable</code>. There was no way to be completely sure, but I could check if the values in memory matched the layout of the table in the source code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>    PTR_element_t m_table;                <span style="color:#75715e">// pointer to table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    count_t       m_tableSize;            <span style="color:#75715e">// allocated size of table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    count_t       m_tableCount;           <span style="color:#75715e">// number of elements in table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    count_t       m_tableOccupied;        <span style="color:#75715e">// number, includes deleted slots
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    count_t       m_tableMax;             <span style="color:#75715e">// maximum occupied count before reallocating
</span></span></span></code></pre></div><p>One pointer to a table, followed by 4 integers indicating the size and the occupancy of the table.</p>
<p>I first dumped the pointer:</p>
<pre tabindex="0"><code>(lldb) memory read --count 2 --size 8 --format x 0x00007fce8c938380

0x7fce8c938380: 0x00007fce8c938a90 0x000000010000000b
</code></pre><p><code>0x00007fce8c938a90</code> sure looks like a pointer to the heap. Then I checked the integers (using <code>size 4</code> instead of <code>size 8</code> ):</p>
<pre tabindex="0"><code>(lldb) memory read --count 8 --size 4 --format x 0x00007fce8c938380

0x7fce8c938380: 0x8c938a90 0x00007fce 0x0000000b 0x00000001
0x7fce8c938390: 0x00000001 0x00000008 0x00000045 0x00000000
</code></pre><p>The pointer was still there (looking backward because of <a href="https://en.wikipedia.org/wiki/Endianness">endianness</a>), then a few small values. I mapped everything to the fields of the table and got:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>m_table         <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00007fce8c938a90</span>
</span></span><span style="display:flex;"><span>m_tableSize     <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0b</span>
</span></span><span style="display:flex;"><span>m_tableCount    <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>m_tableOccupied <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>m_tableMax      <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x8</span>
</span></span></code></pre></div><p>Once again, there was no way to be sure, but the values were consistent with the expected layout, and seemed to indicate that there was one element stored in the table!</p>
<p><code>m_table</code> is a hashtable associating method tokens and pointers to IL code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span>  <span style="color:#a6e22e">DynamicILBlobEntry</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    mdToken     m_methodToken;
</span></span><span style="display:flex;"><span>    TADDR       m_il;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>I must confess I had a bit of trouble figuring out the layout of the hashtable from the source code (full of templates and other C++ magic), so I cheated a bit. I knew from the <code>dumpmd</code> output that my method token was <code>0x6000D24</code>. So I just dumped a bunch of memory at the memory location of the hashtable and looked for that value:</p>
<pre tabindex="0"><code>(lldb) memory read --count 32 --size 4 --format x 0x00007fce8c938a90
0x7fce8c938a90: 0x00000000 0x00007fce 0x00000000 0x00000000
0x7fce8c938aa0: 0x00000000 0x00007fcf 0x00000000 0x00000000
0x7fce8c938ab0: 0x00000000 0x6265645b 0x00000000 0x00000000
0x7fce8c938ac0: 0x00000000 0x6974616c 0x00000000 0x00000000
0x7fce8c938ad0: 0x00000000 0x74636e75 0x00000000 0x00000000
0x7fce8c938ae0: 0x00000000 0x36303437 0x00000000 0x00000000
0x7fce8c938af0: 0x06000d24 0x00000000 0x8c983790 0x00007fce
0x7fce8c938b00: 0x00000000 0x7367704e 0x00000000 0x00000000
</code></pre><p>It turned out that the value was next to a pointer (<code>0x00007fce8c983790</code>, backwards), so there was a good probability that it was pointing to the IL I was looking for!</p>
<p>How to confirm it? Every IL method has a header, so I decompiled the original <code>PostgresDatabaseInfo.LoadBackendTypes</code> method with <a href="https://github.com/0xd4d/dnSpy">dnSpy</a> to look for a remarkable value. The <code>LocalVarSig</code> token had a value of <code>0x11000275</code>:</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4-1.webp" data-fancybox="">
  
    <img class="fig-img" src="/images/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4-1.webp" >
  
    </a>
  
  
</div>

<p>I then dumped a few bytes at the address I found and looked for the value:</p>
<pre tabindex="0"><code>(lldb) memory read --count 8 --size 4 --format x 0x00007fce8c983790

0x7fce8c983790: 0x0002301b 0x000005fe 0x11000275 0x08007b02
0x7fce8c9837a0: 0x020a0400 0x0008037b 0x19060b04 0x0d167936
</code></pre><p>And sure enough, it matched!</p>
<p>The next and final step was to dump the IL and try to understand why it was causing the <code>InvalidProgramException</code>. That will be the subject of the next article.</p>

              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/dotnet/">dotnet</a>

  <a class="tag tag--primary tag--small" href="/tags/debugging/">debugging</a>

  <a class="tag tag--primary tag--small" href="/tags/windbg/">windbg</a>

  <a class="tag tag--primary tag--small" href="/tags/lldb/">lldb</a>

  <a class="tag tag--primary tag--small" href="/tags/cpp/">cpp</a>

  <a class="tag tag--primary tag--small" href="/tags/assembly/">assembly</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1/" data-tooltip="Investigating an InvalidProgramException from a memory dump (part 3 of 3)" aria-label="NEXT: Investigating an InvalidProgramException from a memory dump (part 3 of 3)">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/investigating-an-invalidprogramexception-from-a-memory-dump-part-1-of-3-bce634460cc3/" data-tooltip="Investigating an InvalidProgramException from a memory dump (part 1 of 3)" aria-label="PREVIOUS: Investigating an InvalidProgramException from a memory dump (part 1 of 3)">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            

<link href="https://fonts.googleapis.com/css?family=Cookie&amp;display=swap" rel="stylesheet">
<div class="bmc-btn-container"><a class="bmc-btn" target="_blank" href="https://buymeacoffee.com/kevingosse">☕<span class="bmc-btn-text">Enjoyed the article? Buy me a coffee</span></a></div>

<style>
    .bmc-btn {
        min-width: 210px;
        color: #000000;
        background-color: #FFFFFF !important;
        height: 60px;
        border-radius: 12px;
        font-size: 28px;
        font-weight: Normal;
        border: none;
        line-height: 27px;
        text-decoration: none !important;
        display: inline-flex !important;
        justify-content: center;
        align-items: center;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
    }

    .bmc-btn:hover, .bmc-btn:active, .bmc-btn:focus {
        text-decoration: none !important;
        cursor: pointer;
    }

    .bmc-btn-text {
        margin-left: 8px;
        display: inline-block;
        line-height: 0;
        width: 100%;
        flex-shrink: 0;
        font-family: [FONT] !important;
    }

    .logo-outline {
        fill: #000000;
    }

    .logo-coffee {
        fill: #ffffff;
    }</style>

  
<div id="utterances">
      <noscript>Please enable JavaScript to view the comments powered by Utterances.</noscript>
    </div>
<script src="https://utteranc.es/client.js"
        repo="kevingosse/kevingosse.github.io"
        issue-term="title"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2024 Kevin Gosse. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/investigating-an-invalidprogramexception-from-a-memory-dump-part-3-of-3-c1d912075cb1/" data-tooltip="Investigating an InvalidProgramException from a memory dump (part 3 of 3)" aria-label="NEXT: Investigating an InvalidProgramException from a memory dump (part 3 of 3)">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/investigating-an-invalidprogramexception-from-a-memory-dump-part-1-of-3-bce634460cc3/" data-tooltip="Investigating an InvalidProgramException from a memory dump (part 1 of 3)" aria-label="PREVIOUS: Investigating an InvalidProgramException from a memory dump (part 1 of 3)">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/investigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="2">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fminidump.net%2Finvestigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4%2F" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https%3A%2F%2Fminidump.net%2Finvestigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4%2F" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i><span>Share on Linkedin</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.reddit.com/submit?url=https%3A%2F%2Fminidump.net%2Finvestigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4%2F" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i><span>Share on Reddit</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fminidump.net%2Finvestigating-an-invalidprogramexception-from-a-memory-dump-part-2-of-3-daaecd8f3cf4%2F" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i><span>Share on Hacker News</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>


    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Kevin Gosse</h4>
    
      <div id="about-card-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</div>
    
    
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://minidump.net/images/code.png');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://minidump.net/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

