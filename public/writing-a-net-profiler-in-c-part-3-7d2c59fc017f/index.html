<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <script type="application/ld+json">

{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Writing a .NET profiler in C#   — Part 3",
  
  "image": "https://minidump.net/images/writing-a-net-profiler-in-c-part-3-7d2c59fc017f-1.webp",
  
  "datePublished": "2023-03-03T00:00:00Z",
  "dateModified": "2023-03-03T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Kevin Gosse",
    
    "image": "https://minidump.net/images/profile.png"
    
  },
  "mainEntityOfPage": { 
    "@type": "WebPage",
    "@id": "https:\/\/minidump.net\/writing-a-net-profiler-in-c-part-3-7d2c59fc017f\/" 
  },
  "publisher": {
    "@type": "Organization",
    "name": "minidump.net",
    
    "logo": {
      "@type": "ImageObject",
      "url": "https://minidump.net/images/profile.png"
    }
    
  },
  "description": "Part 3 of the series about using NativeAOT to write a .NET profiler in C#, learning many things about native interop in the process. In this part, we write a source generator to automatically generate the boilerplate code needed to implement the ICorProfilerCallback interface.",
  "keywords": []
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.121.1 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="Kevin Gosse">
<meta name="keywords" content="">
<meta name="description" content="Part 3 of the series about using NativeAOT to write a .NET profiler in C#, learning many things about native interop in the process. In this part, we write a source generator to automatically generate the boilerplate code needed to implement the ICorProfilerCallback interface.">


<meta property="og:description" content="Part 3 of the series about using NativeAOT to write a .NET profiler in C#, learning many things about native interop in the process. In this part, we write a source generator to automatically generate the boilerplate code needed to implement the ICorProfilerCallback interface.">
<meta property="og:type" content="article">
<meta property="og:title" content="Writing a .NET profiler in C#   — Part 3">
<meta name="twitter:title" content="Writing a .NET profiler in C#   — Part 3">
<meta property="og:url" content="https://minidump.net/writing-a-net-profiler-in-c-part-3-7d2c59fc017f/">
<meta property="twitter:url" content="https://minidump.net/writing-a-net-profiler-in-c-part-3-7d2c59fc017f/">
<meta property="og:site_name" content="minidump.net">
<meta property="og:description" content="Part 3 of the series about using NativeAOT to write a .NET profiler in C#, learning many things about native interop in the process. In this part, we write a source generator to automatically generate the boilerplate code needed to implement the ICorProfilerCallback interface.">
<meta name="twitter:description" content="Part 3 of the series about using NativeAOT to write a .NET profiler in C#, learning many things about native interop in the process. In this part, we write a source generator to automatically generate the boilerplate code needed to implement the ICorProfilerCallback interface.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2023-03-03T00:00:00">
  
  
    <meta property="article:modified_time" content="2023-03-03T00:00:00">
  
  
  
  
    
      <meta property="article:tag" content="dotnet">
    
      <meta property="article:tag" content="csharp">
    
      <meta property="article:tag" content="nativeaot">
    
      <meta property="article:tag" content="profiler">
    
      <meta property="article:tag" content="source-generator">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@kookiz">


  <meta name="twitter:creator" content="@kookiz">






  <meta property="og:image" content="https://minidump.net/images/profile.png">
  <meta property="twitter:image" content="https://minidump.net/images/profile.png">





  <meta property="og:image" content="https://minidump.net/images/writing-a-net-profiler-in-c-part-3-7d2c59fc017f-1.webp">
  <meta property="twitter:image" content="https://minidump.net/images/writing-a-net-profiler-in-c-part-3-7d2c59fc017f-1.webp">


    <title>Writing a .NET profiler in C#   — Part 3</title>

    <link rel="icon" href="/favicon.png">
    

    

    <link rel="canonical" href="https://minidump.net/writing-a-net-profiler-in-c-part-3-7d2c59fc017f/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://minidump.net/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/" aria-label="Go to homepage">minidump.net</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about" aria-label="Read more about the author">
          <img class="sidebar-profile-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Kevin Gosse</h4>
        
          <h5 class="sidebar-profile-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/kookiz" target="_blank" rel="noopener" title="Twitter">
    
      <i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/kevingosse" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.buymeacoffee.com/kevingosse" target="_blank" rel="noopener" title="Buy me a coffee">
    
      <i class="sidebar-button-icon fas fa-lg fa-coffee" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Buy me a coffee</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      Writing a .NET profiler in C#   — Part 3
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-03-03T00:00:00Z">
        
  
  
  
  
    March 03 2023
  

      </time>
    
    
  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p><a href="/writing-a-net-profiler-in-c-part-1-d3978aae9b12">In part 1</a>, we saw how NativeAOT can allow us to write a profiler in C#, and how to expose a fake COM object to use the profiling API. <a href="/writing-a-net-profiler-in-c-part-2-8039da001e43">In part 2</a>, we refined the solution to use instance methods instead of static methods. Now that we know how to interact with the profiling API, we&rsquo;re going to write a source generator to automatically generate the boilerplate code needed to implement the 70+ methods declared in the <a href="https://learn.microsoft.com/en-us/dotnet/framework/unmanaged-api/profiling/icorprofilercallback-interface?WT.mc_id=DT-MVP-5003493"><code>ICorProfilerCallback</code></a> interface.</p>
<p>First we need to manually <a href="https://github.com/kevingosse/ManagedDotnetProfiler/blob/a204080e9299b9bb774f0f5d291640fe081fc04c/ManagedDotnetProfiler/ICorProfilerCallback.cs">convert the <code>ICorProfilerCallback</code> interface to C#</a>. Technically it would have been possible to automatically generate this from the C++ header files, but the same C++ code can be translated in different ways in C#, and so it&rsquo;s important to understand the purpose of the functions to convert them with the right semantics.</p>
<p>To take an actual example, consider the <a href="https://learn.microsoft.com/en-us/dotnet/framework/unmanaged-api/profiling/icorprofilercallback-jitinlining-method?WT.mc_id=DT-MVP-5003493"><code>JITInlining</code></a> function. The prototype in C++ is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>HRESULT JITInlining(FunctionID callerId, FunctionID calleeId, BOOL *pfShouldInline);
</span></span></code></pre></div><p>A naïve conversion in C# would be:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>HResult JITInlining(FunctionId callerId, FunctionId calleeId, <span style="color:#66d9ef">bool</span>* pfShouldInline);
</span></span></code></pre></div><p>However, we don&rsquo;t actually need pointers here. If the <code>pfShouldInline</code> argument is read-only we could translate it to:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>HResult JITInlining(FunctionId callerId, FunctionId calleeId, <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">bool</span> pfShouldInline);
</span></span></code></pre></div><p>But if we look at the documentation of the function, we understand that <code>pfShouldInline</code> is a value that should be set by the function itself. So we should instead use the <code>out</code> keyword:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>HResult JITInlining(FunctionId callerId, FunctionId calleeId, <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">bool</span> pfShouldInline);
</span></span></code></pre></div><p>In other cases, we will use <code>in</code> or <code>ref</code> depending on the intent. That&rsquo;s why we can&rsquo;t completely automate the process.</p>
<p>After the interface has been translated to C#, we can proceed with creating the source generator. Note that I don&rsquo;t intend to write a state-of-the-art source generator, mainly because the API is extremely complex (yes, coming from somebody who&rsquo;s explaining how to write a profiler in C#), and you can check <a href="https://andrewlock.net/creating-a-source-generator-part-1-creating-an-incremental-source-generator/">Andrew Lock&rsquo;s excellent articles</a> for that.</p>
<h1 id="writing-a-source-generator">Writing a source generator</h1>
<p>To create the source generator, we add a class library project to the solution that targets <code>netstandard2.0</code>, and we add references to <code>Microsoft.CodeAnalysis.CSharp</code> and <code>Microsoft.CodeAnalysis.Analyzers</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;Project</span> <span style="color:#a6e22e">Sdk=</span><span style="color:#e6db74">&#34;Microsoft.NET.Sdk&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;PropertyGroup&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;TargetFramework&gt;</span>netstandard2.0<span style="color:#f92672">&lt;/TargetFramework&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;ImplicitUsings&gt;</span>enable<span style="color:#f92672">&lt;/ImplicitUsings&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;LangVersion&gt;</span>latest<span style="color:#f92672">&lt;/LangVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;IsRoslynComponent&gt;</span>true<span style="color:#f92672">&lt;/IsRoslynComponent&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/PropertyGroup&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;ItemGroup&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;PackageReference</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;Microsoft.CodeAnalysis.CSharp&#34;</span> <span style="color:#a6e22e">Version=</span><span style="color:#e6db74">&#34;4.0.1&#34;</span> <span style="color:#a6e22e">PrivateAssets=</span><span style="color:#e6db74">&#34;all&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;PackageReference</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;Microsoft.CodeAnalysis.Analyzers&#34;</span> <span style="color:#a6e22e">Version=</span><span style="color:#e6db74">&#34;3.3.3&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;PrivateAssets&gt;</span>all<span style="color:#f92672">&lt;/PrivateAssets&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;IncludeAssets&gt;</span>runtime; build; native; contentfiles; analyzers; buildtransitive<span style="color:#f92672">&lt;/IncludeAssets&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/PackageReference&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/ItemGroup&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/Project&gt;</span>
</span></span></code></pre></div><p>Then we add a class that implements <code>ISourceGenerator</code> , and decorate it with the <code>[Generator]</code> attribute:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#a6e22e">[Generator]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NativeObjectGenerator</span> : ISourceGenerator
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Initialize(GeneratorInitializationContext context)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Execute(GeneratorExecutionContext context)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The first thing we want to do is to emit a <code>[NativeObject]</code> attribute. We will use it to decorate the interfaces that we want to run the source generator on. We use <code>RegisterForPostInitialization</code> to run this code early in the pipeline:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#a6e22e">[Generator]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NativeObjectGenerator</span> : ISourceGenerator
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Initialize(GeneratorInitializationContext context)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        context.RegisterForPostInitialization(EmitAttribute);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Execute(GeneratorExecutionContext context)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> EmitAttribute(GeneratorPostInitializationContext context)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        context.AddSource(<span style="color:#e6db74">&#34;NativeObjectAttribute.g.cs&#34;</span>, <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [AttributeUsage(AttributeTargets.Interface, Inherited = false, AllowMultiple = false)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NativeObjectAttribute</span> : Attribute { }
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now we need to register a <code>ISyntaxContextReceiver</code> to inspect types and detect which ones are decorated with our <code>[NativeObject]</code> attribute.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SyntaxReceiver</span> : ISyntaxContextReceiver
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> List&lt;INamedTypeSymbol&gt; Interfaces { <span style="color:#66d9ef">get</span>; } = <span style="color:#66d9ef">new</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> OnVisitSyntaxNode(GeneratorSyntaxContext context)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (context.Node <span style="color:#66d9ef">is</span> InterfaceDeclarationSyntax classDeclarationSyntax
</span></span><span style="display:flex;"><span>            &amp;&amp; classDeclarationSyntax.AttributeLists.Count &gt; <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> symbol = (INamedTypeSymbol)context.SemanticModel.GetDeclaredSymbol(classDeclarationSyntax);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (symbol.GetAttributes().Any(a =&gt; a.AttributeClass.ToDisplayString() == <span style="color:#e6db74">&#34;NativeObjectAttribute&#34;</span>))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                Interfaces.Add(symbol);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Basically, the syntax receiver is going to be called for every node in the syntax tree. We check if that node is an interface declaration, and if it is we inspect the attributes to find <code>NativeObjectAttribute</code>. There are probably a lot of things that can be improved, especially to confirm if it&rsquo;s <em>our</em> <code>NativeObjectAttribute</code>, but we&rsquo;ll say that&rsquo;s good enough for our purpose.</p>
<p>The syntax receiver needs to be registered during the initialization of our source generator:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Initialize(GeneratorInitializationContext context)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    context.RegisterForPostInitialization(EmitAttribute);
</span></span><span style="display:flex;"><span>    context.RegisterForSyntaxNotifications(() =&gt; <span style="color:#66d9ef">new</span> SyntaxReceiver());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Finally, in the <code>Execute</code> method, we retrieve the list of interfaces that were stored in the syntax receiver, and we generate the code for it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Execute(GeneratorExecutionContext context)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (!(context.SyntaxContextReceiver <span style="color:#66d9ef">is</span> SyntaxReceiver receiver))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> symbol <span style="color:#66d9ef">in</span> receiver.Interfaces)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        EmitStubForInterface(context, symbol);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>

 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/writing-a-net-profiler-in-c-part-3-7d2c59fc017f-1.webp" data-fancybox="">
  
    <img class="fig-img" src="/images/writing-a-net-profiler-in-c-part-3-7d2c59fc017f-1.webp" >
  
    </a>
  
  
</div>

<h1 id="generating-the-native-wrapper">Generating the native wrapper</h1>
<p>For the <code>EmitStubForInterface</code> method, we could use a template engine, but instead we will just rely on a good old <code>StringBuilder</code> and calls to <code>Replace</code>.</p>
<p>First, we create our template:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> sourceBuilder = <span style="color:#66d9ef">new</span> StringBuilder(<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">using</span> System.Runtime.InteropServices;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">namespace</span> NativeObjects
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        {visibility} <span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">class</span> {typeName} : IDisposable
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">private</span> {typeName}({interfaceName} implementation)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> delegateCount = {delegateCount};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">var</span> obj = (IntPtr*)NativeMemory.Alloc((nuint)<span style="color:#ae81ff">2</span> + delegateCount, (nuint)IntPtr.Size);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">var</span> vtable = obj + <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                *obj = (IntPtr)vtable;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">var</span> handle = GCHandle.Alloc(implementation);
</span></span><span style="display:flex;"><span>                *(obj + <span style="color:#ae81ff">1</span>) = GCHandle.ToIntPtr(handle);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {functionPointers}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                Object = (IntPtr)obj;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> IntPtr Object { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> {typeName} Wrap({interfaceName} implementation) =&gt; <span style="color:#66d9ef">new</span>(implementation);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">implicit</span> <span style="color:#66d9ef">operator</span> IntPtr({typeName} stub) =&gt; stub.Object;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ~{typeName}()
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                Dispose();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Dispose()
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (Object != IntPtr.Zero)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    NativeMemory.Free((<span style="color:#66d9ef">void</span>*)Object);
</span></span><span style="display:flex;"><span>                    Object = IntPtr.Zero;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                GC.SuppressFinalize(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Exports</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>    {exports}
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;);
</span></span></span></code></pre></div><p>If there are parts that you don&rsquo;t understand, remember to check <a href="/writing-a-net-profiler-in-c-part-2-8039da001e43">the previous article</a>. The only new thing here is the finalizer and the <code>Dispose</code> method, where we call <code>NativeMemory.Free</code> to free the memory allocated for that object. Then we need to fill all the templated parts: <code>{visibility}</code>, <code>{typeName}</code>, <code>{interfaceName}</code>, <code>{delegateCount}</code>, <code>{functionPointers}</code>, and <code>{exports}</code>.</p>
<p>First the easy ones:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> interfaceName = symbol.ToString();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> typeName = <span style="color:#e6db74">$&#34;{symbol.Name}&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> visibility = symbol.DeclaredAccessibility.ToString().ToLower();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// To be filled later</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> delegateCount = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> exports = <span style="color:#66d9ef">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> functionPointers = <span style="color:#66d9ef">new</span> StringBuilder();
</span></span></code></pre></div><p>For an interface <code>MyProfiler.ICorProfilerCallback</code>, we will generate a wrapper of type <code>NativeObjects.ICorProfilerCallback</code>. That&rsquo;s why we store the fully qualified name in <code>interfaceName</code> (= <code>MyProfiler.ICorProfilerCallback</code>), and just the type name in <code>typeName</code> (= <code>ICorProfilerCallback</code>).</p>
<p>Then we want to generate the list of exports and their function pointers. I want the source generator to support inheritance, to avoid code duplication as <code>ICorProfilerCallback13</code> implements <code>ICorProfilerCallback12</code>, which itself implemeents <code>ICorProfilerCallback11</code>, and so on. So we extract the list of interfaces that the target interface inherit from, and we extract the methods for each of them:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> interfaceList = symbol.AllInterfaces.ToList();
</span></span><span style="display:flex;"><span>interfaceList.Reverse();
</span></span><span style="display:flex;"><span>interfaceList.Add(symbol);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> @interface <span style="color:#66d9ef">in</span> interfaceList)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> member <span style="color:#66d9ef">in</span> @interface.GetMembers())
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (member <span style="color:#66d9ef">is</span> not IMethodSymbol method)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// TODO: Inspect the method</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>For a <code>QueryInterface(in Guid guid, out IntPtr ptr)</code> method, the export that we will generate look like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#a6e22e">[UnmanagedCallersOnly]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> QueryInterface(IntPtr* self, Guid* __arg1, IntPtr* __arg2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> handleAddress = *(self + <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> handle = GCHandle.FromIntPtr(handleAddress);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> obj = (IUnknown)handle.Target;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> result = obj.QueryInterface(*__arg1, <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">var</span> __local2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    *__arg2 = __local2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Because the methods are instance methods, we add the <code>IntPtr* self</code> argument. Also, if the function in the managed interface is decorated with the <code>in</code>/<code>out</code>/<code>ref</code> keyword, we declare the argument as a pointer type because <code>UnmanagedCallersOnly</code> methods do not support <code>in</code>/<code>out</code>/<code>ref</code>.</p>
<p>The resulting code to generate the exports is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> parameterList = <span style="color:#66d9ef">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>parameterList.Append(<span style="color:#e6db74">&#34;IntPtr* self&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> parameter <span style="color:#66d9ef">in</span> method.Parameters)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> isPointer = parameter.RefKind == RefKind.None ? <span style="color:#e6db74">&#34;&#34;</span> : <span style="color:#e6db74">&#34;*&#34;</span>;
</span></span><span style="display:flex;"><span>    parameterList.Append(<span style="color:#e6db74">$&#34;, {parameter.Type}{isPointer} __arg{parameter.Ordinal}&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exports.AppendLine(<span style="color:#e6db74">$&#34;            [UnmanagedCallersOnly]&#34;</span>);
</span></span><span style="display:flex;"><span>exports.AppendLine(<span style="color:#e6db74">$&#34;            public static {method.ReturnType} {method.Name}({parameterList})&#34;</span>);
</span></span><span style="display:flex;"><span>exports.AppendLine(<span style="color:#e6db74">$&#34;            {{&#34;</span>);
</span></span><span style="display:flex;"><span>exports.AppendLine(<span style="color:#e6db74">$&#34;                var handle = GCHandle.FromIntPtr(*(self + 1));&#34;</span>);
</span></span><span style="display:flex;"><span>exports.AppendLine(<span style="color:#e6db74">$&#34;                var obj = ({interfaceName})handle.Target;&#34;</span>);
</span></span><span style="display:flex;"><span>exports.Append(<span style="color:#e6db74">$&#34;                &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (!method.ReturnsVoid)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    exports.Append(<span style="color:#e6db74">&#34;var result = &#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exports.Append(<span style="color:#e6db74">$&#34;obj.{method.Name}(&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; method.Parameters.Length; i++)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (i &gt; <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        exports.Append(<span style="color:#e6db74">&#34;, &#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (method.Parameters[i].RefKind == RefKind.In)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        exports.Append(<span style="color:#e6db74">$&#34;*__arg{i}&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (method.Parameters[i].RefKind <span style="color:#66d9ef">is</span> RefKind.Out)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        exports.Append(<span style="color:#e6db74">$&#34;out var __local{i}&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        exports.Append(<span style="color:#e6db74">$&#34;__arg{i}&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exports.AppendLine(<span style="color:#e6db74">&#34;);&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; method.Parameters.Length; i++)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (method.Parameters[i].RefKind <span style="color:#66d9ef">is</span> RefKind.Out)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        exports.AppendLine(<span style="color:#e6db74">$&#34;                *__arg{i} = __local{i};&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (!method.ReturnsVoid)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    exports.AppendLine(<span style="color:#e6db74">$&#34;                return result;&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exports.AppendLine(<span style="color:#e6db74">$&#34;            }}&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exports.AppendLine();
</span></span><span style="display:flex;"><span>exports.AppendLine();
</span></span></code></pre></div><p>For the function pointers, given the same method as before, we want to generate:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>*(vtable + <span style="color:#ae81ff">1</span>) = (IntPtr)(<span style="color:#66d9ef">delegate</span>* unmanaged&lt;IntPtr*, Guid*, IntPtr*&gt;)&amp;Exports.QueryInterface;
</span></span></code></pre></div><p>The code to generate it is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> sourceArgsList = <span style="color:#66d9ef">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>sourceArgsList.Append(<span style="color:#e6db74">&#34;IntPtr _&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; method.Parameters.Length; i++)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    sourceArgsList.Append(<span style="color:#e6db74">$&#34;, {method.Parameters[i].OriginalDefinition} a{i}&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>functionPointers.Append(<span style="color:#e6db74">$&#34;            *(vtable + {delegateCount}) = (IntPtr)(delegate* unmanaged&lt;IntPtr*&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; method.Parameters.Length; i++)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    functionPointers.Append(<span style="color:#e6db74">$&#34;, {method.Parameters[i].Type}&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (method.Parameters[i].RefKind != RefKind.None)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        functionPointers.Append(<span style="color:#e6db74">&#34;*&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (method.ReturnsVoid)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    functionPointers.Append(<span style="color:#e6db74">&#34;, void&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    functionPointers.Append(<span style="color:#e6db74">$&#34;, {method.ReturnType}&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>functionPointers.AppendLine(<span style="color:#e6db74">$&#34;&gt;)&amp;Exports.{method.Name};&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>delegateCount++;
</span></span></code></pre></div><p>Once we&rsquo;ve done that for every method in the interface, we just need to replace the values in our template and add the generated source file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>sourceBuilder.Replace(<span style="color:#e6db74">&#34;{typeName}&#34;</span>, typeName);
</span></span><span style="display:flex;"><span>sourceBuilder.Replace(<span style="color:#e6db74">&#34;{visibility}&#34;</span>, visibility);
</span></span><span style="display:flex;"><span>sourceBuilder.Replace(<span style="color:#e6db74">&#34;{exports}&#34;</span>, exports.ToString());
</span></span><span style="display:flex;"><span>sourceBuilder.Replace(<span style="color:#e6db74">&#34;{interfaceName}&#34;</span>, interfaceName);
</span></span><span style="display:flex;"><span>sourceBuilder.Replace(<span style="color:#e6db74">&#34;{delegateCount}&#34;</span>, delegateCount.ToString());
</span></span><span style="display:flex;"><span>sourceBuilder.Replace(<span style="color:#e6db74">&#34;{functionPointers}&#34;</span>, functionPointers.ToString());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context.AddSource(<span style="color:#e6db74">$&#34;{symbol.ContainingNamespace?.Name ?? &#34;</span>_<span style="color:#e6db74">&#34;}.{symbol.Name}.g.cs&#34;</span>, sourceBuilder.ToString());
</span></span></code></pre></div><p>And that&rsquo;s it, our source generator is now ready.</p>
<h1 id="using-the-generated-code">Using the generated code</h1>
<p>To use our source generator, we can declare the <code>IUnknown</code>, <code>IClassFactory</code>, and <code>ICorProfilerCallback</code> interfaces, and decorate them with the <code>[NativeObject]</code> attribute:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#a6e22e">[NativeObject]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IUnknown</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    HResult QueryInterface(<span style="color:#66d9ef">in</span> Guid guid, <span style="color:#66d9ef">out</span> IntPtr ptr);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> AddRef();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> Release();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#a6e22e">[NativeObject]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IClassFactory</span> : IUnknown
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    HResult CreateInstance(IntPtr outer, <span style="color:#66d9ef">in</span> Guid guid, <span style="color:#66d9ef">out</span> IntPtr instance);
</span></span><span style="display:flex;"><span>    HResult LockServer(<span style="color:#66d9ef">bool</span> @lock);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#a6e22e">[NativeObject]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">ICorProfilerCallback</span> : IUnknown
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    HResult Initialize(IntPtr pICorProfilerInfoUnk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 70+ methods, stripped for brevity</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Then we implement <code>IClassFactory</code> and call <code>NativeObjects.IClassFactory.Wrap</code> to create the native wrapper and expose our instance of <code>ICorProfilerCallback</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClassFactory</span> : IClassFactory
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> NativeObjects.IClassFactory _classFactory;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> CorProfilerCallback2 _corProfilerCallback;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ClassFactory()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _classFactory = NativeObjects.IClassFactory.Wrap(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The native wrapper has an implicit cast operator to IntPtr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> IntPtr Object =&gt; _classFactory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> HResult CreateInstance(IntPtr outer, <span style="color:#66d9ef">in</span> Guid guid, <span style="color:#66d9ef">out</span> IntPtr instance)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Console.WriteLine(<span style="color:#e6db74">&#34;[Profiler] ClassFactory - CreateInstance&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        _corProfilerCallback = <span style="color:#66d9ef">new</span>();
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        instance = _corProfilerCallback.Object;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> HResult.S_OK;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> HResult LockServer(<span style="color:#66d9ef">bool</span> @lock)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">default</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> HResult QueryInterface(<span style="color:#66d9ef">in</span> Guid guid, <span style="color:#66d9ef">out</span> IntPtr ptr)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Console.WriteLine(<span style="color:#e6db74">&#34;[Profiler] ClassFactory - QueryInterface - &#34;</span> + guid);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (guid == KnownGuids.ClassFactoryGuid)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            ptr = Object;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> HResult.S_OK;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ptr = IntPtr.Zero;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> HResult.E_NOTIMPL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> AddRef()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// TODO: do actual reference counting</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Release()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// TODO: do actual reference counting</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And expose it in <code>DllGetClassObject</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DllMain</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> ClassFactory Instance;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [UnmanagedCallersOnly(EntryPoint = &#34;DllGetClassObject&#34;)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">int</span> DllGetClassObject(<span style="color:#66d9ef">void</span>* rclsid, <span style="color:#66d9ef">void</span>* riid, nint* ppv)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Console.WriteLine(<span style="color:#e6db74">&#34;[Profiler] DllGetClassObject&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Instance = <span style="color:#66d9ef">new</span> ClassFactory();
</span></span><span style="display:flex;"><span>        *ppv = Instance.Object;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And finally, we can implement our instance of <code>ICorProfilerCallback</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CorProfilerCallback2</span> : ICorProfilerCallback2
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> Guid ICorProfilerCallback2Guid = Guid.Parse(<span style="color:#e6db74">&#34;8a8cc829-ccf2-49fe-bbae-0f022228071a&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> NativeObjects.ICorProfilerCallback2 _corProfilerCallback2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> CorProfilerCallback2()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _corProfilerCallback2 = NativeObjects.ICorProfilerCallback2.Wrap(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> IntPtr Object =&gt; _corProfilerCallback2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> HResult Initialize(IntPtr pICorProfilerInfoUnk)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Console.WriteLine(<span style="color:#e6db74">&#34;[Profiler] ICorProfilerCallback2 - Initialize&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// TODO: To be implemented in next article</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> HResult.S_OK;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> HResult QueryInterface(<span style="color:#66d9ef">in</span> Guid guid, <span style="color:#66d9ef">out</span> IntPtr ptr)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (guid == ICorProfilerCallback2Guid)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Console.WriteLine(<span style="color:#e6db74">&#34;[Profiler] ICorProfilerCallback2 - QueryInterface&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ptr = Object;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> HResult.S_OK;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ptr = IntPtr.Zero;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> HResult.E_NOTIMPL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Stripped for brevity: the default implementation of all 70+ methods of the interface</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Automatically generated by the IDE</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If we run it with a test application, we can see that the functions are working as expected:</p>
<pre tabindex="0"><code>[Profiler] DllGetClassObject
[Profiler] ClassFactory - CreateInstance
[Profiler] ICorProfilerCallback2 - QueryInterface
[Profiler] ICorProfilerCallback2 - Initialize
Hello, World!
</code></pre><p>In the next step, we will take care of the last missing piece of the puzzle: implementing the <code>ICorProfilerCallback.Initialize</code> method, and retrieving the instance of <code>ICorProfilerInfo</code>. Then we will have everything we need to actually interact with the profiler API.</p>

              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/dotnet/">dotnet</a>

  <a class="tag tag--primary tag--small" href="/tags/csharp/">csharp</a>

  <a class="tag tag--primary tag--small" href="/tags/nativeaot/">nativeaot</a>

  <a class="tag tag--primary tag--small" href="/tags/profiler/">profiler</a>

  <a class="tag tag--primary tag--small" href="/tags/source-generator/">source-generator</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/verificationexception-in-net-framework-when-using-structs-6269eb3df448/" data-tooltip="VerificationException in .NET Framework when using structs" aria-label="NEXT: VerificationException in .NET Framework when using structs">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/reading-net-performance-counters-without-the-perfcounter-api-aca5eab08874/" data-tooltip="Reading .NET performance counters without the PerfCounter API" aria-label="PREVIOUS: Reading .NET performance counters without the PerfCounter API">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/writing-a-net-profiler-in-c-part-3-7d2c59fc017f/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/writing-a-net-profiler-in-c-part-3-7d2c59fc017f/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/writing-a-net-profiler-in-c-part-3-7d2c59fc017f/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/writing-a-net-profiler-in-c-part-3-7d2c59fc017f/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            

<link href="https://fonts.googleapis.com/css?family=Cookie&amp;display=swap" rel="stylesheet">
<div class="bmc-btn-container"><a class="bmc-btn" target="_blank" href="https://buymeacoffee.com/kevingosse">☕<span class="bmc-btn-text">Enjoyed the article? Buy me a coffee</span></a></div>

<style>
    .bmc-btn {
        min-width: 210px;
        color: #000000;
        background-color: #FFFFFF !important;
        height: 60px;
        border-radius: 12px;
        font-size: 28px;
        font-weight: Normal;
        border: none;
        line-height: 27px;
        text-decoration: none !important;
        display: inline-flex !important;
        justify-content: center;
        align-items: center;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
    }

    .bmc-btn:hover, .bmc-btn:active, .bmc-btn:focus {
        text-decoration: none !important;
        cursor: pointer;
    }

    .bmc-btn-text {
        margin-left: 8px;
        display: inline-block;
        line-height: 0;
        width: 100%;
        flex-shrink: 0;
        font-family: [FONT] !important;
    }

    .logo-outline {
        fill: #000000;
    }

    .logo-coffee {
        fill: #ffffff;
    }</style>

  
<div id="utterances">
      <noscript>Please enable JavaScript to view the comments powered by Utterances.</noscript>
    </div>
<script src="https://utteranc.es/client.js"
        repo="kevingosse/kevingosse.github.io"
        issue-term="title"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 Kevin Gosse. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/verificationexception-in-net-framework-when-using-structs-6269eb3df448/" data-tooltip="VerificationException in .NET Framework when using structs" aria-label="NEXT: VerificationException in .NET Framework when using structs">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/reading-net-performance-counters-without-the-perfcounter-api-aca5eab08874/" data-tooltip="Reading .NET performance counters without the PerfCounter API" aria-label="PREVIOUS: Reading .NET performance counters without the PerfCounter API">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/writing-a-net-profiler-in-c-part-3-7d2c59fc017f/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/writing-a-net-profiler-in-c-part-3-7d2c59fc017f/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/writing-a-net-profiler-in-c-part-3-7d2c59fc017f/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/writing-a-net-profiler-in-c-part-3-7d2c59fc017f/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="2">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fminidump.net%2Fwriting-a-net-profiler-in-c-part-3-7d2c59fc017f%2F" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https%3A%2F%2Fminidump.net%2Fwriting-a-net-profiler-in-c-part-3-7d2c59fc017f%2F" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i><span>Share on Linkedin</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.reddit.com/submit?url=https%3A%2F%2Fminidump.net%2Fwriting-a-net-profiler-in-c-part-3-7d2c59fc017f%2F" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i><span>Share on Reddit</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fminidump.net%2Fwriting-a-net-profiler-in-c-part-3-7d2c59fc017f%2F" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i><span>Share on Hacker News</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>


    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Kevin Gosse</h4>
    
      <div id="about-card-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</div>
    
    
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://minidump.net/images/code.png');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://minidump.net/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

