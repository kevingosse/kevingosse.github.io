<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <script type="application/ld+json">

{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Debugging a native deadlock in a .NET Linux application",
  
  "datePublished": "2021-02-09T00:00:00Z",
  "dateModified": "2021-02-09T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Kevin Gosse",
    
    "image": "https://minidump.net/images/profile.png"
    
  },
  "mainEntityOfPage": { 
    "@type": "WebPage",
    "@id": "https:\/\/minidump.net\/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd\/" 
  },
  "publisher": {
    "@type": "Organization",
    "name": "minidump.net",
    
    "logo": {
      "@type": "ImageObject",
      "url": "https://minidump.net/images/profile.png"
    }
    
  },
  "description": "This story begins when one of our integrations tests started got stuck on one PR that seemingly impacted unrelated code. This is a nice excuse to cover some concepts I haven\u0026rsquo;t touched in my previous articles, such as downloading the .NET symbols on Linux.",
  "keywords": []
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.121.1 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="Kevin Gosse">
<meta name="keywords" content="">
<meta name="description" content="This story begins when one of our integrations tests started got stuck on one PR that seemingly impacted unrelated code. This is a nice excuse to cover some concepts I haven&rsquo;t touched in my previous articles, such as downloading the .NET symbols on Linux.">


<meta property="og:description" content="This story begins when one of our integrations tests started got stuck on one PR that seemingly impacted unrelated code. This is a nice excuse to cover some concepts I haven&rsquo;t touched in my previous articles, such as downloading the .NET symbols on Linux.">
<meta property="og:type" content="article">
<meta property="og:title" content="Debugging a native deadlock in a .NET Linux application">
<meta name="twitter:title" content="Debugging a native deadlock in a .NET Linux application">
<meta property="og:url" content="https://minidump.net/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd/">
<meta property="twitter:url" content="https://minidump.net/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd/">
<meta property="og:site_name" content="minidump.net">
<meta property="og:description" content="This story begins when one of our integrations tests started got stuck on one PR that seemingly impacted unrelated code. This is a nice excuse to cover some concepts I haven&rsquo;t touched in my previous articles, such as downloading the .NET symbols on Linux.">
<meta name="twitter:description" content="This story begins when one of our integrations tests started got stuck on one PR that seemingly impacted unrelated code. This is a nice excuse to cover some concepts I haven&rsquo;t touched in my previous articles, such as downloading the .NET symbols on Linux.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2021-02-09T00:00:00">
  
  
    <meta property="article:modified_time" content="2021-02-09T00:00:00">
  
  
  
  
    
      <meta property="article:tag" content="dotnet">
    
      <meta property="article:tag" content="debugging">
    
      <meta property="article:tag" content="lldb">
    
      <meta property="article:tag" content="windbg">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@kookiz">


  <meta name="twitter:creator" content="@kookiz">






  <meta property="og:image" content="https://minidump.net/images/profile.png">
  <meta property="twitter:image" content="https://minidump.net/images/profile.png">






    <title>Debugging a native deadlock in a .NET Linux application</title>

    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    

    

    <link rel="canonical" href="https://minidump.net/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://minidump.net/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    <script>
    (function(h,o,u,n,d) {
      h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}}
      d=o.createElement(u);d.async=1;d.src=n
      n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n)
    })(window,document,'script','https://www.datadoghq-browser-agent.com/us1/v5/datadog-rum.js','DD_RUM')
    window.DD_RUM.onReady(function() {
      window.DD_RUM.init({
        clientToken: 'pubabeb7320d5ecb81f3b14a17c35c1a3de',
        applicationId: '78b5d24e-77d4-4bba-ae37-5a46f7386b95',
        site: 'datadoghq.com',
        service: 'minidump.net',
        env: 'kevin',
        sessionSampleRate: 100,
        sessionReplaySampleRate: 20,
        trackUserInteractions: true,
        trackResources: true,
        trackLongTasks: true,
        defaultPrivacyLevel: 'mask-user-input',
      });
    })
</script>
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/" aria-label="Go to homepage">minidump.net</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about" aria-label="Read more about the author">
          <img class="sidebar-profile-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Kevin Gosse</h4>
        
          <h5 class="sidebar-profile-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/kookiz" target="_blank" rel="noopener" title="Twitter">
    
      <i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/kevingosse" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.buymeacoffee.com/kevingosse" target="_blank" rel="noopener" title="Buy me a coffee">
    
      <i class="sidebar-button-icon fas fa-lg fa-coffee" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Buy me a coffee</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      Debugging a native deadlock in a .NET Linux application
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2021-02-09T00:00:00Z">
        
  
  
  
  
    February 09 2021
  

      </time>
    
    
  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>This story begins when one of our integrations tests started got stuck on one PR that seemingly impacted unrelated code. This is a nice excuse to cover some concepts I haven&rsquo;t touched in my previous articles, such as downloading the .NET symbols on Linux.</p>
<h1 id="preliminary-inspection">Preliminary inspection</h1>
<p>The failure was occurring in a Linux test. After a while, I managed to reproduce the issue locally in a docker container. Usually the first step would be to attach a debugger, but I didn&rsquo;t want to spend the time to find the commands to inject the debugger in the container. So I started by capturing a memory dump with dotnet-dump:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ dotnet-dump collect -p &lt;pid&gt; --type Full
</span></span></code></pre></div><p>Note that a heap-only memory dump (<code>--type Heap</code>) should be enough in theory, but I&rsquo;ve had so much trouble with those in the past that I now always capture full dump unless I have a compelling reason not to.</p>
<p>I then used the <code>dotnet-dump analyze</code> command to open it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ dotnet-dump analyze core_20210205_190420
</span></span><span style="display:flex;"><span>Loading core dump: core_20210205_190420 ...
</span></span><span style="display:flex;"><span>Ready to process analysis commands. Type <span style="color:#e6db74">&#39;help&#39;</span> to list available commands or <span style="color:#e6db74">&#39;help [command]&#39;</span> to get detailed help on a command.
</span></span><span style="display:flex;"><span>Type <span style="color:#e6db74">&#39;quit&#39;</span> or <span style="color:#e6db74">&#39;exit&#39;</span> to exit the session.
</span></span><span style="display:flex;"><span>&gt;
</span></span></code></pre></div><p>The integration test was getting stuck, so I was looking for a deadlock of sorts. I started by using the <code>pstacks</code> command to get an overview of the callstacks:</p>
<pre tabindex="0"><code>&gt; pstacks

________________________________________________
 ~~~~ c52
    1 System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start(__Canon ByRef)
    1 System.Runtime.CompilerServices.AsyncTaskMethodBuilder.Start(__Canon ByRef)
    1 Samples.HttpMessageHandler.Program.Main(String[])
    1 Samples.HttpMessageHandler.Program.&lt;Main&gt;(String[])


________________________________________________
 ~~~~ c79
    1 Datadog.Trace.Agent.Api+&lt;SendTracesAsync&gt;d__9.MoveNext()
    1 System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start(__Canon ByRef)
    1 System.Runtime.CompilerServices.AsyncTaskMethodBuilder&lt;System.Boolean&gt;.AsyncTaskMethodBuilder`1(__Canon ByRef)
    1 Datadog.Trace.Agent.Api.SendTracesAsync(Span[][])
    1 Datadog.Trace.Agent.AgentWriter.Ping()
    1 Datadog.Trace.Tracer+&lt;WriteDiagnosticLog&gt;d__54.MoveNext()
    1 System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start(__Canon ByRef)
    1 System.Runtime.CompilerServices.AsyncTaskMethodBuilder.Start(__Canon ByRef)
    1 Datadog.Trace.Tracer.WriteDiagnosticLog()
    1 System.Threading.Tasks.Task&lt;System.__Canon&gt;.InnerInvoke()
    1 System.Threading.Tasks.Task+&lt;&gt;c.cctor&gt;b__274_0(Object)
    1 System.Threading.ExecutionContext.RunFromThreadPoolDispatchLoop(Thread, ExecutionContext, ContextCallback, Object)
    1 System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task ByRef, Thread)
    1 System.Threading.Tasks.Task.ExecuteEntryUnsafe(Thread)
    1 System.Threading.Tasks.Task.ExecuteFromThreadPool(Thread)
    1 System.Threading.ThreadPoolWorkQueue.Dispatch()
    1 System.Threading._ThreadPoolWaitCallback.PerformWaitCallback()


==&gt; 2 threads with 2 roots
</code></pre><p>This revealed one thread executing <code>Datadog.Trace.Agent.Api.SendTracesAsync</code>. This method has no synchronization, so no obvious reason to get stuck. Just to be extra sure it was actually stuck (verifying your assumptions can save you a lot of time in the long run), I captured a second memory dump and confirmed that the same thread was stuck in the same method.</p>
<p>Looking for more information, I decided to have a closer look at the callstack using <code>clrstack</code>. <code>pstacks</code> indicated that the OS thread id was <code>c79</code>, unfortunately that&rsquo;s not a value I could use directly. Instead, I ran <code>clrthreads</code> to dump the list of managed threads:</p>
<pre tabindex="0"><code>&gt; clrthreads

ThreadCount:      7
UnstartedThread:  0
BackgroundThread: 6
PendingThread:    0
DeadThread:       0
Hosted Runtime:   no
                                                                                                            Lock
 DBG   ID     OSID ThreadOBJ           State GC Mode     GC Alloc Context                  Domain           Count Apt Exception
   0    1      c52 0000559EA26B4180    20020 Preemptive  00007F2800061320:00007F2800061FD0 0000559EA25C8590 0     Ukn (GC)
   8    2      c5b 0000559EA26A5260    21220 Preemptive  0000000000000000:0000000000000000 0000559EA25C8590 0     Ukn (Finalizer)
  10    3      c5d 00007F27F4000C50  1020220 Preemptive  0000000000000000:0000000000000000 0000559EA25C8590 0     Ukn (Threadpool Worker)
  11    4      c5e 00007F27F4001C10  1021220 Preemptive  00007F280005CA50:00007F280005DFD0 0000559EA25C8590 0     Ukn (Threadpool Worker)
  13    5      c77 00007F27E8002DA0  1021220 Preemptive  00007F280005E2E8:00007F280005FFD0 0000559EA25C8590 0     Ukn (Threadpool Worker)
  15    6      c79 0000559EA2E8B990  1021222 Cooperative 00007F2800062D28:00007F2800063FD0 0000559EA25C8590 0     Ukn (Threadpool Worker)
  16    7      c7a 00007F27D80014F0  1021220 Preemptive  00007F2800064258:00007F2800065FD0 0000559EA25C8590 0     Ukn (Threadpool Worker)
</code></pre><p>I looked for the one with the value <code>c79</code> in the <code>OSID</code> column, then took the value of the <code>DBG</code> column (15). Then I could feed that value to the <code>setthread</code> command. An alternative is to convert the OS thread id to decimal (c79 = 3193), then use the <code>-t</code> parameter of the <code>setthread</code> command:</p>
<pre tabindex="0"><code>&gt; setthread 15
&gt; setthread -t 3193
</code></pre><p>Then I could run the <code>clrstack</code> command to get the detailed callstack:</p>
<pre tabindex="0"><code>&gt; clrstack

OS Thread Id: 0xc79 (15)
        Child SP               IP Call Site
00007F288A3F4D10 00007f28a117129c [PrestubMethodFrame: 00007f288a3f4d10] Datadog.Trace.Agent.Transports.ApiWebRequestFactory.Create(System.Uri)
00007F288A3F4E80 00007F2827A3DDAD Datadog.Trace.Agent.Api+&lt;SendTracesAsync&gt;d__9.MoveNext()
00007F288A3F5100 00007F2827A3263F System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[[System.__Canon, System.Private.CoreLib]](System.__Canon ByRef) [/_/src/System.Private.CoreLib/shared/System/Runtime/CompilerServices/AsyncMethodBuilder.cs @ 1015]
00007F288A3F5180 00007F2827A3D595 System.Runtime.CompilerServices.AsyncTaskMethodBuilder`1[[System.Boolean, System.Private.CoreLib]].Start[[System.__Canon, System.Private.CoreLib]](System.__Canon ByRef) [/_/src/System.Private.CoreLib/shared/System/Runtime/CompilerServices/AsyncMethodBuilder.cs @ 350]
00007F288A3F51C0 00007F2827A3D46F Datadog.Trace.Agent.Api.SendTracesAsync(Datadog.Trace.Span[][])
00007F288A3F5210 00007F2827A3D364 Datadog.Trace.Agent.AgentWriter.Ping()
00007F288A3F5250 00007F2827A3BD8D Datadog.Trace.Tracer+&lt;WriteDiagnosticLog&gt;d__54.MoveNext()
00007F288A3F55D0 00007F2827A3263F System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[[System.__Canon, System.Private.CoreLib]](System.__Canon ByRef) [/_/src/System.Private.CoreLib/shared/System/Runtime/CompilerServices/AsyncMethodBuilder.cs @ 1015]
00007F288A3F5650 00007F2827A32595 System.Runtime.CompilerServices.AsyncTaskMethodBuilder.Start[[System.__Canon, System.Private.CoreLib]](System.__Canon ByRef) [/_/src/System.Private.CoreLib/shared/System/Runtime/CompilerServices/AsyncMethodBuilder.cs @ 223]
00007F288A3F5690 00007F2827A3908A Datadog.Trace.Tracer.WriteDiagnosticLog()
00007F288A3F56E0 00007F2827A31C2E System.Threading.Tasks.Task`1[[System.__Canon, System.Private.CoreLib]].InnerInvoke() [/_/src/System.Private.CoreLib/shared/System/Threading/Tasks/Future.cs @ 518]
00007F288A3F5760 00007F2827A316B1 System.Threading.Tasks.Task+&lt;&gt;c.&lt;.cctor&gt;b__274_0(System.Object) [/_/src/System.Private.CoreLib/shared/System/Threading/Tasks/Task.cs @ 2427]
00007F288A3F5790 00007F2827A313EF System.Threading.ExecutionContext.RunFromThreadPoolDispatchLoop(System.Threading.Thread, System.Threading.ExecutionContext, System.Threading.ContextCallback, System.Object) [/_/src/System.Private.CoreLib/shared/System/Threading/ExecutionContext.cs @ 289]
00007F288A3F5810 00007F2827A30D25 System.Threading.Tasks.Task.ExecuteWithThreadLocal(System.Threading.Tasks.Task ByRef, System.Threading.Thread) [/_/src/System.Private.CoreLib/shared/System/Threading/Tasks/Task.cs @ 2389]
00007F288A3F58D0 00007F2827A307B0 System.Threading.Tasks.Task.ExecuteEntryUnsafe(System.Threading.Thread) [/_/src/System.Private.CoreLib/shared/System/Threading/Tasks/Task.cs @ 2321]
00007F288A3F5900 00007F2827A3070F System.Threading.Tasks.Task.ExecuteFromThreadPool(System.Threading.Thread) [/_/src/System.Private.CoreLib/shared/System/Threading/Tasks/Task.cs @ 2312]
00007F288A3F5920 00007F2827A2EE7D System.Threading.ThreadPoolWorkQueue.Dispatch() [/_/src/System.Private.CoreLib/shared/System/Threading/ThreadPool.cs @ 663]
00007F288A3F5980 00007F2827A2E459 System.Threading._ThreadPoolWaitCallback.PerformWaitCallback() [/_/src/System.Private.CoreLib/src/System/Threading/ThreadPool.CoreCLR.cs @ 29]
00007F288A3F5D30 00007f28a02a6d0f [DebuggerU2MCatchHandlerFrame: 00007f288a3f5d30]
</code></pre><p>This uncovered an interesting piece of data: the thread was not actually stuck on <code>Datadog.Trace.Agent.Api.SendTracesAsync</code> but on a &ldquo;<code>PrestubMethodFrame</code>&rdquo; pointing to <code>Datadog.Trace.Agent.Transports.ApiWebRequestFactory.Create</code>. I guessed this was the stub used to trigger the JIT-compilation of the method. To confirm that hypothesis, I checked if the method was already JIT-compiled:</p>
<pre tabindex="0"><code>&gt; name2ee Datadog.Trace.dll Datadog.Trace.Agent.Transports.ApiWebRequestFactory.Create

Module:      00007f2827457ab0
Assembly:    Datadog.Trace.dll
Token:       0000000006001C88
MethodDesc:  00007f28279df8e8
Name:        Datadog.Trace.Agent.Transports.ApiWebRequestFactory.Create(System.Uri)
Not JITTED yet. Use &#39;bpmd -md 00007F28279DF8E8&#39; to break on run.
</code></pre><p>An alternative would have been to use the <code>dumpmt -md</code> command with the pointer to the method table:</p>
<pre tabindex="0"><code>&gt; dumpmt -md 00007f28279df908

EEClass:         00007F2827AC7AD0
Module:          00007F2827457AB0
Name:            Datadog.Trace.Agent.Transports.ApiWebRequestFactory
mdToken:         00000000020003D6
File:            /project/test/test-applications/integrations/Samples.HttpMessageHandler/bin/Debug/netcoreapp3.0/publish/Datadog.Trace.dll
BaseSize:        0x18
ComponentSize:   0x0
DynamicStatics:  false
ContainsPointers false
Slots in VTable: 7
Number of IFaces in IFaceMap: 1
--------------------------------------
MethodDesc Table
           Entry       MethodDesc    JIT Name
00007F2826E90090 00007F282649C570   NONE System.Object.Finalize()
00007F2826E90098 00007F282649C580   NONE System.Object.ToString()
00007F2826E900A0 00007F282649C590   NONE System.Object.Equals(System.Object)
00007F2826E900B8 00007F282649C5D0   NONE System.Object.GetHashCode()
00007F28279F99E8 00007F28279DF8D8   NONE Datadog.Trace.Agent.Transports.ApiWebRequestFactory.Info(System.Uri)
00007F28279F99F0 00007F28279DF8E8   NONE Datadog.Trace.Agent.Transports.ApiWebRequestFactory.Create(System.Uri)
00007F2827A2A370 00007F28279DF8F8    JIT Datadog.Trace.Agent.Transports.ApiWebRequestFactory..ctor()
</code></pre><p>You can fetch the MT using <code>dumpmodule -mt &lt;module address&gt;</code>, and the module address using <code>dumpdomain</code>… Yeah, <code>name2ee</code> is usually faster.</p>
<p>Anyway, both <code>name2ee</code> and <code>dumpmt</code> revealed that the method wasn&rsquo;t JIT-compiled yet. Given that our product patches the code during JIT compilation, it wasn&rsquo;t really surprising to me that something could go wrong in that part of the process. In any case, it was time to switch to native debugging to get more information.</p>
<h1 id="one-layer-deeper">One layer deeper</h1>
<p>LLDB is the recommended debugger to use with the CLR on Linux, though GDB works fine in most scenarios.</p>
<p>On most Linux distributions, you can get LLDB using your package manager:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo apt install lldb
</span></span></code></pre></div><p>If not (for instance, if you&rsquo;re using CentOS), good luck <a href="https://lldb.llvm.org/resources/build.html">building it from the source</a>.</p>
<p>Even though I don&rsquo;t use it for this investigation, I also recommend <a href="https://docs.microsoft.com/en-us/dotnet/core/diagnostics/dotnet-sos?WT.mc_id=DT-MVP-5003493">installing dotnet-sos</a> then running the <code>dotnet-sos install</code> command. This will update your LLDB profile to automatically load SOS, which is very convenient.</p>
<p>Then you can load the memory dump in LLDB:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ lldb -c core_20210205_190420
</span></span><span style="display:flex;"><span>Added Microsoft public symbol server
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>lldb<span style="color:#f92672">)</span> target create --core <span style="color:#e6db74">&#34;core_20210205_190420&#34;</span>
</span></span><span style="display:flex;"><span>Core file <span style="color:#e6db74">&#39;/temp/core_20210205_190420&#39;</span> <span style="color:#f92672">(</span>x86_64<span style="color:#f92672">)</span> was loaded.
</span></span></code></pre></div><p>I used the <code>thread backtrace</code> command to display the callstack of the first thread:</p>
<pre tabindex="0"><code>(lldb) thread backtrace

* thread #1, name = &#39;dotnet&#39;, stop reason = signal SIGABRT
  * frame #0: 0x00007f28a116e3f9 libpthread.so.0`__pthread_cond_timedwait + 761
    frame #1: 0x00007f28a04d070b libcoreclr.so`___lldb_unnamed_symbol14084$$libcoreclr.so + 299
    frame #2: 0x00007f28a04d0324 libcoreclr.so`___lldb_unnamed_symbol14083$$libcoreclr.so + 388
    frame #3: 0x00007f28a04d493f libcoreclr.so`___lldb_unnamed_symbol14151$$libcoreclr.so + 1743
    frame #4: 0x00007f28a04d4be9 libcoreclr.so`___lldb_unnamed_symbol14153$$libcoreclr.so + 89
    frame #5: 0x00007f28a0271064 libcoreclr.so`___lldb_unnamed_symbol5709$$libcoreclr.so + 228
    frame #6: 0x00007f28a0275263 libcoreclr.so`___lldb_unnamed_symbol5770$$libcoreclr.so + 931
    frame #7: 0x00007f28a02768fe libcoreclr.so`___lldb_unnamed_symbol5788$$libcoreclr.so + 446
    frame #8: 0x00007f28a018838c libcoreclr.so`___lldb_unnamed_symbol2479$$libcoreclr.so + 892
    frame #9: 0x00007f28a023f23c libcoreclr.so`___lldb_unnamed_symbol5125$$libcoreclr.so + 300
    frame #10: 0x00007f289c9ee613 Datadog.Trace.ClrProfiler.Native.so`trace::CorProfiler::CallTarget_RequestRejitForModule(unsigned long, trace::ModuleMetadata*, std::vector&lt;trace::IntegrationMethod, std::allocator&lt;trace::IntegrationMethod&gt; &gt; const&amp;) + 4563
    frame #11: 0x00007f289c9ed248 Datadog.Trace.ClrProfiler.Native.so`trace::CorProfiler::ModuleLoadFinished(unsigned long, int) + 5544
    frame #12: 0x00007f28a01f7a79 libcoreclr.so`___lldb_unnamed_symbol4010$$libcoreclr.so + 105
[...]
</code></pre><p>There&rsquo;s a lot of noise but I could still deduce that code from <code>Datadog.Trace.ClrProfiler.Native</code> was waiting for… something in <code>libcoreclr.so</code>.</p>
<p>I then looked for the thread that we spotted in <code>dotnet-dump</code> (the one with the thread id (c79 / 3193) and inspected its callstack:</p>
<pre tabindex="0"><code>(lldb) thread list

Process 3154 stopped
* thread #1: tid = 3154, 0x00007f28a116e3f9 libpthread.so.0`__pthread_cond_timedwait + 761, name = &#39;dotnet&#39;, stop reason = signal SIGABRT
  thread #2: tid = 3156, 0x00007f28a0d6cf59 libc.so.6`syscall + 25, stop reason = signal SIGABRT
  thread #3: tid = 3157, 0x00007f28a0d6cf59 libc.so.6`syscall + 25, stop reason = signal SIGABRT
  thread #4: tid = 3158, 0x00007f28a0d67819 libc.so.6`__poll + 73, stop reason = signal SIGABRT
  thread #5: tid = 3159, 0x00007f28a1171d0e libpthread.so.0`__libc_open64 + 206, stop reason = signal SIGABRT
  thread #6: tid = 3160, 0x00007f28a116e00c libpthread.so.0`__pthread_cond_wait + 508, stop reason = signal SIGABRT
  thread #7: tid = 3161, 0x00007f28a116e00c libpthread.so.0`__pthread_cond_wait + 508, stop reason = signal SIGABRT
  thread #8: tid = 3162, 0x00007f28a116e35b libpthread.so.0`__pthread_cond_timedwait + 603, stop reason = signal SIGABRT
  thread #9: tid = 3163, 0x00007f28a116e3f9 libpthread.so.0`__pthread_cond_timedwait + 761, stop reason = signal SIGABRT
  thread #10: tid = 3164, 0x00007f28a11720ca libpthread.so.0`__waitpid + 74, stop reason = signal SIGABRT
  thread #11: tid = 3165, 0x00007f28a116e00c libpthread.so.0`__pthread_cond_wait + 508, stop reason = signal SIGABRT
  thread #12: tid = 3166, 0x00007f28a116e00c libpthread.so.0`__pthread_cond_wait + 508, stop reason = signal SIGABRT
  thread #13: tid = 3167, 0x00007f28a116e3f9 libpthread.so.0`__pthread_cond_timedwait + 761, stop reason = signal SIGABRT
  thread #14: tid = 3191, 0x00007f28a116e00c libpthread.so.0`__pthread_cond_wait + 508, stop reason = signal SIGABRT
  thread #15: tid = 3192, 0x00007f28a116e00c libpthread.so.0`__pthread_cond_wait + 508, stop reason = signal SIGABRT
  thread #16: tid = 3193, 0x00007f28a117129c libpthread.so.0`__lll_lock_wait + 28, stop reason = signal SIGABRT
  thread #17: tid = 3194, 0x00007f28a116e00c libpthread.so.0`__pthread_cond_wait + 508, stop reason = signal SIGABRT

(lldb) thread select 16

* thread #16, stop reason = signal SIGABRT
    frame #0: 0x00007f28a117129c libpthread.so.0`__lll_lock_wait + 28
libpthread.so.0`__lll_lock_wait:
-&gt;  0x7f28a117129c &lt;+28&gt;: movl   %edx, %eax
    0x7f28a117129e &lt;+30&gt;: xchgl  %eax, (%rdi)
    0x7f28a11712a0 &lt;+32&gt;: testl  %eax, %eax
    0x7f28a11712a2 &lt;+34&gt;: jne    0x7f28a1171295            ; &lt;+21&gt;

(lldb) thread backtrace

* thread #16, stop reason = signal SIGABRT
  * frame #0: 0x00007f28a117129c libpthread.so.0`__lll_lock_wait + 28
    frame #1: 0x00007f28a116a714 libpthread.so.0`__GI___pthread_mutex_lock + 84
    frame #2: 0x00007f289c9faf83 Datadog.Trace.ClrProfiler.Native.so`__gthread_mutex_lock(pthread_mutex_t*) + 35
    frame #3: 0x00007f289ca462b8 Datadog.Trace.ClrProfiler.Native.so`std::mutex::lock() + 24
    frame #4: 0x00007f289c9fc943 Datadog.Trace.ClrProfiler.Native.so`std::lock_guard&lt;std::mutex&gt;::lock_guard(std::mutex&amp;) + 35
    frame #5: 0x00007f289c9eb449 Datadog.Trace.ClrProfiler.Native.so`trace::CorProfiler::AssemblyLoadFinished(unsigned long, int) + 185
    frame #6: 0x00007f28a01f82c9 libcoreclr.so`___lldb_unnamed_symbol4024$$libcoreclr.so + 105
    frame #7: 0x00007f28a02c1017 libcoreclr.so`___lldb_unnamed_symbol6779$$libcoreclr.so + 647
[...]
</code></pre><p>This thread was also executing code in <code>Datadog.Trace.ClrProfiler.Native</code>, and waited on a global lock that we use to protect our data structures. So it looked like the first thread was holding the lock and calling some code in <code>libcoreclr</code>, and the other thread was waiting for this lock to be freed. The last missing piece was figuring out why the code in <code>libcoreclr</code> was taking so long.</p>
<p>.NET Core ships without the internal symbols, but they can be downloaded <a href="https://docs.microsoft.com/en-us/dotnet/core/diagnostics/dotnet-symbol?WT.mc_id=DT-MVP-5003493">using the <code>dotnet-symbol</code> tool</a>. It&rsquo;s very simple to use, just indicate the location of the memory dump and the folder to write the symbols to:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ dotnet-symbol /temp/core_20210205_190420 -o /symbols/
</span></span></code></pre></div><p>Downloading all the symbols will take a few minutes. You may get an error when downloading the symbols for <code>libcoreclr.so</code> (&ldquo;Unable to read data from the transport connection: Operation canceled&rdquo;). That&rsquo;s because the tool has a hardcoded 4 minutes timeout, and the symbol server is very slow when accessed outside of the United States. There is already <a href="https://github.com/dotnet/symstore/issues/246">an issue to track that</a>, until it&rsquo;s fixed I suggest you clone <a href="https://github.com/dotnet/symstore/">the <code>dotnet/symstore</code> github repository</a>, and <a href="https://github.com/dotnet/symstore/blob/98717c63ec8342acf8a07aa5c909b88bd0c664cc/src/Microsoft.SymbolStore/SymbolStores/HttpSymbolStore.cs#L68">change the value of the timeout in the <code>HttpSymbolStore</code> class</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>            <span style="color:#75715e">// Normal unauthenticated client</span>
</span></span><span style="display:flex;"><span>            _client = <span style="color:#66d9ef">new</span> HttpClient {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Timeout = TimeSpan.FromMinutes(4)</span>
</span></span><span style="display:flex;"><span>                Timeout = TimeSpan.FromMinutes(<span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>            };
</span></span></code></pre></div><p>Then you can use the provided <code>build.sh</code> script to compile your changes, and you&rsquo;ll find your fixed version of dotnet-symbol in the <code>artifacts/bin/dotnet-symbol/</code> folder.</p>
<p>Then you can feed those symbols to LLDB:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ lldb -O <span style="color:#e6db74">&#34;settings set target.debug-file-search-paths /symbols/&#34;</span> -c core_20210205_190420
</span></span></code></pre></div><p>Or if like me you&rsquo;re too lazy to remember/find/type this <code>settings set target.debug-file-search-paths</code> thing, just copy all the symbols in the same folder as the memory dump and it&rsquo;ll work just fine.</p>
<p>With the symbols, I could get more information about what the first thread was doing:</p>
<pre tabindex="0"><code>(lldb) thread backtrace

* thread #1, name = &#39;dotnet&#39;, stop reason = signal SIGABRT
  * frame #0: 0x00007f28a116e3f9 libpthread.so.0`__pthread_cond_timedwait + 761
    frame #1: 0x00007f28a04d070b libcoreclr.so`CorUnix::CPalSynchronizationManager::ThreadNativeWait(ptnwdNativeWaitData=&lt;unavailable&gt;, dwTimeout=&lt;unavailable&gt;, ptwrWakeupReason=&lt;unavailable&gt;, pdwSignaledObject=&lt;unavailable&gt;) at synchmanager.cpp:484
    frame #2: 0x00007f28a04d0324 libcoreclr.so`CorUnix::CPalSynchronizationManager::BlockThread(this=0x0000559ea25b5280, pthrCurrent=0x0000559ea2586f70, dwTimeout=10, fAlertable=false, fIsSleep=&lt;unavailable&gt;, ptwrWakeupReason=0x00007ffc65d75338, pdwSignaledObject=&lt;unavailable&gt;) at synchmanager.cpp:302
    frame #3: 0x00007f28a04d493f libcoreclr.so`CorUnix::InternalWaitForMultipleObjectsEx(pThread=0x0000559ea2586f70, nCount=&lt;unavailable&gt;, lpHandles=&lt;unavailable&gt;, bWaitAll=&lt;unavailable&gt;, dwMilliseconds=&lt;unavailable&gt;, bAlertable=&lt;unavailable&gt;, bPrioritize=&lt;unavailable&gt;) at wait.cpp:640
    frame #4: 0x00007f28a04d4be9 libcoreclr.so`::WaitForSingleObjectEx(hHandle=&lt;unavailable&gt;, dwMilliseconds=10, bAlertable=NO) at wait.cpp:139
    frame #5: 0x00007f28a0271064 libcoreclr.so`CLREventBase::WaitEx(unsigned int, WaitMode, PendingSync*) [inlined] CLREventWaitHelper2(handle=&lt;unavailable&gt;, dwMilliseconds=&lt;unavailable&gt;, alertable=&lt;unavailable&gt;) at synch.cpp:377
    frame #6: 0x00007f28a027105f libcoreclr.so`CLREventBase::WaitEx(unsigned int, WaitMode, PendingSync*) [inlined] CLREventWaitHelper(void*, unsigned int, int)::$_1::operator()(CLREventWaitHelper(void*, unsigned int, int)::Param*) const at synch.cpp:402
    frame #7: 0x00007f28a0271051 libcoreclr.so`CLREventBase::WaitEx(unsigned int, WaitMode, PendingSync*) at synch.cpp:404
    frame #8: 0x00007f28a0270fe7 libcoreclr.so`CLREventBase::WaitEx(this=&lt;unavailable&gt;, dwMilliseconds=10, mode=&lt;unavailable&gt;, syncState=0x0000000000000000) at synch.cpp:471
    frame #9: 0x00007f28a0275263 libcoreclr.so`ThreadSuspend::SuspendRuntime(reason=&lt;unavailable&gt;) at threadsuspend.cpp:4187
    frame #10: 0x00007f28a02768fe libcoreclr.so`ThreadSuspend::SuspendEE(reason=&lt;unavailable&gt;) at threadsuspend.cpp:6512
    frame #11: 0x00007f28a018838c libcoreclr.so`ReJitManager::UpdateActiveILVersions(cFunctions=2, rgModuleIDs=0x0000559ea2e8d840, rgMethodDefs=&lt;unavailable&gt;, rgHrStatuses=&lt;unavailable&gt;, fIsRevert=240, flags=&lt;unavailable&gt;) at rejit.cpp:684
    frame #12: 0x00007f28a023f23c libcoreclr.so`ProfToEEInterfaceImpl::RequestReJIT(this=&lt;unavailable&gt;, cFunctions=2, moduleIds=0x0000559ea2e8d840, methodIds=0x0000559ea2e8eaa0) at proftoeeinterfaceimpl.cpp:8741
    frame #13: 0x00007f289c9ee613 Datadog.Trace.ClrProfiler.Native.so`trace::CorProfiler::CallTarget_RequestRejitForModule(unsigned long, trace::ModuleMetadata*, std::vector&lt;trace::IntegrationMethod, std::allocator&lt;trace::IntegrationMethod&gt; &gt; const&amp;) + 4563
    frame #14: 0x00007f289c9ed248 Datadog.Trace.ClrProfiler.Native.so`trace::CorProfiler::ModuleLoadFinished(unsigned long, int) + 5544
    frame #15: 0x00007f28a01f7a79 libcoreclr.so`EEToProfInterfaceImpl::ModuleLoadFinished(this=0x0000559ea2542310, moduleId=139810444038688, hrStatus=0) at eetoprofinterfaceimpl.cpp:3746
[...]
</code></pre><p>The thread was calling <code>ProfToEEInterfaceImpl::RequestReJIT</code> which in turn was calling <code>ThreadSuspend::SuspendRuntime</code>. From there I had the full picture: the first thread was holding the global lock and indirectly calling <code>ThreadSuspend::SuspendRuntime</code>. This method blocks until all the managed threads are suspended. At the same time, the other thread was waiting on the global lock to JIT a method, which causes the deadlock.</p>
<p>The fix was simply to run our ReJIT operations on a dedicated native thread, outside of the global shared lock.</p>
<p>Interestingly, <a href="https://docs.microsoft.com/en-us/dotnet/framework/unmanaged-api/profiling/icorprofilerinfo4-requestrejit-method?WT.mc_id=DT-MVP-5003493#remarks">this behavior and the recommended fix are actually documented</a>, so I guess we should just have spent more time reading the documentation.</p>

              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/dotnet/">dotnet</a>

  <a class="tag tag--primary tag--small" href="/tags/debugging/">debugging</a>

  <a class="tag tag--primary tag--small" href="/tags/lldb/">lldb</a>

  <a class="tag tag--primary tag--small" href="/tags/windbg/">windbg</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a/" data-tooltip="An unconventional way of investigating a NullReferenceException" aria-label="NEXT: An unconventional way of investigating a NullReferenceException">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c/" data-tooltip="AccessViolation in ObjectNative::IsLockHeld (part 2 of 2)" aria-label="PREVIOUS: AccessViolation in ObjectNative::IsLockHeld (part 2 of 2)">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            

<link href="https://fonts.googleapis.com/css?family=Cookie&amp;display=swap" rel="stylesheet">
<div class="bmc-btn-container"><a class="bmc-btn" target="_blank" href="https://buymeacoffee.com/kevingosse">☕<span class="bmc-btn-text">Enjoyed the article? Buy me a coffee</span></a></div>

<style>
    .bmc-btn {
        min-width: 210px;
        color: #000000;
        background-color: #FFFFFF !important;
        height: 60px;
        border-radius: 12px;
        font-size: 28px;
        font-weight: Normal;
        border: none;
        line-height: 27px;
        text-decoration: none !important;
        display: inline-flex !important;
        justify-content: center;
        align-items: center;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
    }

    .bmc-btn:hover, .bmc-btn:active, .bmc-btn:focus {
        text-decoration: none !important;
        cursor: pointer;
    }

    .bmc-btn-text {
        margin-left: 8px;
        display: inline-block;
        line-height: 0;
        width: 100%;
        flex-shrink: 0;
        font-family: [FONT] !important;
    }

    .logo-outline {
        fill: #000000;
    }

    .logo-coffee {
        fill: #ffffff;
    }</style>

  
<div id="utterances">
      <noscript>Please enable JavaScript to view the comments powered by Utterances.</noscript>
    </div>
<script src="https://utteranc.es/client.js"
        repo="kevingosse/kevingosse.github.io"
        issue-term="title"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2024 Kevin Gosse. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a/" data-tooltip="An unconventional way of investigating a NullReferenceException" aria-label="NEXT: An unconventional way of investigating a NullReferenceException">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/accessviolation-in-objectnative-islockheld-part-2-of-2-a703e484113c/" data-tooltip="AccessViolation in ObjectNative::IsLockHeld (part 2 of 2)" aria-label="PREVIOUS: AccessViolation in ObjectNative::IsLockHeld (part 2 of 2)">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="2">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fminidump.net%2Finvestigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd%2F" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https%3A%2F%2Fminidump.net%2Finvestigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd%2F" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i><span>Share on Linkedin</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.reddit.com/submit?url=https%3A%2F%2Fminidump.net%2Finvestigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd%2F" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i><span>Share on Reddit</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fminidump.net%2Finvestigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd%2F" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i><span>Share on Hacker News</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>


    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Kevin Gosse</h4>
    
      <div id="about-card-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</div>
    
    
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://minidump.net/images/code.png');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://minidump.net/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

