<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <script type="application/ld+json">

{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "SuppressGCTransition",
  
  "image": "https://minidump.net/images/suppressgctransition-b9a8a774edbd-3.webp",
  
  "datePublished": "2023-08-12T00:00:00Z",
  "dateModified": "2023-08-12T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Kevin Gosse",
    
    "image": "https://minidump.net/images/profile.png"
    
  },
  "mainEntityOfPage": { 
    "@type": "WebPage",
    "@id": "https:\/\/minidump.net\/suppressgctransition-b9a8a774edbd\/" 
  },
  "publisher": {
    "@type": "Organization",
    "name": "minidump.net",
    
    "logo": {
      "@type": "ImageObject",
      "url": "https://minidump.net/images/profile.png"
    }
    
  },
  "description": "Deep-dive into the SuppressGCTransition attribute introduced in .NET 5.",
  "keywords": []
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.121.1 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="Kevin Gosse">
<meta name="keywords" content="">
<meta name="description" content="Deep-dive into the SuppressGCTransition attribute introduced in .NET 5.">


<meta property="og:description" content="Deep-dive into the SuppressGCTransition attribute introduced in .NET 5.">
<meta property="og:type" content="article">
<meta property="og:title" content="SuppressGCTransition">
<meta name="twitter:title" content="SuppressGCTransition">
<meta property="og:url" content="https://minidump.net/suppressgctransition-b9a8a774edbd/">
<meta property="twitter:url" content="https://minidump.net/suppressgctransition-b9a8a774edbd/">
<meta property="og:site_name" content="minidump.net">
<meta property="og:description" content="Deep-dive into the SuppressGCTransition attribute introduced in .NET 5.">
<meta name="twitter:description" content="Deep-dive into the SuppressGCTransition attribute introduced in .NET 5.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2023-08-12T00:00:00">
  
  
    <meta property="article:modified_time" content="2023-08-12T00:00:00">
  
  
  
  
    
      <meta property="article:tag" content="dotnet">
    
      <meta property="article:tag" content="performance">
    
      <meta property="article:tag" content="garbage-collection">
    
      <meta property="article:tag" content="assembly">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@kookiz">


  <meta name="twitter:creator" content="@kookiz">






  <meta property="og:image" content="https://minidump.net/images/profile.png">
  <meta property="twitter:image" content="https://minidump.net/images/profile.png">





  <meta property="og:image" content="https://minidump.net/images/suppressgctransition-b9a8a774edbd-3.webp">
  <meta property="twitter:image" content="https://minidump.net/images/suppressgctransition-b9a8a774edbd-3.webp">


    <title>SuppressGCTransition</title>

    <link rel="icon" href="/favicon.png">
    

    

    <link rel="canonical" href="https://minidump.net/suppressgctransition-b9a8a774edbd/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://minidump.net/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/" aria-label="Go to homepage">minidump.net</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about" aria-label="Read more about the author">
          <img class="sidebar-profile-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Kevin Gosse</h4>
        
          <h5 class="sidebar-profile-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/kookiz" target="_blank" rel="noopener" title="Twitter">
    
      <i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/kevingosse" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.buymeacoffee.com/kevingosse" target="_blank" rel="noopener" title="Buy me a coffee">
    
      <i class="sidebar-button-icon fas fa-lg fa-coffee" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Buy me a coffee</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      SuppressGCTransition
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-08-12T00:00:00Z">
        
  
  
  
  
    August 12 2023
  

      </time>
    
    
  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>While working on the second edition of the Pro .NET Memory Management book, I did some research on <a href="https://learn.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.suppressgctransitionattribute?view=net-7.0&amp;WT.mc_id=DT-MVP-5003493">the <code>SuppressGCTransition</code> attribute</a> introduced in .NET 5, and figured it would make a nice complimentary article.</p>
<p><code>SuppressGCTransition</code> is an attribute you can only apply on a method decorated with the <code>DllImport</code> attribute. It greatly reduces the overhead of the p/invoke, as illustrated with this benchmark:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SuppressGcTransitionBenchmark</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [Benchmark(Baseline = true)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> PInvoke()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Increment(<span style="color:#ae81ff">42</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [DllImport(&#34;NativeLib.dll&#34;)]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">int</span> Increment(<span style="color:#66d9ef">int</span> <span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [Benchmark]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> PInvoke_With_SuppressGCTransition()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Increment(<span style="color:#ae81ff">42</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [DllImport(&#34;NativeLib.dll&#34;)]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [SuppressGCTransition]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">int</span> Increment(<span style="color:#66d9ef">int</span> <span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>As a side-note, I discovered when writing this code that you could declare p/invoke as local functions. It&rsquo;s a great feature, since you often need to wrap your p/invokes in a managed function.</p>
</blockquote>
<p><code>Increment</code> is implemented in a native DLL, and simply increments the value of the argument:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">__declspec</span>(dllexport) <span style="color:#66d9ef">int32_t</span> Increment(<span style="color:#66d9ef">int32_t</span> value)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> value <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The results are impressive:</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/suppressgctransition-b9a8a774edbd-1.webp" data-fancybox="">
  
    <img class="fig-img" src="/images/suppressgctransition-b9a8a774edbd-1.webp" >
  
    </a>
  
  
</div>

<p>Just by adding the <code>SuppressGCTransition</code> attribute, the p/invoke was sped up by 4 times!</p>
<p>So, does it mean you should run to your codebase and add the magical attribute everywhere?</p>
<p>Well, not so fast.</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">What are the cons of SuppressGCTransition? There must be a catch...</p>&mdash; Stefán Jökull Sigurðarson (@stebets) <a href="https://twitter.com/stebets/status/1690050962646351872?ref_src=twsrc%5Etfw">August 11, 2023</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>As <a href="https://twitter.com/stebets">Stefán Jökull Sigurðarson</a> cleverly pointed out in response to my bait, there has to be a catch, or .NET would just apply this optimization by default.</p>
<p>Consider this new benchmark:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SuppressGcTransitionBlockingBenchmark</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> Length = <span style="color:#ae81ff">50_000</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> NumberOfTasks = <span style="color:#ae81ff">32</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [ParamsAllValues]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> SuppressGCTransition { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [Benchmark]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Task Concatenate()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> tasks = <span style="color:#66d9ef">new</span> Task&lt;<span style="color:#66d9ef">string</span>&gt;[NumberOfTasks];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; NumberOfTasks; i++)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            tasks[i] = Task.Factory.StartNew(() =&gt;
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">var</span> str = <span style="color:#66d9ef">string</span>.Empty;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; <span style="color:#ae81ff">10</span>; i++)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">var</span> newStr = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">string</span>(<span style="color:#e6db74">&#39;c&#39;</span>, Length);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">var</span> buffer = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span>[str.Length + newStr.Length];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    Concatenate(str, newStr, buffer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    str = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">string</span>(buffer);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> str;
</span></span><span style="display:flex;"><span>            }, TaskCreationOptions.LongRunning);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Task.WhenAll(tasks);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> Concatenate(<span style="color:#66d9ef">string</span> str1, <span style="color:#66d9ef">string</span> str2, <span style="color:#66d9ef">char</span>[] buffer)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (SuppressGCTransition)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Concatenate_With_SuppressGCTransition(str1, str2, buffer);            
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Concatenate_Default(str1, str2, buffer);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [DllImport(&#34;NativeLib.dll&#34;, EntryPoint = &#34;Concatenate&#34;)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">void</span> Concatenate_Default(<span style="color:#66d9ef">string</span> str1, <span style="color:#66d9ef">string</span> str2, <span style="color:#66d9ef">char</span>[] buffer);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [DllImport(&#34;NativeLib.dll&#34;, EntryPoint = &#34;Concatenate&#34;)]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [SuppressGCTransition]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">void</span> Concatenate_With_SuppressGCTransition(<span style="color:#66d9ef">string</span> str1, <span style="color:#66d9ef">string</span> str2, <span style="color:#66d9ef">char</span>[] buffer);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>There&rsquo;s a lot more going on here, let&rsquo;s break it down. The Concatenate benchmark starts 32 threads. Each thread enters a loop where it will call the native <code>Concatenate</code> function 10 times to concatenate two strings into a char buffer, then convert it back to a string for the next iteration. Depending on the settings of the benchmark, the native <code>Concatenate</code> function will be called with or without <code>SuppressGCTransition</code>.</p>
<p>The native function is implemented as below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">__declspec</span>(dllexport) <span style="color:#66d9ef">void</span> Concatenate(WCHAR <span style="color:#f92672">*</span> str1, WCHAR <span style="color:#f92672">*</span> str2, WCHAR <span style="color:#f92672">*</span> output)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Sleep(<span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#f92672">*</span>str1 <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;\0&#39;</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>output <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>str1;
</span></span><span style="display:flex;"><span>        output<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        str1<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#f92672">*</span>str2 <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;\0&#39;</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>output <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>str2;
</span></span><span style="display:flex;"><span>        output<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        str2<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The function waits 100 ms, then concatenates the two strings into the char buffer.</p>
<p>This is of course a very dumb and inefficient way of concatenating strings, but I needed an example of code with the following characteristics:</p>
<ol>
<li>
<p>Multiple threads</p>
</li>
<li>
<p>Lots of heap allocations</p>
</li>
<li>
<p>A native function that takes a significant amount of time to execute</p>
</li>
</ol>
<p>While my example is not realistic, note that the vast majority of real world applications satisfy conditions 1 and 2.</p>
<p>Anyway, let&rsquo;s run this benchmark and see what happens.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/suppressgctransition-b9a8a774edbd-2.webp" data-fancybox="">
  
    <img class="fig-img" src="/images/suppressgctransition-b9a8a774edbd-2.webp" >
  
    </a>
  
  
</div>

<p>The benchmark gets almost twice as slow when <code>SuppressGCTransition</code> is enabled. How is that possible? Isn&rsquo;t it supposed to magically speed up p/invokes?</p>
<p>To understand what&rsquo;s going on, let&rsquo;s first explain what the attribute is actually doing.</p>
<h1 id="preemptive-gc-vs-cooperative-gc">Preemptive GC vs cooperative GC</h1>
<p>The main effect of <code>SuppressGCTransition</code>, when applied on a <code>DllImport</code> method, is to prevent the thread transition from cooperative GC mode to preemptive GC mode.</p>
<p>What are cooperative and preemptive mode? By default, .NET threads run in cooperative mode. When a collection is triggered, the garbage collector will try to suspend all cooperative threads, and make sure they&rsquo;re stopped at a safe spot. The process is complex and described <a href="https://github.com/dotnet/runtime/blob/main/docs/design/coreclr/botr/threading.md#hijacking">in this document</a>. Note that if the thread is stopped at an unsafe spot, it will be immediately resumed and the GC will wait for it to suspend itself as soon as possible. Once all the threads are safely suspended, the GC can proceed with the collection.</p>
<p>But what about native code? How do you ask a native thread to suspend itself at a safe spot? The short answer is: you don&rsquo;t. If you think about it, you don&rsquo;t have to: suspension is needed for managed code because the GC might move memory and invalidate pointers. Native functions aren&rsquo;t supposed to access managed memory (or only pinned objects that won&rsquo;t be moved), so they&rsquo;re not impacted by the garbage collector. Therefore, native threads run in preemptive mode, or &ldquo;I don&rsquo;t care about the GC&rdquo; mode. The garbage collector will collect memory and move objects around without asking preemptive threads to be suspended.</p>
<p>To summarize, managed threads run in cooperative mode: they&rsquo;re expected to cooperate with the GC to find a safe spot to stop when the GC wants to run a collection. Native threads run in preemptive mode: they can do whatever they want and the GC won&rsquo;t wait for them before triggering a collection.</p>
<p>What about p/invokes? During p/invokes, a managed thread ends up executing native code, so it won&rsquo;t be able to suspend itself if the GC needs to run. To allow the GC to run anyway, it switches itself to preemptive mode before executing the native code. When returning from the native call, it switches back to cooperative mode. But what if a collection was triggered while running the native method? The GC would have started moving memory without waiting for the p/invoke to exit (because the thread was in preemptive mode) and executing managed code would be unsafe. So before switching back to cooperative, the thread checks if a collection is in progress and immediately suspends itself if needed.</p>
<p>The term &ldquo;GC transition&rdquo; designates that moment when the thread switches to preemptive mode when executing a p/invoke, and switches back to cooperative mode at the end. One drawback is that it adds some overhead to the method call. The absolute cost is low (if you look at the benchmark at the beginning of the article, you will see that it&rsquo;s just a few nanoseconds). However, if you call a native method that only does a trivial amount of computations (say for instance, reading a value from memory) then the relative overhead becomes significant (4 times slower in my benchmark). <code>SuppressGCTransition</code> has been introduced to allow you to suppress that overhead when it makes sense. It comes with a number of drawbacks. The main one is that no GC collection can run while a p/invoke decorated with <code>SuppressGCTransition</code> is running. That&rsquo;s because the thread stays in cooperative mode, so the GC waits for it to suspend itself. If the p/invoke takes a significant amount of time to execute, as illustrated in my second benchmark, then all managed threads stop executing when a collection is triggered, and have to wait until that last thread finally suspends itself, which will only happen at the end of the native call. In the end, <code>SuppressGCTransition</code> is only safe to use when the cost of the native call is guaranteed to be smaller than the cost of the GC transition (that is, a few nanoseconds). Especially, it should never be applied on native calls that rely on I/Os or synchronization: even if they only take a few nanoseconds to execute in 99% of the cases, that one time when the I/O is delayed will have a dramatic impact on the performance of your application.</p>
<h1 id="effect-on-the-debugger">Effect on the debugger</h1>
<p>The previous section should be enough to decide whether or not to use <code>SuppressGCTransition</code> in your code. But there&rsquo;s an additional effect that I think is worth mentioning. When calling a native method, the runtime emits a <code>Frame</code> (with a capital F). The name is confusing, because despite being stored on the stack, a <code>Frame</code> is not a stack frame at the traditional sense. You can think of it as a cookie stored by the runtime to help unwind the stack if needed. You can read more on the subject <a href="https://mattwarren.org/2019/01/21/Stackwalking-in-the-.NET-Runtime/#frames">in this excellent article written by Matt Warren</a>.</p>
<p>It might impact various aspects of the runtime (I&rsquo;ll hide behind a cautious &ldquo;I don&rsquo;t know&rdquo;), but what we&rsquo;re interested in here is the impact on debuggers. Imagine you&rsquo;re using a .NET debugger and trying to display the callstack of a managed thread currently executing a native call. The .NET debugger likely only knows how to unwind .NET code, so it will get confused by all the native stuff on top of the stack. To get around that, the debugger will retrieve the <code>Frame</code> and it will indicate where on the stack the managed code begins and ends. This way, the debugger can completely ignore the native part.</p>
<p>![The debugger is able to reconstruct the managed callstack, despite the p/invoke][image_ref_MSpERk5ENGlnNW92aWQ3MkRuZm9wTTBnLnBuZw==]</p>
<p>I don&rsquo;t know if there is a technical reason, or if it&rsquo;s just an effort to shave a bit more overhead (I assume so), but no <code>Frame</code> will be emitted when using <code>SuppressGCTransition</code>. The consequence is that the debugger doesn&rsquo;t know where on the stack the managed code begins. It might get confused by the native stuff on top of the stack and fail to reconstruct the callstack.</p>
<p>![With SuppressGCTransition, the debugger completely fails to reconstruct the managed callstack][image_ref_MSpGXzh1UmZKWWFLVkg2YXhjT1g4RWxBLnBuZw==]</p>
<p>I believe that&rsquo;s a minor inconvenience: you should only use <code>SuppressGCTransition</code> on methods that are very fast, so the debugger is unlikely to stop on any of them. Still, that&rsquo;s something to keep in mind.</p>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.suppressgctransitionattribute?WT.mc_id=DT-MVP-5003493">The official documentation</a> also mentions that the attribute shouldn&rsquo;t be applied on native methods that may throw exceptions. I believe it has something to do with the absence of <code>Frame</code>, but I haven&rsquo;t been able to produce any undesirable side-effect in my testing. You should still play safe and avoid any method that could throw an exception.</p>
<h1 id="reverse-pinvokes">Reverse P/Invokes</h1>
<p>The documentation also mentions that reverse p/invokes (when native code calls back into managed code) are forbidden when using <code>SuppressGCTransition</code>. I believe this is to avoid a situation where the thread remains stuck in preemptive mode. When a managed function is called from native code, the thread is expected to be in preemptive mode. Therefore, the method switches to cooperative mode at the beginning, then back to preemptive at the end. Now let&rsquo;s see what happens if you have the following scenario:</p>
<pre tabindex="0"><code>managed code -&gt; native code (p/invoke) -&gt; managed code (reverse p/invoke)
</code></pre><p>First, when executing the managed code, the thread is in cooperative mode. Then, during the managed -&gt; native transition, the thread doesn&rsquo;t switch to preemptive because of the <code>SuppressGCTransition</code> attribute. Next, during the native -&gt; managed transition, the thread stays in cooperative mode. Now, the reverse p/invoke exits so we work backwards. During the managed -&gt; native transition, the thread switches to preemptive mode. Finally, during the last native -&gt; managed transition, the thread stays in preemptive mode because of the <code>SuppressGCTransition</code> attribute. We end up with a managed thread that won&rsquo;t pause during garbage collections! The situation is bad enough that the runtime emits a check at the beginning of the reverse p/invoke method, that will throw a fatal execution engine exception if it detects that the thread is already in cooperative mode.</p>
<h1 id="stack-spill">Stack spill</h1>
<p>While I was doing my research and tweeting previews of this article, Egor Bogatov pointed out another optimization done by <code>SuppressGCTransition</code>:</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">The problem that the 2nd pinvoke will inject a lot of codegen (basically, spill all regs) in your method&#39;s prolog even if you will be never using that path, I&#39;d recommend to hide it under noinline method then.</p>&mdash; Egor Bogatov (@EgorBo) <a href="https://twitter.com/EgorBo/status/1685995762759401472?ref_src=twsrc%5Etfw">July 31, 2023</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>I don&rsquo;t exactly know why, but when a method has a p/invoke in one of its paths, a stack spill will occur. It means that the value of all registers is pushed on the stack. I believe it has something to do with the <code>Frame</code> that is also pushed on the stack. You can see that if you look at the assembly code of the method I used in the first benchmark:</p>
<pre tabindex="0"><code>push    rbp
push    r15
push    r14
push    r13
push    r12
push    rdi
push    rsi
push    rbx
sub     rsp,78h
lea     rbp,[rsp+0B0h]
mov     qword ptr [rbp+10h],rcx
lea     rcx,[rbp-88h]
mov     rdx,r10
call    coreclr!JIT_InitPInvokeFrame (00007ffd`85b7c0a0)
mov     qword ptr [rbp-48h],rax
mov     rcx,rsp
mov     qword ptr [rbp-68h],rcx
mov     rcx,rbp
mov     qword ptr [rbp-58h],rcx
mov     ecx,2Ah
mov rax,7FFD26219BB0h (MD: GcTransition.SuppressGcTransitionBenchmarkTest.Increment(Int32))
mov     qword ptr [rbp-78h],rax
lea     rax,[00007ffd`261207f8]
mov     qword ptr [rbp-60h],rax
mov     rax,qword ptr [rbp-48h]
lea     rdx,[rbp-88h]
mov     qword ptr [rax+10h],rdx
mov     rax,qword ptr [rbp-48h]
mov     byte ptr [rax+0Ch],0
call    qword ptr [00007ffd`26219c58]
mov     rdx,qword ptr [rbp-48h]
mov     byte ptr [rdx+0Ch],1
cmp     dword ptr [coreclr!g_TrapReturningThreads (00007ffd`85f62e74)],0
je      00007ffd`2612080f
call    qword ptr [coreclr!hlpDynamicFuncTable+0xa8 (00007ffd`85f55378)] (JitHelp: CORINFO_HELP_STOP_FOR_GC)
mov     rdx,qword ptr [rbp-48h]
mov     rcx,qword ptr [rbp-80h]
mov     qword ptr [rdx+10h],rcx
mov     dword ptr [rbp-3Ch],eax
mov     eax,dword ptr [rbp-3Ch]
add     rsp,78h
pop     rbx
pop     rsi
pop     rdi
pop     r12
pop     r13
pop     r14
pop     r15
pop     rbp
ret
</code></pre><p>You can notice the 8 <code>push</code> instructions at the beginning of the method (and the matching 8 <code>pop</code> instructions at the end). When using <code>SuppressGCTransition</code>, the stack spill is gone:</p>
<pre tabindex="0"><code>push    rbp
sub     rsp,20h
lea     rbp,[rsp+20h]
mov     qword ptr [rbp+10h],rcx
call    coreclr!JIT_PollGC (00007ffd`85c1d900)
mov     ecx,2Ah
mov rax,offset NativeLib!Increment (00007ffe`2a8c1010)
call    rax
nop
add     rsp,20h
pop     rbp
ret
</code></pre><p>That&rsquo;s yet another reason why the overhead will be lower. In fact, the stack spill and the <code>Frame</code> seem responsible for most of the overhead, as demonstrated by this benchmark:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SuppressGcTransitionBenchmark</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Condition { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [Benchmark(Baseline = true)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> PInvoke()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (Condition)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Increment(<span style="color:#ae81ff">42</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [DllImport(&#34;NativeLib.dll&#34;)]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">int</span> Increment(<span style="color:#66d9ef">int</span> <span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [Benchmark]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> PInvoke_With_SuppressGCTransition()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (Condition)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Increment(<span style="color:#ae81ff">42</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [DllImport(&#34;NativeLib.dll&#34;)]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [SuppressGCTransition]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">int</span> Increment(<span style="color:#66d9ef">int</span> <span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [Benchmark]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> PInvoke_With_SuppressGCTransitionAndSpill()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (Condition)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Will never get there</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Increment2(<span style="color:#ae81ff">42</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Increment(<span style="color:#ae81ff">42</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [DllImport(&#34;NativeLib.dll&#34;)]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [SuppressGCTransition]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">int</span> Increment(<span style="color:#66d9ef">int</span> <span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [DllImport(&#34;NativeLib.dll&#34;, EntryPoint = &#34;Increment&#34;)]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">int</span> Increment2(<span style="color:#66d9ef">int</span> <span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In <code>PInvoke_With_SuppressGCTransitionAndSpill</code>, I added a branch where a p/invoke without <code>SuppressGCTransition</code> is called. The branch is never executed, but that&rsquo;s enough for the JIT to emit the <code>Frame</code> at the beginning of the method. The other methods are similar to the first benchmark except that I added the fake branch, just in case it has any impact on the performance.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/suppressgctransition-b9a8a774edbd-3.webp" data-fancybox="">
  
    <img class="fig-img" src="/images/suppressgctransition-b9a8a774edbd-3.webp" >
  
    </a>
  
  
</div>

<p>In the results, we can see that <code>PInvoke_With_SuppressGCTransitionAndSpill</code> is significantly slower than <code>PInvoke_With_SuppressGCTransition</code>.</p>
<h1 id="summing-it-up">Summing it up</h1>
<p>I hope you enjoyed this deep-dive into <code>SuppressGCTransition</code>. This is more knowledge than you need to safely use that attribute, so don&rsquo;t worry if you got lost at some point. <a href="https://learn.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.suppressgctransitionattribute?view=net-7.0&amp;WT.mc_id=DT-MVP-5003493">The documentation</a> lists in a clear and concise way what to look for when using that attribute:</p>
<ul>
<li>
<p>Native function always executes for a trivial amount of time (less than 1 microsecond).</p>
</li>
<li>
<p>Native function does not perform a blocking syscall (for example, any type of I/O).</p>
</li>
<li>
<p>Native function does not call back into the runtime (for example, Reverse P/Invoke).</p>
</li>
<li>
<p>Native function does not throw exceptions.</p>
</li>
<li>
<p>Native function does not manipulate locks or other concurrency primitives.</p>
</li>
</ul>
<p>If your p/invoke meets all those points, then you can safely use the <code>SuppressGCTransition</code> attribute and enjoy the small (but free) performance gain.</p>

              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/dotnet/">dotnet</a>

  <a class="tag tag--primary tag--small" href="/tags/performance/">performance</a>

  <a class="tag tag--primary tag--small" href="/tags/garbage-collection/">garbage-collection</a>

  <a class="tag tag--primary tag--small" href="/tags/assembly/">assembly</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/memory-alignment-of-doubles-in-c-1d13e3ce741/" data-tooltip="Memory alignment of doubles in C#" aria-label="NEXT: Memory alignment of doubles in C#">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/writing-a-net-profiler-in-c-part-4-c54df903b9ce/" data-tooltip="Writing a .NET profiler in C# — Part 4" aria-label="PREVIOUS: Writing a .NET profiler in C# — Part 4">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/suppressgctransition-b9a8a774edbd/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/suppressgctransition-b9a8a774edbd/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/suppressgctransition-b9a8a774edbd/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/suppressgctransition-b9a8a774edbd/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            

<link href="https://fonts.googleapis.com/css?family=Cookie&amp;display=swap" rel="stylesheet">
<div class="bmc-btn-container"><a class="bmc-btn" target="_blank" href="https://buymeacoffee.com/kevingosse">☕<span class="bmc-btn-text">Enjoyed the article? Buy me a coffee</span></a></div>

<style>
    .bmc-btn {
        min-width: 210px;
        color: #000000;
        background-color: #FFFFFF !important;
        height: 60px;
        border-radius: 12px;
        font-size: 28px;
        font-weight: Normal;
        border: none;
        line-height: 27px;
        text-decoration: none !important;
        display: inline-flex !important;
        justify-content: center;
        align-items: center;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
    }

    .bmc-btn:hover, .bmc-btn:active, .bmc-btn:focus {
        text-decoration: none !important;
        cursor: pointer;
    }

    .bmc-btn-text {
        margin-left: 8px;
        display: inline-block;
        line-height: 0;
        width: 100%;
        flex-shrink: 0;
        font-family: [FONT] !important;
    }

    .logo-outline {
        fill: #000000;
    }

    .logo-coffee {
        fill: #ffffff;
    }</style>

  
<div id="utterances">
      <noscript>Please enable JavaScript to view the comments powered by Utterances.</noscript>
    </div>
<script src="https://utteranc.es/client.js"
        repo="kevingosse/kevingosse.github.io"
        issue-term="title"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 Kevin Gosse. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/memory-alignment-of-doubles-in-c-1d13e3ce741/" data-tooltip="Memory alignment of doubles in C#" aria-label="NEXT: Memory alignment of doubles in C#">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/writing-a-net-profiler-in-c-part-4-c54df903b9ce/" data-tooltip="Writing a .NET profiler in C# — Part 4" aria-label="PREVIOUS: Writing a .NET profiler in C# — Part 4">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/suppressgctransition-b9a8a774edbd/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/suppressgctransition-b9a8a774edbd/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/suppressgctransition-b9a8a774edbd/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/suppressgctransition-b9a8a774edbd/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="2">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fminidump.net%2Fsuppressgctransition-b9a8a774edbd%2F" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https%3A%2F%2Fminidump.net%2Fsuppressgctransition-b9a8a774edbd%2F" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i><span>Share on Linkedin</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.reddit.com/submit?url=https%3A%2F%2Fminidump.net%2Fsuppressgctransition-b9a8a774edbd%2F" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i><span>Share on Reddit</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fminidump.net%2Fsuppressgctransition-b9a8a774edbd%2F" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i><span>Share on Hacker News</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>


    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Kevin Gosse</h4>
    
      <div id="about-card-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</div>
    
    
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://minidump.net/images/code.png');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://minidump.net/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

