<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <script type="application/ld+json">

{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Writing a .NET profiler in C# — Part 4",
  
  "image": "https://minidump.net/images/writing-a-net-profiler-in-c-part-4-c54df903b9ce-thumbnail.png",
  
  "datePublished": "2023-06-10T00:00:00Z",
  "dateModified": "2023-06-10T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Kevin Gosse",
    
    "image": "https://minidump.net/images/profile.png"
    
  },
  "mainEntityOfPage": { 
    "@type": "WebPage",
    "@id": "https:\/\/minidump.net\/writing-a-net-profiler-in-c-part-4-c54df903b9ce\/" 
  },
  "publisher": {
    "@type": "Organization",
    "name": "minidump.net",
    
    "logo": {
      "@type": "ImageObject",
      "url": "https://minidump.net/images/profile.png"
    }
    
  },
  "description": "Part 4 of the series about using NativeAOT to write a .NET profiler in C#, learning many things about native interop in the process. In this part, we learn how to call methods from ICorProfilerInfo.",
  "keywords": []
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.121.1 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="Kevin Gosse">
<meta name="keywords" content="">
<meta name="description" content="Part 4 of the series about using NativeAOT to write a .NET profiler in C#, learning many things about native interop in the process. In this part, we learn how to call methods from ICorProfilerInfo.">


<meta property="og:description" content="Part 4 of the series about using NativeAOT to write a .NET profiler in C#, learning many things about native interop in the process. In this part, we learn how to call methods from ICorProfilerInfo.">
<meta property="og:type" content="article">
<meta property="og:title" content="Writing a .NET profiler in C# — Part 4">
<meta name="twitter:title" content="Writing a .NET profiler in C# — Part 4">
<meta property="og:url" content="https://minidump.net/writing-a-net-profiler-in-c-part-4-c54df903b9ce/">
<meta property="twitter:url" content="https://minidump.net/writing-a-net-profiler-in-c-part-4-c54df903b9ce/">
<meta property="og:site_name" content="minidump.net">
<meta property="og:description" content="Part 4 of the series about using NativeAOT to write a .NET profiler in C#, learning many things about native interop in the process. In this part, we learn how to call methods from ICorProfilerInfo.">
<meta name="twitter:description" content="Part 4 of the series about using NativeAOT to write a .NET profiler in C#, learning many things about native interop in the process. In this part, we learn how to call methods from ICorProfilerInfo.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2023-06-10T00:00:00">
  
  
    <meta property="article:modified_time" content="2023-06-10T00:00:00">
  
  
  
  
    
      <meta property="article:tag" content="dotnet">
    
      <meta property="article:tag" content="csharp">
    
      <meta property="article:tag" content="nativeaot">
    
      <meta property="article:tag" content="profiler">
    
      <meta property="article:tag" content="source-generator">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@kookiz">


  <meta name="twitter:creator" content="@kookiz">






  <meta property="og:image" content="https://minidump.net/images/profile.png">
  <meta property="twitter:image" content="https://minidump.net/images/profile.png">





  <meta property="og:image" content="https://minidump.net/images/writing-a-net-profiler-in-c-part-4-c54df903b9ce-thumbnail.png">
  <meta property="twitter:image" content="https://minidump.net/images/writing-a-net-profiler-in-c-part-4-c54df903b9ce-thumbnail.png">


    <title>Writing a .NET profiler in C# — Part 4</title>

    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    

    

    <link rel="canonical" href="https://minidump.net/writing-a-net-profiler-in-c-part-4-c54df903b9ce/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://minidump.net/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MQCXFBVCCM"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-MQCXFBVCCM', { 'anonymize_ip': false });
}
</script>

    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/" aria-label="Go to homepage">minidump.net</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about" aria-label="Read more about the author">
          <img class="sidebar-profile-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Kevin Gosse</h4>
        
          <h5 class="sidebar-profile-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/kookiz" target="_blank" rel="noopener" title="Twitter">
    
      <i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/kevingosse" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.buymeacoffee.com/kevingosse" target="_blank" rel="noopener" title="Buy me a coffee">
    
      <i class="sidebar-button-icon fas fa-lg fa-coffee" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Buy me a coffee</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      Writing a .NET profiler in C# — Part 4
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-06-10T00:00:00Z">
        
  
  
  
  
    June 10 2023
  

      </time>
    
    
  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p><a href="/writing-a-net-profiler-in-c-part-1-d3978aae9b12">In part 1</a>, we saw how NativeAOT can allow us to write a profiler in C#, and how to expose a fake COM object to use the profiling API. <a href="/writing-a-net-profiler-in-c-part-2-8039da001e43">In part 2</a>, we refined the solution to use instance methods instead of static methods. <a href="/writing-a-net-profiler-in-c-part-3-7d2c59fc017f">In part 3</a>, we automated the process using a source generator. At this point, we have everything we need to expose an instance of <a href="https://learn.microsoft.com/en-us/dotnet/framework/unmanaged-api/profiling/icorprofilercallback-interface?WT.mc_id=DT-MVP-5003493"><code>ICorProfilerCallback</code></a>. However, to write a profiler we also need to be able to call methods from <a href="https://learn.microsoft.com/en-us/dotnet/framework/unmanaged-api/profiling/icorprofilerinfo-interface?WT.mc_id=DT-MVP-5003493"><code>ICorProfilerInfo</code></a>, this will be the subject of this part.</p>
<p>As a reminder, we ended up with this implementation of <code>ICorProfilerCallback</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CorProfilerCallback2</span> : ICorProfilerCallback2
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> Guid ICorProfilerCallback2Guid = Guid.Parse(<span style="color:#e6db74">&#34;8a8cc829-ccf2-49fe-bbae-0f022228071a&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> NativeObjects.ICorProfilerCallback2 _corProfilerCallback2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> CorProfilerCallback2()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _corProfilerCallback2 = NativeObjects.ICorProfilerCallback2.Wrap(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> IntPtr Object =&gt; _corProfilerCallback2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> HResult Initialize(IntPtr pICorProfilerInfoUnk)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Console.WriteLine(<span style="color:#e6db74">&#34;[Profiler] ICorProfilerCallback2 - Initialize&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// TODO: To be implemented</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> HResult.S_OK;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> HResult QueryInterface(<span style="color:#66d9ef">in</span> Guid guid, <span style="color:#66d9ef">out</span> IntPtr ptr)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (guid == ICorProfilerCallback2Guid)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Console.WriteLine(<span style="color:#e6db74">&#34;[Profiler] ICorProfilerCallback2 - QueryInterface&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ptr = Object;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> HResult.S_OK;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ptr = IntPtr.Zero;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> HResult.E_NOTIMPL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Stripped for brevity: the default implementation of all 70+ methods of the interface</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>When <code>Initialize</code> is called, we receive an instance of <a href="https://learn.microsoft.com/en-us/windows/win32/api/unknwn/nn-unknwn-iunknown?WT.mc_id=DT-MVP-5003493">IUnknown</a>. We need to call the <code>QueryInterface</code> on it to retrieve an instance of <code>ICorProfilerInfo</code>.</p>
<p>To expose objects to native code, we&rsquo;ve seen how to create a fake vtable. To consume native objects, it&rsquo;s the opposite: we need to read their vtable to get the address of the methods, then invoke them.</p>
<p>Let&rsquo;s write a wrapper to invoke the methods from an instance of <code>IUnknown</code>. Because virtual objects store the address of their vtable as their first field, we just need to read a pointer at the object&rsquo;s location to get that vtable. We extract that logic into a property of our wrapper, for convenience:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Unknown</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> IntPtr _self;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Unknown(IntPtr self)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _self = self;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> IntPtr* VTable =&gt; (IntPtr*)*(IntPtr*)_self;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Implement QueryInterface/AddRef/Release</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Note that we declared that wrapper as struct because it doesn&rsquo;t need any state. In the end, it&rsquo;s just a fancy pointer with some embedded logic.</p>
<p>To invoke the methods, we retrieve their address from the appropriate slot of the vtable and cast them to <a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/proposals/csharp-9.0/function-pointers?WT.mc_id=DT-MVP-5003493">function pointers</a>. Then we just have to invoke them, making sure to pass the address of the object as first parameter because they&rsquo;re instance methods:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> HResult QueryInterface(<span style="color:#66d9ef">in</span> Guid guid, <span style="color:#66d9ef">out</span> IntPtr ptr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> func = (<span style="color:#66d9ef">delegate</span>* unmanaged&lt;IntPtr, <span style="color:#66d9ef">in</span> Guid, <span style="color:#66d9ef">out</span> IntPtr, HResult&gt;)(*VTable);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> func(_self, <span style="color:#66d9ef">in</span> guid, <span style="color:#66d9ef">out</span> ptr);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> AddRef()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> func = (<span style="color:#66d9ef">delegate</span>* unmanaged&lt;IntPtr, <span style="color:#66d9ef">int</span>&gt;)(*(VTable + <span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> func(_self);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Release()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> func = (<span style="color:#66d9ef">delegate</span>* unmanaged&lt;IntPtr, <span style="color:#66d9ef">int</span>&gt;)(*(VTable + <span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> func(_self);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Our wrapper can be directly used in <code>ICorProfilerCallback.Initialize</code> to retrieve the instance of <code>ICorProfilerInfo</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> HResult Initialize(IntPtr pICorProfilerInfoUnk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Console.WriteLine(<span style="color:#e6db74">&#34;[Profiler] ICorProfilerCallback2 - Initialize&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> iCorProfilerInfo3Guid = Guid.Parse(<span style="color:#e6db74">&#34;B555ED4F-452A-4E54-8B39-B5360BAD32A0&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> unknown = <span style="color:#66d9ef">new</span> Unknown(pICorProfilerInfoUnk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> result = unknown.QueryInterface(iCorProfilerInfo3Guid, <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">var</span> ptr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (result == HResult.S_OK)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Console.WriteLine(<span style="color:#e6db74">$&#34;[Profiler] Successfully retrieved an instance of ICorProfilerInfo3: {ptr:x2}&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Console.WriteLine(<span style="color:#e6db74">$&#34;[Profiler] Failed with error code: {result:x2}&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HResult.S_OK;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>To actually use our instance of <code>ICorProfilerInfo</code>, we need to write the same kind of wrapper. However, since the interface declares tens of methods, we won&rsquo;t do it by hand and instead we&rsquo;re going to extend the source generator that we wrote <a href="https://minidump.net/writing-a-net-profiler-in-c-part-3-7d2c59fc017f">in part 3</a>.</p>
<p>Our source generator will fill the following template:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">struct</span> {invokerName}
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> IntPtr _self;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">public</span> {invokerName}(IntPtr self)
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>              _self = self;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">private</span> IntPtr* VTable =&gt; (IntPtr*)*(IntPtr*)_self;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          {invokerFunctions}
</span></span><span style="display:flex;"><span>      }
</span></span></code></pre></div><p>We&rsquo;re implementing all of this in the <code>EmitStubForInterface(GeneratorExecutionContext context, INamedTypeSymbol symbol)</code> method described <a href="https://minidump.net/writing-a-net-profiler-in-c-part-3-7d2c59fc017f">in the previous article</a>.</p>
<p>For the name of our wrapper, we just use the name of the symbol and append a suffix:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> invokerName = <span style="color:#e6db74">$&#34;{symbol.Name}Invoker&#34;</span>;
</span></span></code></pre></div><p>Then we need to fill the list of functions. We declare a <code>StringBuilder</code> and start iterating on all functions from the target interface and its parents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> invokerFunctions = <span style="color:#66d9ef">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> interfaceList = symbol.AllInterfaces.ToList();
</span></span><span style="display:flex;"><span>interfaceList.Reverse();
</span></span><span style="display:flex;"><span>interfaceList.Add(symbol);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> @interface <span style="color:#66d9ef">in</span> interfaceList)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> member <span style="color:#66d9ef">in</span> @interface.GetMembers())
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (member <span style="color:#66d9ef">is</span> not IMethodSymbol method)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// TODO</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>For each of the method, we start by emitting the signature:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>invokerFunctions.Append(<span style="color:#e6db74">$&#34;public {method.ReturnType} {method.Name}(&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; method.Parameters.Length; i++)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (i &gt; <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        invokerFunctions.Append(<span style="color:#e6db74">&#34;, &#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> refKind = method.Parameters[i].RefKind;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (refKind)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RefKind.In:
</span></span><span style="display:flex;"><span>            invokerFunctions.Append(<span style="color:#e6db74">&#34;in &#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RefKind.Out:
</span></span><span style="display:flex;"><span>            invokerFunctions.Append(<span style="color:#e6db74">&#34;out &#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RefKind.Ref:
</span></span><span style="display:flex;"><span>            invokerFunctions.Append(<span style="color:#e6db74">&#34;ref &#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    invokerFunctions.Append(<span style="color:#e6db74">$&#34;{method.Parameters[i].Type} a{i}&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>invokerFunctions.AppendLine(<span style="color:#e6db74">&#34;)&#34;</span>);
</span></span></code></pre></div><p>Note that all the parameters are renamed to <code>a1</code>, <code>a2</code>, <code>a3</code>, …, to avoid any potential conflict if the arguments of the original methods have weird names.</p>
<p>Now we can generate the body of the method, where we fetch the address of the method from the vtable and call it with the expected arguments:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>invokerFunctions.AppendLine(<span style="color:#e6db74">&#34;{&#34;</span>);
</span></span><span style="display:flex;"><span>invokerFunctions.Append(<span style="color:#e6db74">&#34;var func = (delegate* unmanaged[Stdcall]&lt;IntPtr&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; method.Parameters.Length; i++)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    invokerFunctions.Append(<span style="color:#e6db74">&#34;, &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> refKind = method.Parameters[i].RefKind;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (refKind)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RefKind.In:
</span></span><span style="display:flex;"><span>            invokerFunctions.Append(<span style="color:#e6db74">&#34;in &#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RefKind.Out:
</span></span><span style="display:flex;"><span>            invokerFunctions.Append(<span style="color:#e6db74">&#34;out &#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RefKind.Ref:
</span></span><span style="display:flex;"><span>            invokerFunctions.Append(<span style="color:#e6db74">&#34;ref &#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    invokerFunctions.Append(method.Parameters[i].Type);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>invokerFunctions.AppendLine(<span style="color:#e6db74">$&#34;, {method.ReturnType}&gt;)*(VTable + {delegateCount});&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (method.ReturnType.SpecialType != SpecialType.System_Void)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    invokerFunctions.Append(<span style="color:#e6db74">&#34;return &#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>invokerFunctions.Append(<span style="color:#e6db74">&#34;func(_self&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; method.Parameters.Length; i++)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    invokerFunctions.Append(<span style="color:#e6db74">$&#34;, &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> refKind = method.Parameters[i].RefKind;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (refKind)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RefKind.In:
</span></span><span style="display:flex;"><span>            invokerFunctions.Append(<span style="color:#e6db74">&#34;in &#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RefKind.Out:
</span></span><span style="display:flex;"><span>            invokerFunctions.Append(<span style="color:#e6db74">&#34;out &#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RefKind.Ref:
</span></span><span style="display:flex;"><span>            invokerFunctions.Append(<span style="color:#e6db74">&#34;ref &#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    invokerFunctions.Append(<span style="color:#e6db74">$&#34;a{i}&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>invokerFunctions.AppendLine(<span style="color:#e6db74">&#34;);&#34;</span>);
</span></span><span style="display:flex;"><span>invokerFunctions.AppendLine(<span style="color:#e6db74">&#34;}&#34;</span>);
</span></span></code></pre></div><p>That&rsquo;s a lot of code, but it&rsquo;s mostly enumerating the arguments to generate the method call, and some special casing in case the method returns <code>void</code>.</p>
<p>Last but not least, we replace the placeholders in our template:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>sourceBuilder.Replace(<span style="color:#e6db74">&#34;{invokerFunctions}&#34;</span>, invokerFunctions.ToString());
</span></span><span style="display:flex;"><span>sourceBuilder.Replace(<span style="color:#e6db74">&#34;{invokerName}&#34;</span>, invokerName);
</span></span></code></pre></div><p>With that, we can go back to our implementation of <code>ICorProfilerCallback.Initialize</code> and replace <code>Unknown</code> by our automatically generated implementation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> HResult Initialize(IntPtr pICorProfilerInfoUnk)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>      Console.WriteLine(<span style="color:#e6db74">&#34;[Profiler] ICorProfilerCallback2 - Initialize&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> iCorProfilerInfo3Guid = Guid.Parse(<span style="color:#e6db74">&#34;B555ED4F-452A-4E54-8B39-B5360BAD32A0&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> unknown = <span style="color:#66d9ef">new</span> NativeObjects.IUnknownInvoker(pICorProfilerInfoUnk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> result = unknown.QueryInterface(iCorProfilerInfo3Guid, <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">var</span> ptr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (result == HResult.S_OK)
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>          Console.WriteLine(<span style="color:#e6db74">$&#34;[Profiler] Successfully retrieved an instance of ICorProfilerInfo3: {ptr:x2}&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">var</span> corProfilerInfo = <span style="color:#66d9ef">new</span> NativeObjects.ICorProfilerInfo3Invoker(ptr);
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// Can start interacting with ICorProfilerInfo</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>          Console.WriteLine(<span style="color:#e6db74">$&#34;[Profiler] Failed with error code: {result:x2}&#34;</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> HResult.S_OK;
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>With this, we finally have all the pieces of the puzzle to actually start writing a profiler.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/writing-a-net-profiler-in-c-part-4-c54df903b9ce-1.webp" data-fancybox="">
  
    <img class="fig-img" src="/images/writing-a-net-profiler-in-c-part-4-c54df903b9ce-1.webp" >
  
    </a>
  
  
</div>

<p>As a reminder, all the code <a href="https://github.com/kevingosse/ManagedDotnetProfiler">is available on GitHub</a>.</p>

              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/dotnet/">dotnet</a>

  <a class="tag tag--primary tag--small" href="/tags/csharp/">csharp</a>

  <a class="tag tag--primary tag--small" href="/tags/nativeaot/">nativeaot</a>

  <a class="tag tag--primary tag--small" href="/tags/profiler/">profiler</a>

  <a class="tag tag--primary tag--small" href="/tags/source-generator/">source-generator</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/suppressgctransition-b9a8a774edbd/" data-tooltip="SuppressGCTransition" aria-label="NEXT: SuppressGCTransition">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/verificationexception-in-net-framework-when-using-structs-6269eb3df448/" data-tooltip="VerificationException in .NET Framework when using structs" aria-label="PREVIOUS: VerificationException in .NET Framework when using structs">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/writing-a-net-profiler-in-c-part-4-c54df903b9ce/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/writing-a-net-profiler-in-c-part-4-c54df903b9ce/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/writing-a-net-profiler-in-c-part-4-c54df903b9ce/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/writing-a-net-profiler-in-c-part-4-c54df903b9ce/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            

<link href="https://fonts.googleapis.com/css?family=Cookie&amp;display=swap" rel="stylesheet">
<div class="bmc-btn-container"><a class="bmc-btn" target="_blank" href="https://buymeacoffee.com/kevingosse">☕<span class="bmc-btn-text">Enjoyed the article? Buy me a coffee</span></a></div>

<style>
    .bmc-btn {
        min-width: 210px;
        color: #000000;
        background-color: #FFFFFF !important;
        height: 60px;
        border-radius: 12px;
        font-size: 28px;
        font-weight: Normal;
        border: none;
        line-height: 27px;
        text-decoration: none !important;
        display: inline-flex !important;
        justify-content: center;
        align-items: center;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
    }

    .bmc-btn:hover, .bmc-btn:active, .bmc-btn:focus {
        text-decoration: none !important;
        cursor: pointer;
    }

    .bmc-btn-text {
        margin-left: 8px;
        display: inline-block;
        line-height: 0;
        width: 100%;
        flex-shrink: 0;
        font-family: [FONT] !important;
    }

    .logo-outline {
        fill: #000000;
    }

    .logo-coffee {
        fill: #ffffff;
    }</style>

  
<div id="utterances">
      <noscript>Please enable JavaScript to view the comments powered by Utterances.</noscript>
    </div>
<script src="https://utteranc.es/client.js"
        repo="kevingosse/kevingosse.github.io"
        issue-term="title"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2024 Kevin Gosse. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/suppressgctransition-b9a8a774edbd/" data-tooltip="SuppressGCTransition" aria-label="NEXT: SuppressGCTransition">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/verificationexception-in-net-framework-when-using-structs-6269eb3df448/" data-tooltip="VerificationException in .NET Framework when using structs" aria-label="PREVIOUS: VerificationException in .NET Framework when using structs">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/writing-a-net-profiler-in-c-part-4-c54df903b9ce/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/writing-a-net-profiler-in-c-part-4-c54df903b9ce/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/writing-a-net-profiler-in-c-part-4-c54df903b9ce/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/writing-a-net-profiler-in-c-part-4-c54df903b9ce/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="2">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fminidump.net%2Fwriting-a-net-profiler-in-c-part-4-c54df903b9ce%2F" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https%3A%2F%2Fminidump.net%2Fwriting-a-net-profiler-in-c-part-4-c54df903b9ce%2F" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i><span>Share on Linkedin</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.reddit.com/submit?url=https%3A%2F%2Fminidump.net%2Fwriting-a-net-profiler-in-c-part-4-c54df903b9ce%2F" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i><span>Share on Reddit</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fminidump.net%2Fwriting-a-net-profiler-in-c-part-4-c54df903b9ce%2F" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i><span>Share on Hacker News</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>


    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Kevin Gosse</h4>
    
      <div id="about-card-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</div>
    
    
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://minidump.net/images/code.png');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://minidump.net/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

