<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <script type="application/ld+json">

{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "An unconventional way of investigating a NullReferenceException",
  
  "image": "https://minidump.net/images/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a-1.webp",
  
  "datePublished": "2021-03-16T00:00:00Z",
  "dateModified": "2021-03-16T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Kevin Gosse",
    
    "image": "https://minidump.net/images/profile.png"
    
  },
  "mainEntityOfPage": { 
    "@type": "WebPage",
    "@id": "https:\/\/minidump.net\/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a\/" 
  },
  "publisher": {
    "@type": "Organization",
    "name": "minidump.net",
    
    "logo": {
      "@type": "ImageObject",
      "url": "https://minidump.net/images/profile.png"
    }
    
  },
  "description": "Digging into a bug in the .NET ARM64 runtime, learning about dispatch stubs, and using that knowledge to diagnose a NullReferenceException.",
  "keywords": []
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.121.1 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="Kevin Gosse">
<meta name="keywords" content="">
<meta name="description" content="Digging into a bug in the .NET ARM64 runtime, learning about dispatch stubs, and using that knowledge to diagnose a NullReferenceException.">


<meta property="og:description" content="Digging into a bug in the .NET ARM64 runtime, learning about dispatch stubs, and using that knowledge to diagnose a NullReferenceException.">
<meta property="og:type" content="article">
<meta property="og:title" content="An unconventional way of investigating a NullReferenceException">
<meta name="twitter:title" content="An unconventional way of investigating a NullReferenceException">
<meta property="og:url" content="https://minidump.net/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a/">
<meta property="twitter:url" content="https://minidump.net/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a/">
<meta property="og:site_name" content="minidump.net">
<meta property="og:description" content="Digging into a bug in the .NET ARM64 runtime, learning about dispatch stubs, and using that knowledge to diagnose a NullReferenceException.">
<meta name="twitter:description" content="Digging into a bug in the .NET ARM64 runtime, learning about dispatch stubs, and using that knowledge to diagnose a NullReferenceException.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2021-03-16T00:00:00">
  
  
    <meta property="article:modified_time" content="2021-03-16T00:00:00">
  
  
  
  
    
      <meta property="article:tag" content="dotnet">
    
      <meta property="article:tag" content="debugging">
    
      <meta property="article:tag" content="lldb">
    
      <meta property="article:tag" content="windbg">
    
      <meta property="article:tag" content="arm64">
    
      <meta property="article:tag" content="assembly">
    
      <meta property="article:tag" content="cpp">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@kookiz">


  <meta name="twitter:creator" content="@kookiz">






  <meta property="og:image" content="https://minidump.net/images/profile.png">
  <meta property="twitter:image" content="https://minidump.net/images/profile.png">





  <meta property="og:image" content="https://minidump.net/images/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a-1.webp">
  <meta property="twitter:image" content="https://minidump.net/images/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a-1.webp">


    <title>An unconventional way of investigating a NullReferenceException</title>

    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    

    

    <link rel="canonical" href="https://minidump.net/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://minidump.net/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    <script>
    (function(h,o,u,n,d) {
      h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}}
      d=o.createElement(u);d.async=1;d.src=n
      n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n)
    })(window,document,'script','https://www.datadoghq-browser-agent.com/us1/v5/datadog-rum.js','DD_RUM')
    window.DD_RUM.onReady(function() {
      window.DD_RUM.init({
        clientToken: 'pubabeb7320d5ecb81f3b14a17c35c1a3de',
        applicationId: '78b5d24e-77d4-4bba-ae37-5a46f7386b95',
        site: 'datadoghq.com',
        service: 'minidump.net',
        env: 'kevin',
        sessionSampleRate: 100,
        sessionReplaySampleRate: 20,
        trackUserInteractions: true,
        trackResources: true,
        trackLongTasks: true,
        defaultPrivacyLevel: 'mask-user-input',
      });
    })
</script>
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/" aria-label="Go to homepage">minidump.net</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about" aria-label="Read more about the author">
          <img class="sidebar-profile-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Kevin Gosse</h4>
        
          <h5 class="sidebar-profile-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/kookiz" target="_blank" rel="noopener" title="Twitter">
    
      <i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/kevingosse" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.buymeacoffee.com/kevingosse" target="_blank" rel="noopener" title="Buy me a coffee">
    
      <i class="sidebar-button-icon fas fa-lg fa-coffee" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Buy me a coffee</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="2"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      An unconventional way of investigating a NullReferenceException
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2021-03-16T00:00:00Z">
        
  
  
  
  
    March 16 2021
  

      </time>
    
    
  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <h1 id="the-crash">The crash</h1>
<p>This one started when trying to understand why an integration test was failing, only on Linux with ARM64.</p>
<p>As I had no ARM64 dev environment available, I first tried adding more and more traces and let the test run in the CI, without much success.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a-1.webp" data-fancybox="">
  
    <img class="fig-img" src="/images/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a-1.webp" >
  
    </a>
  
  
</div>

<p>Eventually, I realized this was leading nowhere, and took the time to setup an ARM64 VM to investigate further. After running the test with LLDB (see <a href="/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd">my previous article</a> to learn how to fetch the symbols for the CLR), I found out that the process was raising two segmentations faults, and the second one caused the crash:</p>
<pre tabindex="0"><code>* thread #1, name = &#39;dotnet&#39;, stop reason = signal SIGSEGV
  * frame #0: 0x0000ffffb76ccc40 libcoreclr.so`AdjustContextForVirtualStub(pExceptionRecord=0x0000000000000000, pContext=0x0000ffff077f38e0) at stubs.cpp:1173:40
    frame #1: 0x0000ffffb76d4a18 libcoreclr.so`UnwindManagedExceptionPass1(ex=&lt;unavailable&gt;, frameContext=&lt;unavailable&gt;) at exceptionhandling.cpp:4579:17
    frame #2: 0x0000ffffb76d4c08 libcoreclr.so`DispatchManagedException(ex=0x0000ffff077f3cd0, isHardwareException=&lt;unavailable&gt;) at exceptionhandling.cpp:4686:17
    frame #3: 0x0000ffffb763c0cc libcoreclr.so`IL_Throw(obj=&lt;unavailable&gt;) at jithelpers.cpp:4195:5
[managed frames]
</code></pre><p><a href="https://github.com/dotnet/runtime/issues/49070">I opened an issue</a> on the dotnet/runtime repository, and David Mason was quick to track it down to a missing null check in <code>AdjustContextForVirtualStub</code>.</p>
<p>It turns out that the assertion &ldquo;.NET checks for nullity when doing a virtual call&rdquo; is not exactly true. In some situations, when checking the type of an object, the runtime assumes the value is not null, then catches the access violation/segmentation fault when trying to dereference the instance. The fault is then converted to a <code>NullReferenceException</code>. The end result is the same as if .NET was explicitly checking for nullity. So what happened in my test application was:</p>
<ul>
<li>
<p>I was trying to call a virtual method on a null reference</p>
</li>
<li>
<p>This caused a segmentation fault, which was caught by the runtime and converted into a <code>NullReferenceException</code>. An important point to understand is that the fault/exception occurred during the dispatch of the virtual call, <strong>which is not considered as managed code</strong>.</p>
</li>
<li>
<p>The exception was rethrown in the catch block of the method</p>
</li>
<li>
<p>When unwinding the stack, it hit a special case in <code>UnwindManagedExceptionPass1</code> when the exception originates from native code. That code path was missing a null check and caused the fatal segmentation fault.</p>
</li>
</ul>
<p>I built a custom version of the CLR with the additional null check, and as predicted this fixed the crash. End of story?</p>
<h1 id="writing-a-repro">Writing a repro</h1>
<p>The story could have ended here, but I felt like I was still missing something to get the full picture. .NET isn&rsquo;t widely used on ARM64, but I figured out that if the issue was as simple as &ldquo;crashes when invoking a virtual method on a null reference&rdquo;, the bug would have been found much sooner.</p>
<p>To understand the exact conditions for the crash, I decided to try and write a repro. I started with a simple virtual call on a null reference:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Request();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Console.WriteLine(<span style="color:#e6db74">&#34;Caught: &#34;</span> + ex);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Request()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> response = GetValue();
</span></span><span style="display:flex;"><span>            _ = response.GetHashCode(); <span style="color:#75715e">// Virtual call on null reference</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Exception(<span style="color:#e6db74">&#34;Rethrowing&#34;</span>, ex);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [MethodImpl(MethodImplOptions.NoInlining)]</span> <span style="color:#75715e">// Prevent any kind of unexpected compiler optimization</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">object</span> GetValue()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Without much surprise, this program didn&rsquo;t crash. So there was more to the problem than just &ldquo;a virtual call on a null reference&rdquo;.</p>
<p>When running the repro program with LLDB, it broke on a segmentation fault:</p>
<pre tabindex="0"><code>(lldb) run
Process 111393 launched: &#39;/home/ubuntu/testconsole-blog/bin/Release/net5.0/testconsole&#39; (aarch64)
Process 111393 stopped
* thread #1, name = &#39;testconsole&#39;, stop reason = signal SIGSEGV: invalid address (fault address: 0x0)
    frame #0: 0x0000ffff7e42af88
-&gt;  0xffff7e42af88: ldr    x1, [x1]
    0xffff7e42af8c: ldr    x1, [x1, #0x40]
    0xffff7e42af90: ldr    x1, [x1, #0x18]
    0xffff7e42af94: blr    x1
(lldb) ip2md 0x0000ffff7e42af88
MethodDesc:   0000ffff7e4b1f90
Method Name:          testconsole.Program.Request()
[...]
</code></pre><p>The segmentation fault occurred in the <code>Request</code> method, which was expected. But if I tried the same thing in my crashing app, the segfault would happen in a non-managed method:</p>
<pre tabindex="0"><code>Process 64731 stopped
* thread #16, name = &#39;.NET ThreadPool&#39;, stop reason = signal SIGSEGV: invalid address (fault address: 0x0)
    frame #0: 0x0000ffff7d866300
-&gt;  0xffff7d866300: ldr    x13, [x0]
    0xffff7d866304: adr    x9, #0x1c
    0xffff7d866308: ldp    x10, x12, [x9]
    0xffff7d86630c: cmp    x13, x10

(lldb) ip2md 0x0000ffff7d866300
Failed to request MethodData, not in JIT code range
IP2MD 0xffff7d866300  failed
</code></pre><p>What was this method? It wasn&rsquo;t exported in the .NET CLR symbols, yet it wasn&rsquo;t a managed method either. To get more information, I enabled the perf map generation (<a href="https://docs.microsoft.com/en-us/dotnet/core/run-time-config/debugging-profiling?WT.mc_id=DT-MVP-5003493#write-perf-map">by setting the <code>COMPlus_PerfMapEnable</code> environment variable</a>). The perf map is a simple text file in which the JIT stores the name and address of the methods it compiles. Luckily, I found the address of the mysterious method in there, with the name <code>GenerateDispatchStub&lt;GenerateDispatchStub&gt;</code>.</p>
<p>I then looked into the code of the CLR to understand <a href="https://github.com/dotnet/runtime/blob/v5.0.3/src/coreclr/src/vm/virtualcallstub.cpp#L2784">what this name was associated to</a>.</p>
<p>The CLR was creating a <code>DispatchHolder</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>DispatchHolder <span style="color:#f92672">*</span> holder <span style="color:#f92672">=</span> (DispatchHolder<span style="color:#f92672">*</span>) (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)
</span></span><span style="display:flex;"><span>    dispatch_heap<span style="color:#f92672">-&gt;</span>AllocAlignedMem(dispatchHolderSize, CODE_SIZE_ALIGN);
</span></span></code></pre></div><p>Then calling <code>Initialize</code> to emit some code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>holder<span style="color:#f92672">-&gt;</span>Initialize(addrOfCode,
</span></span><span style="display:flex;"><span>                   addrOfFail,
</span></span><span style="display:flex;"><span>                   (size_t)pMTExpected
</span></span></code></pre></div><p>That method had <a href="https://github.com/dotnet/runtime/blob/v5.0.3/src/coreclr/src/vm/arm64/virtualcallstubcpu.hpp#L109">a specific implementation for ARM64</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>  <span style="color:#a6e22e">Initialize</span>(PCODE implTarget, PCODE failTarget, size_t expectedMT)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ldr x13, [x0] ; methodTable from object in x0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// adr x9, _expectedMT ; _expectedMT is at offset 28 from pc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// ldp x10, x12, [x9] ; x10 = _expectedMT &amp; x12 = _implTarget
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// cmp x13, x10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// bne failLabel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// br x12
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// failLabel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// ldr x9, _failTarget ; _failTarget is at offset 24 from pc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// br x9
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// _expectedMT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// _implTarget
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// _failTarget
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    _stub._entryPoint[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> DISPATCH_STUB_FIRST_DWORD; <span style="color:#75715e">// 0xf940000d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    _stub._entryPoint[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x100000e9</span>;
</span></span><span style="display:flex;"><span>    _stub._entryPoint[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xa940312a</span>;
</span></span><span style="display:flex;"><span>    _stub._entryPoint[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xeb0a01bf</span>;
</span></span><span style="display:flex;"><span>    _stub._entryPoint[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x54000041</span>;
</span></span><span style="display:flex;"><span>    _stub._entryPoint[<span style="color:#ae81ff">5</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xd61f0180</span>;
</span></span><span style="display:flex;"><span>    _stub._entryPoint[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x580000c9</span>;
</span></span><span style="display:flex;"><span>    _stub._entryPoint[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xd61f0120</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    _stub._expectedMT <span style="color:#f92672">=</span> expectedMT;
</span></span><span style="display:flex;"><span>    _stub._implTarget <span style="color:#f92672">=</span> implTarget;
</span></span><span style="display:flex;"><span>    _stub._failTarget <span style="color:#f92672">=</span> failTarget;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The instructions in the comment matched exactly what LLDB was showing me:</p>
<pre tabindex="0"><code>-&gt;  0xffff7d866300: ldr    x13, [x0]
    0xffff7d866304: adr    x9, #0x1c
    0xffff7d866308: ldp    x10, x12, [x9]
    0xffff7d86630c: cmp    x13, x10
</code></pre><p>But this was different from what I was getting in my repro app:</p>
<pre tabindex="0"><code>-&gt;  0xffff7e42af88: ldr    x1, [x1]
    0xffff7e42af8c: ldr    x1, [x1, #0x40]
    0xffff7e42af90: ldr    x1, [x1, #0x18]
    0xffff7e42af94: blr    x1
</code></pre><p>So it seemed like the crashing app was using a &ldquo;dispatch stub&rdquo;, but my repro app did not. Did it matter?</p>
<p>Looking back <a href="https://github.com/dotnet/runtime/blob/v5.0.3/src/coreclr/src/vm/arm64/stubs.cpp#L1126">at the method in which the crash happened</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>BOOL
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AdjustContextForVirtualStub</span>(
</span></span><span style="display:flex;"><span>        EXCEPTION_RECORD <span style="color:#f92672">*</span>pExceptionRecord,
</span></span><span style="display:flex;"><span>        CONTEXT <span style="color:#f92672">*</span>pContext)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    LIMITED_METHOD_CONTRACT;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Thread <span style="color:#f92672">*</span> pThread <span style="color:#f92672">=</span> GetThread();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// We may not have a managed thread object. Example is an AV on the helper thread.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// (perhaps during StubManager::IsStub)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (pThread <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> FALSE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PCODE f_IP <span style="color:#f92672">=</span> GetIP(pContext);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    VirtualCallStubManager<span style="color:#f92672">::</span>StubKind sk;
</span></span><span style="display:flex;"><span>    VirtualCallStubManager<span style="color:#f92672">::</span>FindStubManager(f_IP, <span style="color:#f92672">&amp;</span>sk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (sk <span style="color:#f92672">==</span> VirtualCallStubManager<span style="color:#f92672">::</span>SK_DISPATCH)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>PTR_DWORD(f_IP) <span style="color:#f92672">!=</span> DISPATCH_STUB_FIRST_DWORD)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            _ASSERTE(<span style="color:#f92672">!</span><span style="color:#e6db74">&#34;AV in DispatchStub at unknown instruction&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> FALSE;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (sk <span style="color:#f92672">==</span> VirtualCallStubManager<span style="color:#f92672">::</span>SK_RESOLVE)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>PTR_DWORD(f_IP) <span style="color:#f92672">!=</span> RESOLVE_STUB_FIRST_DWORD)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            _ASSERTE(<span style="color:#f92672">!</span><span style="color:#e6db74">&#34;AV in ResolveStub at unknown instruction&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> FALSE;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> FALSE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PCODE callsite <span style="color:#f92672">=</span> GetAdjustedCallAddress(GetLR(pContext));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Lr must already have been saved before calling so it should not be necessary to restore Lr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    pExceptionRecord<span style="color:#f92672">-&gt;</span>ExceptionAddress <span style="color:#f92672">=</span> (PVOID)callsite;
</span></span><span style="display:flex;"><span>    SetIP(pContext, callsite);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> TRUE;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The crashed occurred because <code>pExceptionRecord</code> was null, line 48. If my repro app didn&rsquo;t crash, it either meant that the method wasn&rsquo;t called, <code>pExceptionRecord</code> wasn&rsquo;t null, or the method exited earlier. I confirmed by setting a breakpoint that the method was called with a null argument. So it would mean that either <code>pThread</code> was null (which seemed incredibly unlikely), or the return value of <code>VirtualCallStubManager::FindStubManager</code> was different from <code>SK_DISPATCH</code> or <code>SK_LOOKUP</code>. &ldquo;<code>SK_DISPATCH</code>&rdquo; ? Whatever that was, it seemed consistent with the dispatch stub mentioned earlier.</p>
<h1 id="learning-about-stubs">Learning about stubs</h1>
<p>While looking for more information about what those stubs were, I ended up in the <a href="https://github.com/dotnet/coreclr/blob/master/Documentation/botr/virtual-stub-dispatch.md#dispatch-stubs">Book of The Runtime</a>. There&rsquo;s a lot to digest in there, but the bottom-line is that whenever a method is called on an interface (and only an interface), a special resolution mechanism is used, named &ldquo;virtual stub dispatch&rdquo;. That resolution mechanism uses 3 types of stubs: lookup stubs, resolve stubs, or the dispatch stub we were looking for.</p>
<ul>
<li>
<p>The lookup stub just calls the resolver with the right parameters to resolve the address of the target method.</p>
</li>
<li>
<p>The dispatch stub is an optimistic dispatch mechanism: it&rsquo;s hardcoded with the expected implementation type of the interface and the corresponding address of the method. When invoked, it performs a quick type check and jumps to the address. If the type check fails, it instead fallbacks to the resolve stub.</p>
</li>
<li>
<p>The resolve stub is pretty much a cache. If checks if the address of the target method is already in the cache. If yes, it jumps to it. If not, it calls the resolver and adds the new entry to the cache.</p>
</li>
</ul>
<p>With that information in hand, I modified my repro to use interfaces:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IClient</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">object</span> GetResponse();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Request();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Console.WriteLine(<span style="color:#e6db74">&#34;Caught: &#34;</span> + ex);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Request()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> client = GetClient();
</span></span><span style="display:flex;"><span>            _ = client.GetResponse(); <span style="color:#75715e">// Virtual call on null reference</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Exception(<span style="color:#e6db74">&#34;Rethrowing&#34;</span>, ex);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [MethodImpl(MethodImplOptions.NoInlining)]</span> <span style="color:#75715e">// Prevent any kind of unexpected compiler optimization</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> IClient GetClient()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>But it still wouldn&rsquo;t crash. Worse, it wouldn&rsquo;t even cause a segmentation fault anymore!</p>
<p>After reading a bit more about virtual dispatch stubs, it turns out that the type of stub used for a given call site changes through the life of a process. When compiling a method, the JIT emits a lookup stub at the call site. When invoked, that stub will emit both a dispatch stub and a resolve stub, and will backpatch the call site to use the new stubs. The reason the JIT does not directly emit a dispatch/resolve stub is apparently because it&rsquo;s missing some contextual information, that is only available at invocation time.</p>
<p>In my repro app, since I was calling the method only once, a lookup stub was used. I needed to call the method multiple times to make sure the dispatch stub was emitted, and then cause the <code>NullReferenceException</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IClient</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">object</span> GetResponse();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Client</span> : IClient
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">object</span> GetResponse() =&gt; <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Request(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>            Request(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>            Request(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Console.WriteLine(<span style="color:#e6db74">&#34;Caught: &#34;</span> + ex);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Request(<span style="color:#66d9ef">bool</span> isNull)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> client = GetClient(isNull);
</span></span><span style="display:flex;"><span>            _ = client.GetResponse(); <span style="color:#75715e">// Virtual call on null reference</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Exception(<span style="color:#e6db74">&#34;Rethrowing&#34;</span>, ex);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [MethodImpl(MethodImplOptions.NoInlining)]</span> <span style="color:#75715e">// Prevent any kind of unexpected compiler optimization</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> IClient GetClient(<span style="color:#66d9ef">bool</span> isNull)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> isNull ? <span style="color:#66d9ef">null</span> : <span style="color:#66d9ef">new</span> Client();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And this time it had the expected result:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./bin/Release/net5.0/testconsole
</span></span><span style="display:flex;"><span>Segmentation fault
</span></span></code></pre></div><p>There was still one thing puzzling me: I needed to call <code>Request(false)</code> two times for the dispatch stub to be emitted. I was expecting the JIT to emit a lookup stub during compilation, then the lookup stub to emit a dispatch stub during the first invocation. So only one <code>Request(false)</code> would have been needed. Why did I need two?</p>
<p>I found the answer <a href="https://github.com/dotnet/runtime/blob/v5.0.3/src/coreclr/src/vm/virtualcallstub.cpp#L1539">in a comment in the source code of the resolver</a> (the resolver is the bit of code called by the lookup stub):</p>
<blockquote>
<p>Note, if we encounter a method that hasn&rsquo;t been jitted yet, we will return the prestub, which should cause it to be jitted and we will be able to build the dispatching stub on a later call thru the call site</p>
</blockquote>
<p>Therefore, the sequence of events was:</p>
<ul>
<li>
<p><code>Request</code> is compiled by the JIT. At this point, contextual information is missing and a lookup stub is emitted.</p>
</li>
<li>
<p>First call to <code>Request(false)</code> : when calling <code>IClient.GetResponse</code>, the lookup stub is invoked. It resolves the call to <code>Client.GetResponse</code> but notices that this method hasn&rsquo;t been JITted. Since it doesn&rsquo;t know the final location of the code, if just returns the address of the prestub. When the prestub is executed, it triggers the JIT compilation of the method.</p>
</li>
<li>
<p>Second call to <code>Request(false)</code> : when calling <code>IClient.GetResponse</code>, the lookup stub is invoked. It resolves the call to <code>Client.GetResponse</code> and emits a dispatch stub that points to the address of the JITted code.</p>
</li>
<li>
<p>Call to <code>Request(true)</code> : the dispatch stub is used for resolution, but the instance is null. This causes a segmentation fault inside of the stub, which in turn will cause the crash when the stack is unwind.</p>
</li>
</ul>
<p>If my analysis was correct, I would need only one call to <code>Request(false)</code> if I made sure <code>Client.GetResponse</code> was already JIT-compiled at the moment of the invocation. I confirmed that by making this change to the repro:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            _ = <span style="color:#66d9ef">new</span> Client().GetResponse(); <span style="color:#75715e">// Force the JIT compilation</span>
</span></span><span style="display:flex;"><span>            Request(<span style="color:#66d9ef">false</span>); <span style="color:#75715e">// Only one Request(false) should be needed now</span>
</span></span><span style="display:flex;"><span>            Request(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Console.WriteLine(<span style="color:#e6db74">&#34;Caught: &#34;</span> + ex);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>And indeed, it crashed with a segmentation fault.</p>
<h1 id="back-to-my-nullreferenceexception">Back to my NullReferenceException</h1>
<p>Meanwhile, even though it wasn&rsquo;t causing a crash anymore with the patched CLR, my integration test was still throwing a <code>NullReferenceException</code> somewhere.</p>
<p>In normal conditions, debugging a null reference is hardly something noteworthy. But for various reasons, such as the remote ARM64 VM or the fact that the issue happened only with our profiler attached, I couldn&rsquo;t attach the Visual Studio debugger and it was very difficult for me to make any change in the code. All I knew was that the error occurred in this method from the Elasticsearch.net client:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> TResponse Request&lt;TResponse&gt;(HttpMethod method, <span style="color:#66d9ef">string</span> path, PostData data = <span style="color:#66d9ef">null</span>, IRequestParameters requestParameters = <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">where</span> TResponse : class, IElasticsearchResponse, <span style="color:#66d9ef">new</span>()
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> pipeline = PipelineProvider.Create(Settings, DateTimeProvider, MemoryStreamFactory, requestParameters))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      pipeline.FirstPoolUsage(Settings.BootstrapLock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> requestData = <span style="color:#66d9ef">new</span> RequestData(method, path, data, Settings, requestParameters, MemoryStreamFactory);
</span></span><span style="display:flex;"><span>      Settings.OnRequestDataCreated?.Invoke(requestData);
</span></span><span style="display:flex;"><span>      TResponse response = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> seenExceptions = <span style="color:#66d9ef">new</span> List&lt;PipelineException&gt;();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> node <span style="color:#66d9ef">in</span> pipeline.NextNode())
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        requestData.Node = node;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          pipeline.SniffOnStaleCluster();
</span></span><span style="display:flex;"><span>          Ping(pipeline, node);
</span></span><span style="display:flex;"><span>          response = pipeline.CallElasticsearch&lt;TResponse&gt;(requestData);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (!response.ApiCall.SuccessOrKnownError)
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            pipeline.MarkDead(node);
</span></span><span style="display:flex;"><span>            pipeline.SniffOnConnectionFailure();
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> (PipelineException pipelineException) when (!pipelineException.Recoverable)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          HandlePipelineException(<span style="color:#66d9ef">ref</span> response, pipelineException, pipeline, node, seenExceptions);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> (PipelineException pipelineException)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          HandlePipelineException(<span style="color:#66d9ef">ref</span> response, pipelineException, pipeline, node, seenExceptions);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> (Exception killerException)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> UnexpectedElasticsearchClientException(killerException, seenExceptions)
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            Request = requestData,
</span></span><span style="display:flex;"><span>            Response = response?.ApiCall,
</span></span><span style="display:flex;"><span>            AuditTrail = pipeline?.AuditTrail
</span></span><span style="display:flex;"><span>          };
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (response == <span style="color:#66d9ef">null</span> || !response.ApiCall.SuccessOrKnownError) <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        pipeline.MarkAlive(node);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> FinalizeResponse(requestData, pipeline, seenExceptions, response);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>There was a lot of things in there that could be null. And the fact that it came from an external library made things even harder. I needed to figure a way to debug that issue from LLDB without any code change.</p>
<p>So I ran the application again with LLDB, until the location of the first segmentation fault. This time, thanks to everything I learned above, I knew the segmentation fault was occurring in the dispatch stub, with the now familiar <code>ldr x13, [x0]</code> instruction:</p>
<pre tabindex="0"><code>Process 64731 stopped
* thread #16, name = &#39;.NET ThreadPool&#39;, stop reason = signal SIGSEGV: invalid address (fault address: 0x0)
    frame #0: 0x0000ffff7d866300
-&gt;  0xffff7d866300: ldr    x13, [x0]
    0xffff7d866304: adr    x9, #0x1c
    0xffff7d866308: ldp    x10, x12, [x9]
    0xffff7d86630c: cmp    x13, x10
</code></pre><p>The <a href="https://github.com/dotnet/runtime/blob/v5.0.3/src/coreclr/src/vm/arm64/virtualcallstubcpu.hpp#L111-L113">comment in the stub implementation</a> indicates:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>        <span style="color:#75715e">// ldr x13, [x0] ; methodTable from object in x0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// adr x9, _expectedMT ; _expectedMT is at offset 28 from pc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// ldp x10, x12, [x9] ; x10 = _expectedMT &amp; x12 = _implTarget
</span></span></span></code></pre></div><p>So by decompiling the stub, I should be able to retrieve the hardcoded <code>_expectedMT</code> and <code>_implTarget</code>:</p>
<pre tabindex="0"><code>(lldb) disassemble -s 0x0000ffff7d866300 -c 30
-&gt;  0xffff7d866300: ldr    x13, [x0]
    0xffff7d866304: adr    x9, #0x1c
    0xffff7d866308: ldp    x10, x12, [x9]
    0xffff7d86630c: cmp    x13, x10
    0xffff7d866310: b.ne   0xffff7d866318
    0xffff7d866314: br     x12
    0xffff7d866318: ldr    x9, #0x18
    0xffff7d86631c: br     x9
    0xffff7d866320: .long  0x7fdd0f50                ; unknown opcode
    0xffff7d866324: udf    #0xffff
    0xffff7d866328: .long  0x80be2a98                ; unknown opcode
    0xffff7d86632c: udf    #0xffff
    0xffff7d866330: .long  0x7d8be114                ; unknown opcode
    0xffff7d866334: udf    #0xffff
</code></pre><p>We can see the <code>ldp x10, x12, [x9]</code> instruction. According to the comments, it loads the <code>_expectedMT</code> and <code>_implTarget</code> values we&rsquo;re looking for. <code>ldp</code> is an ARM instruction that loads two words from the target address (stored in <code>x9</code>) and stores them in the designated registers (<code>x10</code> and <code>x12</code> ). The value of <code>x9</code> was set by the instruction <code>adr x9, #0x1c</code>. That means &ldquo;get the address of the current instruction, add the offset <code>0x1c</code> , and stores it in <code>x9</code>&rdquo;. The address of that instruction is <code>0xffff7d866304</code>, so it stores the value <code>0xffff7d866304 + 0x1c = 0xffff7d866320</code> in the register. At <code>0xffff7d866320</code>, we can see a sequence of values:</p>
<pre tabindex="0"><code>0x7fdd0f50
0xffff
0x80be2a98
0xffff
</code></pre><p>Stitched together, it means that the instruction <code>ldp x10, x12, [x9]</code> stores <code>0xffff7dd0f50</code> into <code>x10</code> and <code>0xffff80be2a98</code> into <code>x12</code>. At that point I had all the information I needed! I could then inspect the expected MT, and from there see what method was stored at address <code>0xffff80be2a98</code>:</p>
<pre tabindex="0"><code>(lldb) dumpmt -md 0xffff7fdd0f50
EEClass:         0000FFFF7FDC95D0
Module:          0000FFFF7E5838E8
Name:            Nest.CreateIndexResponse
mdToken:         0000000002000A4D
File:            /home/ubuntu/git/dd-trace-dotnet/test/test-applications/integrations/Samples.Elasticsearch/bin/Debug/net5.0/publish/Nest.dll
BaseSize:        0x38
ComponentSize:   0x0
DynamicStatics:  false
ContainsPointers true
Slots in VTable: 17
Number of IFaces in IFaceMap: 4
--------------------------------------
MethodDesc Table
           Entry       MethodDesc    JIT Name
0000FFFF7E4100C0 0000FFFF7E400B90    JIT System.Object.Finalize()
0000FFFF80CBF3F0 0000FFFF7E795928    JIT Nest.ResponseBase.ToString()
[...]
0000FFFF80BE2A98 0000FFFF7E795808    JIT Nest.ResponseBase.Elasticsearch.Net.IElasticsearchResponse.get_ApiCall()
[...]
</code></pre><p>From there, I knew the <code>NullReferenceException</code> occurred when trying to call the getter of the <code>ApiCall</code> property on an instance of <code>Nest.CreateIndexResponse</code>. With that information, finding the exact line of failure in the source code of the method was trivial:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>response = pipeline.CallElasticsearch&lt;TResponse&gt;(requestData);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (!response.ApiCall.SuccessOrKnownError)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  pipeline.MarkDead(node);
</span></span><span style="display:flex;"><span>  pipeline.SniffOnConnectionFailure();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Thanks to that, I was able to understand what caused that value to be null and fix the issue. And finally close the pull request.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="/images/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a-2.webp" data-fancybox="">
  
    <img class="fig-img" src="/images/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a-2.webp" >
  
    </a>
  
  
</div>


              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/dotnet/">dotnet</a>

  <a class="tag tag--primary tag--small" href="/tags/debugging/">debugging</a>

  <a class="tag tag--primary tag--small" href="/tags/lldb/">lldb</a>

  <a class="tag tag--primary tag--small" href="/tags/windbg/">windbg</a>

  <a class="tag tag--primary tag--small" href="/tags/arm64/">arm64</a>

  <a class="tag tag--primary tag--small" href="/tags/assembly/">assembly</a>

  <a class="tag tag--primary tag--small" href="/tags/cpp/">cpp</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/showing-unresolved-functions-in-perfview-ab6cd899cb94/" data-tooltip="Showing unresolved functions in PerfView" aria-label="NEXT: Showing unresolved functions in PerfView">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd/" data-tooltip="Debugging a native deadlock in a .NET Linux application" aria-label="PREVIOUS: Debugging a native deadlock in a .NET Linux application">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            

<link href="https://fonts.googleapis.com/css?family=Cookie&amp;display=swap" rel="stylesheet">
<div class="bmc-btn-container"><a class="bmc-btn" target="_blank" href="https://buymeacoffee.com/kevingosse">☕<span class="bmc-btn-text">Enjoyed the article? Buy me a coffee</span></a></div>

<style>
    .bmc-btn {
        min-width: 210px;
        color: #000000;
        background-color: #FFFFFF !important;
        height: 60px;
        border-radius: 12px;
        font-size: 28px;
        font-weight: Normal;
        border: none;
        line-height: 27px;
        text-decoration: none !important;
        display: inline-flex !important;
        justify-content: center;
        align-items: center;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
    }

    .bmc-btn:hover, .bmc-btn:active, .bmc-btn:focus {
        text-decoration: none !important;
        cursor: pointer;
    }

    .bmc-btn-text {
        margin-left: 8px;
        display: inline-block;
        line-height: 0;
        width: 100%;
        flex-shrink: 0;
        font-family: [FONT] !important;
    }

    .logo-outline {
        fill: #000000;
    }

    .logo-coffee {
        fill: #ffffff;
    }</style>

  
<div id="utterances">
      <noscript>Please enable JavaScript to view the comments powered by Utterances.</noscript>
    </div>
<script src="https://utteranc.es/client.js"
        repo="kevingosse/kevingosse.github.io"
        issue-term="title"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2024 Kevin Gosse. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/showing-unresolved-functions-in-perfview-ab6cd899cb94/" data-tooltip="Showing unresolved functions in PerfView" aria-label="NEXT: Showing unresolved functions in PerfView">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/investigating-a-native-deadlock-in-a-net-linux-application-97979a005ebd/" data-tooltip="Debugging a native deadlock in a .NET Linux application" aria-label="PREVIOUS: Debugging a native deadlock in a .NET Linux application">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://minidump.net/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https://minidump.net/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.reddit.com/submit?url=https://minidump.net/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a/" title="Share on Reddit" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://news.ycombinator.com/submitlink?u=https://minidump.net/an-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a/" title="Share on Hacker News" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="2">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fminidump.net%2Fan-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a%2F" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/feed/?shareActive=true&amp;text=https%3A%2F%2Fminidump.net%2Fan-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a%2F" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i><span>Share on Linkedin</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.reddit.com/submit?url=https%3A%2F%2Fminidump.net%2Fan-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a%2F" aria-label="Share on Reddit">
          <i class="fab fa-reddit" aria-hidden="true"></i><span>Share on Reddit</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fminidump.net%2Fan-unconventional-way-of-investigating-a-nullreferenceexception-5628cca01d6a%2F" aria-label="Share on Hacker News">
          <i class="fab fa-hacker-news" aria-hidden="true"></i><span>Share on Hacker News</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>


    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://minidump.net/images/profile.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Kevin Gosse</h4>
    
      <div id="about-card-bio">Kevin Gosse has been using Microsoft .NET technologies for more than 15 years, across client, server, and mobile applications. Passionate about debugging. He is Microsoft MVP and is currently employed at Datadog, where he works on the performance of the .NET APM.</div>
    
    
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://minidump.net/images/code.png');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://minidump.net/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

